<template>
  <div class="d-flex flex-grow-1 pa-4">
    <u-grid
      id="policies"
      row-node-id="id"
      :column-defs="columnDefs"
      :row-data="policies"
      :framework-components="frameworkComponents"
      :row-actions="showActionColumn ? rowActions : []"
      :row-actions-floating="false"
      :fetching="fetching"
      @row-clicked="policyClicked"
      @refresh="$emit('refresh')"
    />
  </div>
</template>
<script>
  import { ConditionsRenderer, ConditionGroupsRenderer, NameRenderer } from '../renderers'
  import { ConditionTarget } from '../config/constants'
  import columnDefs from '../columns/columnDefs'
  import mixin from './mixin'

  export default {
    mixins: [mixin],
    props: {
      showActionColumn: { type: Boolean, default: false },
    },
    data() {
      return {
        frameworkComponents: {
          ConditionsRenderer,
          ConditionGroupsRenderer,
          NameRenderer,
        },
      }
    },
    computed: {
      // appliancePolicies grid column defs
      columnDefs: () => columnDefs.getBoxPoliciesColumnDefs(),

      // returns hydrated data as expected by the grid column defs
      // `policyManager` and `conditionsValue` are defined in the mixin
      policies: ({ policyManager, conditionsValue, conditionGroupsValue }) => {
        return policyManager.policies.map(policy => ({
          id: policy.id,
          name: policy.name,
          description: policy.description,
          source: conditionsValue(policy.conditions, ConditionTarget.Source),
          dest: conditionsValue(policy.conditions, ConditionTarget.Destination),
          other: conditionsValue(policy.conditions, ConditionTarget.Other),
          group: conditionGroupsValue(policy.conditions),
        }))
      },
      rowActions() {
        return [
          // Assignment action that takes the user to the Assignment page
          {
            icon: 'mdi-file-plus',
            tooltip: this.$t('assignment'),
            handler: () => this.$emit('assignment-clicked'),
          },
        ]
      },
    },
    methods: {
      policyClicked({ node }) {
        this.$emit('row-clicked', node.data.id)
      },
    },
  }
</script>
