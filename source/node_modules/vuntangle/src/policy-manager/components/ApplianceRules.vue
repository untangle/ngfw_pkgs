<template>
  <div class="d-flex flex-grow-1 pa-4">
    <u-grid
      id="rules"
      row-node-id="id"
      :column-defs="columnDefs"
      :row-data="rules"
      :framework-components="frameworkComponents"
      :fetching="fetching"
      @row-clicked="ruleClicked"
      @refresh="$emit('refresh')"
    />
  </div>
</template>
<script>
  import {
    ConditionsRenderer,
    ConditionGroupsRenderer,
    ActionRenderer,
    AssociatedPolicyRenderer,
    NameRenderer,
  } from '../renderers'
  import columnDefs from '../columns/columnDefs'
  import { ruleType } from '../util'
  import { ConditionTarget, Type } from '../config/constants'
  import mixin from './mixin'

  export default {
    mixins: [mixin],
    props: {
      showActionColumn: { type: Boolean, default: false },
    },
    data() {
      return {
        frameworkComponents: {
          ConditionsRenderer,
          ConditionGroupsRenderer,
          ActionRenderer,
          AssociatedPolicyRenderer,
          NameRenderer,
        },
      }
    },
    computed: {
      // applianceRules grid column defs
      columnDefs: () => columnDefs.getBoxRulesColumnDefs(),

      // returns hydrated data as expected by the grid column defs
      // params are defined in the mixin
      rules: ({ policyManager, conditionsValue, conditionGroupsValue, ruleActionValue, associatedPolicyValue }) => {
        return policyManager.rules
          .filter(rule => rule.Type !== Type.RuleWanPolicy) // CD-6048 avoid listing WAN Rules
          .map(rule => ({
            id: rule.id,
            name: rule.name,
            enabled: rule.enabled,
            description: rule.description,
            type: ruleType(rule.type),
            source: conditionsValue(rule.conditions, ConditionTarget.Source),
            dest: conditionsValue(rule.conditions, ConditionTarget.Destination),
            other: conditionsValue(rule.conditions, ConditionTarget.Other),
            group: conditionGroupsValue(rule.conditions),
            action: ruleActionValue(rule.action),
            policies: associatedPolicyValue(rule.id),
          }))
      },
    },
    methods: {
      ruleClicked({ node }) {
        this.$emit('row-clicked', node.data.id)
      },
    },
  }
</script>
