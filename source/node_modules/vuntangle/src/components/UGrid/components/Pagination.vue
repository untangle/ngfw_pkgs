<template>
  <v-card v-if="totalCount" flat :disabled="fetching">
    <v-divider />
    <div class="d-flex justify-end align-center py-1">
      <v-spacer class="flex-grow-1" />
      <span class="mr-2">Page size:</span>
      <v-combobox
        v-model.number="pagination.pageSize"
        :items="[50, 100, 500, 1000]"
        style="max-width: 120px"
        outlined
        hide-details
        dense
        @input="setPageSize()"
      />
      <span class="mx-12">{{ counters }}</span>
      <v-btn icon :disabled="prevDisabled" @click="goFirst()"><v-icon>mdi-page-first</v-icon></v-btn>
      <v-btn icon :disabled="prevDisabled" @click="goPrev()"><v-icon>mdi-chevron-left</v-icon></v-btn>
      <span class="px-2 text-caption">Page {{ pagination.pageNumber }} of {{ pageNumbers }}</span>
      <v-btn icon :disabled="nextDisabled" @click="goNext()"><v-icon>mdi-chevron-right</v-icon></v-btn>
      <v-btn icon :disabled="nextDisabled" @click="goLast()"><v-icon>mdi-page-last</v-icon></v-btn>
    </div>
  </v-card>
</template>

<script>
  export default {
    inject: {
      $totalCount: {
        default: undefined,
      },
      $pagination: {
        default: {
          pageNumber: 1,
          pageSize: 100,
        },
      },
    },

    props: {
      fetching: { type: Boolean, default: false },
    },

    computed: {
      totalCount: ({ $totalCount }) => ($totalCount ? $totalCount() : undefined),
      pagination: ({ $pagination }) => $pagination(),

      pageNumbers: ({ totalCount, pagination }) => Math.ceil(totalCount / pagination.pageSize),
      prevDisabled: ({ pagination }) => pagination.pageNumber === 1,
      nextDisabled: ({ pagination, pageNumbers }) => pagination.pageNumber === pageNumbers,
      counters: ({ pagination, totalCount, pageNumbers }) =>
        `${(pagination.pageNumber - 1) * pagination.pageSize + 1} to ${
          pagination.pageNumber < pageNumbers
            ? (pagination.pageNumber - 1) * pagination.pageSize + pagination.pageSize
            : totalCount
        } of ${totalCount}`,
    },

    methods: {
      goFirst() {
        this.pagination.pageNumber = 1
        this.refetch()
      },
      goPrev() {
        this.pagination.pageNumber -= 1
        this.refetch()
      },
      goNext() {
        this.pagination.pageNumber += 1
        this.refetch()
      },
      goLast() {
        this.pagination.pageNumber = this.pageNumbers
        this.refetch()
      },

      setPageSize() {
        if (Number.isNaN(this.pagination.pageSize) || !Number.isInteger(this.pagination.pageSize)) return
        if (this.pagination.pageSize < 10) {
          this.pagination.pageSize = 10
        } else if (this.pagination.pageSize > 3000) {
          this.pagination.pageSize = 3000
        }
        this.pagination.pageNumber = 1
        this.refetch()
      },

      refetch() {
        this.$emit('fetch-data')
      },
    },
  }
</script>
