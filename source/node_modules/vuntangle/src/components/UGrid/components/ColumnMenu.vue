<template>
  <div ref="mainMenu" style="overflow-y: auto; max-height: 300px" class="d-flex flex-column align-stretch">
    <v-list dense class="py-0" color="transparent">
      <!-- pin/unpin menu -->
      <v-menu
        ref="pinMenu"
        v-model="pinSubMenu"
        :left="subMenuLeftPosition"
        max-width="150"
        allow-overflow
        offset-x
        open-on-hover
        rounded
        content-class="ag-custom-component-popup ag-menu elevation-4"
      >
        <template #activator="{ on, attrs }">
          <v-list-item v-if="!params.column.colDef.lockPinned" v-bind="attrs" v-on="on">
            <v-list-item-icon class="mr-2"><v-icon small v-text="`mdi-pin`" /></v-list-item-icon>
            <v-list-item-title v-text="$vuntangle.$t('pin')" />
            <v-list-item-icon><v-icon small v-text="`mdi-chevron-right`" /></v-list-item-icon>
          </v-list-item>
        </template>

        <v-list dense outlined class="pa-0">
          <v-list-item @click.stop="params.pinColumn(params.column.colId, 'left')">
            <v-list-item-icon class="mr-2"><v-icon small v-text="`mdi-arrow-collapse-left`" /></v-list-item-icon>
            <v-list-item-title v-text="$vuntangle.$t('pin_left')" />
          </v-list-item>
          <v-list-item @click.stop="params.pinColumn(params.column.colId, 'right')">
            <v-list-item-icon class="mr-2"><v-icon small v-text="`mdi-arrow-collapse-right`" /></v-list-item-icon>
            <v-list-item-title v-text="$vuntangle.$t('pin_right')" />
          </v-list-item>
          <v-list-item @click.stop="params.pinColumn(params.column.colId, null)">
            <v-list-item-icon class="mr-2"><v-icon small v-text="`mdi-pin-off`" /></v-list-item-icon>
            <v-list-item-title v-text="$vuntangle.$t('unpin')" />
          </v-list-item>
        </v-list>
      </v-menu>

      <v-divider v-if="!params.column.colDef.lockPinned" />

      <!-- columns list menu -->
      <v-menu
        ref="columnsMenu"
        v-model="columnsSubMenu"
        :left="subMenuLeftPosition"
        :top="subMenuTopPosition"
        max-height="300"
        max-width="280"
        allow-overflow
        offset-x
        open-on-hover
        transition="none"
        content-class="ag-custom-component-popup ag-menu elevation-4"
      >
        <template #activator="{ on, attrs }">
          <v-list-item v-bind="attrs" v-on="on">
            <v-list-item-icon class="mr-2"><v-icon small v-text="`mdi-format-columns`" /></v-list-item-icon>
            <v-list-item-title v-text="$vuntangle.$t('columns')" />
            <v-list-item-icon><v-icon small v-text="`mdi-chevron-right`" /></v-list-item-icon>
          </v-list-item>
        </template>
        <!-- <v-sheet class="pa-2" color="transparent"> -->
        <v-list dense outlined class="pa-0">
          <v-list-item class="pa-2">
            <v-list-item-content
              class="d-flex flex-column flex-nowrap align-stretch"
              style="max-height: 240px; overflow-y: auto"
            >
              <u-checkbox
                v-for="col in list"
                :key="col.id"
                v-model="col.visible"
                dense
                class="ma-0 caption pa-0"
                color="primary"
                hide-details
                :ripple="false"
                :disabled="col.disabled"
                @change="onColumnVisibilityChange($event, col.id)"
                @click.stop
              >
                <template #label>
                  <span class="body-2">{{ col.name }}</span>
                </template>
              </u-checkbox>
            </v-list-item-content>
          </v-list-item>
          <v-divider />
          <v-list-item @click="resetColumns">
            <v-list-item-icon class="mr-2"><v-icon small v-text="`mdi-refresh`" /></v-list-item-icon>
            <v-list-item-title v-text="$vuntangle.$t('reset_to_defaults')" />
          </v-list-item>
        </v-list>
        <!-- </v-sheet> -->
      </v-menu>

      <!-- toolbar menu -->
      <v-menu
        ref="toolbarMenu"
        v-model="toolbarSubMenu"
        :left="subMenuLeftPosition"
        :top="subMenuTopPosition"
        max-height="300"
        max-width="200"
        allow-overflow
        offset-x
        open-on-hover
        transition="none"
        content-class="ag-custom-component-popup ag-menu elevation-4"
      >
        <template #activator="{ on, attrs }">
          <v-list-item v-bind="attrs" v-on="on">
            <v-list-item-icon class="mr-2"><v-icon small v-text="`mdi-dock-top`" /></v-list-item-icon>
            <v-list-item-title v-text="$vuntangle.$t('toolbar')" />
            <v-list-item-icon><v-icon small v-text="`mdi-chevron-right`" /></v-list-item-icon>
          </v-list-item>
        </template>
        <v-list dense outlined class="pa-0">
          <v-list-item @click="setToolbar('top')">
            <v-list-item-icon class="mr-2"><v-icon small v-text="`mdi-dock-top`" /></v-list-item-icon>
            <v-list-item-title v-text="$vuntangle.$t('top')" />
          </v-list-item>
          <v-list-item @click="setToolbar('bottom')">
            <v-list-item-icon class="mr-2"><v-icon small v-text="`mdi-dock-bottom`" /></v-list-item-icon>
            <v-list-item-title v-text="$vuntangle.$t('bottom')" />
          </v-list-item>
          <v-list-item @click="setToolbar('float')">
            <v-list-item-icon class="mr-2"><v-icon small v-text="`mdi-dock-bottom`" /></v-list-item-icon>
            <v-list-item-title v-text="$vuntangle.$t('floating_bottom')" />
          </v-list-item>
          <v-list-item @click="setToolbar(false)">
            <v-list-item-icon class="mr-2"><v-icon small v-text="`mdi-close`" /></v-list-item-icon>
            <v-list-item-title v-text="$vuntangle.$t('hidden')" />
          </v-list-item>
        </v-list>
      </v-menu>

      <v-divider v-if="params.enableRefresh || params.enableExportCsv" />

      <v-list-item v-if="params.enableRefresh" @click="params.refresh()">
        <v-list-item-icon class="mr-2"><v-icon small v-text="`mdi-refresh`" /></v-list-item-icon>
        <v-list-item-title v-text="$vuntangle.$t('refresh')" />
      </v-list-item>

      <v-list-item v-if="params.enableExportCsv" @click="params.exportCsv()">
        <v-list-item-icon class="mr-2"><v-icon small v-text="`mdi-file-export`" /></v-list-item-icon>
        <v-list-item-title v-text="$vuntangle.$t('export_csv')" />
      </v-list-item>
    </v-list>
  </div>
</template>
<script>
  // import vuetify components
  import { VList, VMenu, VListItem, VListItemIcon, VIcon, VListItemTitle, VDivider } from 'vuetify/lib'
  import UCheckbox from '../../UCheckbox'

  export default {
    components: { VList, VMenu, VListItem, VListItemIcon, VIcon, VListItemTitle, VDivider, UCheckbox },
    props: {
      params: { type: Object, default() {} },
    },
    data: () => ({
      // the columns list that will be populated
      list: [],

      // flag telling if a specific of subMenu is shown/visible
      pinSubMenu: false,
      columnsSubMenu: false,
      toolbarSubMenu: false,

      // flag to position subMenus to the left/top of main menu, if it's the case
      subMenuLeftPosition: false,
      subMenuTopPosition: false,
    }),
    watch: {
      pinSubMenu(show) {
        this.positionSubMenus('pinMenu', show)
      },
      columnsSubMenu(show) {
        this.positionSubMenus('columnsMenu', show)
      },
      toolbarSubMenu(show) {
        this.positionSubMenus('toolbarMenu', show)
      },
    },
    mounted() {
      this.constructList()
      this.params.api.addEventListener('columnMoved', () => {
        this.constructList()
      })
    },
    methods: {
      constructList() {
        const allColumns = this.params.api.columnController.getAllGridColumns()
        const list = []
        allColumns.forEach(col => {
          if (col.colId === 'sel-column' || !col.colDef.headerName) return
          list.push({
            id: col.colId,
            name: col.colDef.headerName,
            visible: col.visible,
            disabled: col.colDef.lockVisible,
          })
        })
        this.list = list
      },

      onColumnVisibilityChange(visible, colId) {
        this.params.api.columnController.setColumnVisible(colId, visible)
      },

      setToolbar(position) {
        this.params.setToolbar(position)
        this.params.api.hidePopupMenu()
      },

      // resets the columns state to the original columnDefs
      resetColumns() {
        this.params.resetColumns()
        this.params.api.hidePopupMenu()
      },

      /**
       * Computes sub menus positions if they fall outside of the window
       * to prevent unwanted accessibility and scrolling issues
       */
      positionSubMenus(subMenuRef, show) {
        if (!show) {
          return
        }
        const mainMenu = this.$refs.mainMenu
        const left = mainMenu.getBoundingClientRect().left
        const width = mainMenu.offsetWidth
        const top = mainMenu.getBoundingClientRect().top
        const height = mainMenu.offsetHeight

        // offset for the left pos (the sub menu max width)
        const leftOffset = 280
        // offset for top pos (depending on columns menu or toolbar menu)
        // pin menu does not need any correction for top positioning
        const topOffset = subMenuRef === 'columnsMenu' ? 300 : 20

        /**
         * main menu is at the right/bottom limit of the window
         */
        this.subMenuLeftPosition = left + width + leftOffset >= window.innerWidth
        this.subMenuTopPosition = top + height + topOffset > window.innerHeight
      },
    },
  }
</script>
