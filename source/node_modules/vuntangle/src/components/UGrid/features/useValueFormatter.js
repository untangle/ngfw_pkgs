/**
 * Use an ag-grid columns 'valueFormatter' in another function.  Used in filtering and export CSV.
 *
 * @param {Object} params
 *
 * @returns {any}
 */
export default params => {
  /**
   * The params object may be different depending on what ag-grid method is calling it.  Try to use 'params.value'
   * otherwise use 'params.getValue'
   */
  let value =
    params.value !== undefined || params.getValue === undefined ? params.value : params.getValue(params.column.colId)

  // prevent CSV injections escaping following characters: +, -, =, @, 'tab'
  if ((typeof value === 'string' || value instanceof String) && ['=', '+', '-', '@', ' '].includes(value.charAt(0))) {
    value = "'" + value
  }

  // check if this cell is in a column that uses a valueFormatter
  const colDef = params.column.getColDef()
  if (colDef.valueFormatter) {
    const valueFormatterParams = {
      ...params,
      data: params.node.data,
      node: params.node,
      colDef,
      value,
    }

    // run the value formatter
    return colDef.valueFormatter(valueFormatterParams)
  }

  return value
}
