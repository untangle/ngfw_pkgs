<template>
  <div style="width: 240px">
    <div v-if="!params.disabled">
      <v-list dense class="pa-0" color="transparent">
        <v-list-item>
          <v-list-item-icon class="mr-2"><v-icon small v-text="`mdi-filter`" /></v-list-item-icon>
          <v-list-item-content><v-list-item-title v-text="$vuntangle.$t('filter')" /></v-list-item-content>
          <v-list-item-action v-show="filterActive" class="my-0 v-application">
            <v-btn x-small elevation="0" color="primary" @click="value = []" v-text="$vuntangle.$t('clear')" />
          </v-list-item-action>
        </v-list-item>
      </v-list>
      <div class="px-4">
        <v-select
          v-model="value"
          :items="items"
          attach
          small-chips
          deletable-chips
          dense
          outlined
          hide-details
          multiple
          :placeholder="$vuntangle.$t('select')"
          :menu-props="{ offsetY: true, dense: true }"
        />
      </div>
      <v-divider class="mt-4" />
    </div>
    <column-menu :params="params" />
  </div>
</template>
<script>
  import Vue from 'vue'

  // import vuetify components
  import {
    VList,
    VListItem,
    VListItemIcon,
    VIcon,
    VListItemContent,
    VListItemTitle,
    VListItemAction,
    VBtn,
    VSelect,
    VDivider,
  } from 'vuetify/lib'

  import ColumnMenu from '../components/ColumnMenu'

  export default Vue.extend({
    components: {
      ColumnMenu,
      VList,
      VListItem,
      VListItemIcon,
      VIcon,
      VListItemContent,
      VListItemTitle,
      VListItemAction,
      VBtn,
      VSelect,
      VDivider,
    },
    data() {
      return {
        value: [],
        items: [],
        filterActive: false,
        valueGetter: null,
      }
    },
    watch: {
      value() {
        this.params.filterChangedCallback()
      },
    },
    created() {
      this.valueGetter = this.params.valueGetter

      if (this.params.collection) {
        this.items = this.params.collection
      } else {
        const items = []
        this.params.api.forEachNode(node => {
          const val = node.data[this.params.colDef.field]
          if (!items.includes(val)) {
            items.push(val)
          }
        })
        this.items = items
      }
    },
    methods: {
      isFilterActive() {
        this.filterActive = this.value.length > 0
        return this.filterActive
      },

      doesFilterPass(params) {
        return this.value.includes(this.valueGetter(params.node))
      },

      getModel() {
        return { value: this.value }
      },

      setModel(model) {
        this.value = model?.value || []
      },
    },
  })
</script>
