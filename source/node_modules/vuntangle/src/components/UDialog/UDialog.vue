<template>
  <v-dialog
    v-model="dialog"
    persistent
    :retain-focus="retainFocus"
    :width="width"
    content-class="modal-border"
    :attach="attach ? attach : false"
  >
    <v-card>
      <v-card-title class="px-4 py-1 aristaMediumBlue white--text">
        {{ title }}
        <v-spacer />
        <v-btn icon @click="$emit('close-dialog')"><v-icon color="white">mdi-close</v-icon></v-btn>
      </v-card-title>

      <v-card-text class="pa-4">
        {{ message }}
        <slot></slot>
      </v-card-text>

      <v-card-actions class="pa-4">
        <v-spacer></v-spacer>
        <template v-if="buttons != null">
          <!--
            IMPORTANT!!!
            the button text condition is just a temporary workaround to show cancel button as a text button
            this must be removed in the future
          -->
          <u-btn
            v-for="button in buttons"
            :key="button.name"
            :text="button.name.toLowerCase().includes('cancel')"
            :disabled="button.disabled || buttonsDisabled"
            @click="clickButton(button)"
            ><span :class="`${$vuetify.theme.dark ? 'white--text' : ''}`">{{ button.name }} </span>
          </u-btn>
        </template>
        <template v-else>
          <u-btn @click="$emit('close-dialog')"> {{ $vuntangle.$t('ok') }} </u-btn>
        </template>
      </v-card-actions>
      <v-overlay
        :value="showProgressBar"
        absolute
        :color="$vuntangle.theme === 'dark' ? '#333' : '#FFF'"
        :opacity="0.66"
        class="text-center"
      >
        <v-progress-circular indeterminate size="32" color="aristaMediumBlue"></v-progress-circular>
      </v-overlay>
    </v-card>
  </v-dialog>
</template>

<script>
  import {
    VDialog,
    VCard,
    VCardTitle,
    VBtn,
    VIcon,
    VCardText,
    VCardActions,
    VSpacer,
    VOverlay,
    VProgressCircular,
  } from 'vuetify/lib'
  import UBtn from '../UBtn'

  export default {
    components: {
      VDialog,
      VCard,
      VCardTitle,
      VBtn,
      VIcon,
      VCardText,
      VCardActions,
      VSpacer,
      VOverlay,
      VProgressCircular,
      UBtn,
    },
    props: {
      attach: { type: String, required: false, default: '' },
      showDialog: { type: Boolean, required: true },
      width: { type: [Number, String], required: false, default: 500 },
      title: { type: String, required: true },
      message: { type: String, default: '' },
      buttons: { type: Array, default: null },
      resetState: { type: Boolean, default: false }, // allow
      retainFocus: { type: Boolean, default: true },
    },
    data() {
      return {
        buttonsDisabled: false,
        showProgressBar: false,
        dialog: this.showDialog, // to avoid mutation
      }
    },
    watch: {
      showDialog(dialog) {
        if (!dialog) {
          this.buttonsDisabled = false
          this.showProgressBar = false
        }

        // close on ESC key
        const handler = e => {
          if (e.keyCode === 27) {
            window.removeEventListener('keydown', handler)
            this.$emit('close-dialog')
          }
        }
        if (dialog) {
          window.addEventListener('keydown', handler)
        }

        // mutate data as it is used as v-model for v-dialog and cannot mutate the props
        this.dialog = dialog
      },
      /**
       * allows implementors an opportunity to turn off the show-progress and re-enable
       * the dialog buttons.  Thisis needed, in particular, when doing field validation on
       * a pop-up dialog box.
       */
      resetState() {
        if (this.resetState) {
          this.showProgressBar = false
          this.buttonsDisabled = false
        }
      },
    },
    methods: {
      clickButton(button) {
        this.buttonsDisabled = true

        // show progress bar for the button click
        if (button.showProgress) {
          this.showProgressBar = true
        }

        // emit button event
        if (button.handler) {
          this.$emit(button.handler)
        } else {
          this.$emit('close-dialog')
        }
      },
    },
  }
</script>
