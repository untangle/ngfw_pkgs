<template>
  <gmap-map
    ref="mapRef"
    :center="{ lat: 0.0, lng: 0.0 }"
    :zoom="2"
    map-type-id="roadmap"
    :options="{
      mapTypeControlOptions: {
        mapTypeIds: ['roadmap'],
      },
      streetViewControl: false,
      fullscreenControl: false,
      mapTypeControl: false,
      styles: $vuntangle.theme === 'dark' ? darkThemeStyles : [],
    }"
  >
    <gmap-marker
      v-for="(marker, index) in markers"
      :key="`marker-${index}`"
      :position="marker.position"
      :clickable="true"
      @click="goToLink(marker)"
      @mouseover="toggleInfoWindow(marker, index)"
      @mouseout="infoWinOpen = false"
    />
    <gmap-polyline
      v-for="mapLine in mapLines"
      :key="mapLine.id"
      :path.sync="mapLine.path"
      :options="{
        strokeColor: mapLine.enabled ? '#008800' : '#FF0000',
        strokeWeight: 1,
        strokeOpacity: 0.8,
        geodesic: true,
      }"
    />
    <gmap-info-window
      v-if="markers.length"
      :options="infoOptions"
      :position="infoWindowPos"
      :opened="infoWinOpen"
      @closeclick="infoWinOpen = false"
    />
  </gmap-map>
</template>
<script>
  import { gmapApi } from 'gmap-vue'
  import GmapMap from 'gmap-vue/dist/components/map'
  import GmapMarker from 'gmap-vue/dist/components/marker'
  import GmapPolyline from 'gmap-vue/dist/components/polyline'
  import GmapInfoWindow from 'gmap-vue/dist/components/info-window'

  export default {
    components: {
      GmapMap,
      GmapMarker,
      GmapPolyline,
      GmapInfoWindow,
    },
    props: {
      markers: {
        type: Array,
        required: false,
        default: () => [],
      },
      mapLines: {
        type: Array,
        required: false,
        default: () => [],
      },
    },
    data() {
      return {
        infoWindowPos: null,
        infoWinOpen: false,
        infoOptions: {
          content: '',
          // offset info window so it visually sits on top of the marker
          pixelOffset: {
            width: 0,
            height: -35,
          },
          disableAutoPan: true,
        },
        map: null,
        darkThemeStyles: [
          { elementType: 'geometry', stylers: [{ color: '#242f3e' }] },
          { elementType: 'labels.text.stroke', stylers: [{ color: '#242f3e' }] },
          { elementType: 'labels.text.fill', stylers: [{ color: '#746855' }] },
          {
            featureType: 'administrative.locality',
            elementType: 'labels.text.fill',
            stylers: [{ color: '#d59563' }],
          },
          {
            featureType: 'poi',
            elementType: 'labels.text.fill',
            stylers: [{ color: '#d59563' }],
          },
          {
            featureType: 'poi.park',
            elementType: 'geometry',
            stylers: [{ color: '#263c3f' }],
          },
          {
            featureType: 'poi.park',
            elementType: 'labels.text.fill',
            stylers: [{ color: '#6b9a76' }],
          },
          {
            featureType: 'road',
            elementType: 'geometry',
            stylers: [{ color: '#38414e' }],
          },
          {
            featureType: 'road',
            elementType: 'geometry.stroke',
            stylers: [{ color: '#212a37' }],
          },
          {
            featureType: 'road',
            elementType: 'labels.text.fill',
            stylers: [{ color: '#9ca5b3' }],
          },
          {
            featureType: 'road.highway',
            elementType: 'geometry',
            stylers: [{ color: '#746855' }],
          },
          {
            featureType: 'road.highway',
            elementType: 'geometry.stroke',
            stylers: [{ color: '#1f2835' }],
          },
          {
            featureType: 'road.highway',
            elementType: 'labels.text.fill',
            stylers: [{ color: '#f3d19c' }],
          },
          {
            featureType: 'transit',
            elementType: 'geometry',
            stylers: [{ color: '#2f3948' }],
          },
          {
            featureType: 'transit.station',
            elementType: 'labels.text.fill',
            stylers: [{ color: '#d59563' }],
          },
          {
            featureType: 'water',
            elementType: 'geometry',
            stylers: [{ color: '#17263c' }],
          },
          {
            featureType: 'water',
            elementType: 'labels.text.fill',
            stylers: [{ color: '#515c6d' }],
          },
          {
            featureType: 'water',
            elementType: 'labels.text.stroke',
            stylers: [{ color: '#17263c' }],
          },
        ],
      }
    },
    computed: {
      google: gmapApi,
    },
    watch: {
      markers: {
        immediate: true,

        /**
         * Set the zoom and center when the markers change.
         *
         * @returns {void}
         */
        handler() {
          this.setMapZoomAndCenter()
        },
      },
    },
    /**
     * Set the zoom and center when the map is loaded.
     *
     * @returns {void}
     */
    async mounted() {
      this.map = await this.$refs.mapRef.$mapPromise

      // set the center and zoom level when the map is loaded
      this.setMapZoomAndCenter()
    },
    methods: {
      /**
       * Display the info window with information from the moused over marker.
       *
       * @param {Object} marker
       * @param {number} idx
       *
       * @returns {void}
       */
      toggleInfoWindow(marker) {
        if (!marker.tooltip) {
          return
        }

        this.infoWindowPos = marker.position
        this.infoOptions.content = marker.tooltip
        this.infoWinOpen = true
      },

      /**
       * Go to the marker link if a marker link was set.
       *
       * @param {Object} marker
       *
       * @returns {void}
       */
      goToLink(marker) {
        if (marker.link) {
          this.$router.push(marker.link)
        }
      },

      /**
       * Set the zoom and center of the map around all the markers.  This should be called
       * when the map is loaded and the markers are set.
       *
       * @returns {void}
       */
      setMapZoomAndCenter() {
        // set zoom and center if there are markers and the map has loaded
        if (this.markers.length === 0 || !this.map) {
          return
        }

        // get bounds of all markers
        const bounds = new this.google.maps.LatLngBounds()
        this.markers.forEach(function (marker) {
          bounds.extend(marker.position)
        })

        // center around the bounds
        this.map.setCenter(bounds.getCenter())

        // the zoom will not update without a nextTick
        this.$nextTick(() => {
          // only one bound, so zoom out a bit
          if (bounds.getNorthEast().equals(bounds.getSouthWest())) {
            this.map.setZoom(14)
          } else {
            // zoom around bounds
            this.map.fitBounds(bounds)
          }
        })
      },
    },
  }
</script>
<style lang="scss">
  div {
    .gm-style-iw-d {
      /* set the max height of the gmap info window bigger or a scroll bar is shown */
      max-height: 200px !important;

      div {
        color: black;
      }
    }
  }
</style>
