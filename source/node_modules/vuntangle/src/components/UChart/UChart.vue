<template>
  <div style="position: relative; height: 100%; width: 100%">
    <chart
      ref="hc"
      :constructor-type="constructorType"
      :options="mergedOptions"
      style="position: absolute; top: 0; right: 0; left: 0; bottom: 0; width: 100%; height: 100%"
    />
    <u-chart-overlay :fetching="fetching" :no-data="mergedOptions.series.length === 0" />
  </div>
</template>
<script>
  import { Chart } from 'highcharts-vue'
  import merge from 'lodash/merge'
  import UChartOverlay from '../UChartOverlay'
  import uChartProps from './props'

  const defaultOptions = {
    credits: { enabled: false },
    title: { text: undefined },
    series: [],
  }

  export default {
    components: { Chart, UChartOverlay },
    props: {
      // different chart types (chart, mapChart, stockChart)
      constructorType: { type: String, default: 'chart' },

      // highcharts options object
      options: { type: Object, required: true },

      // import common props
      ...uChartProps,
    },
    data: () => ({ mergedOptions: defaultOptions }),
    watch: {
      resize(newResize) {
        if (newResize) {
          this.$nextTick(() => {
            this.$refs.hc.chart.reflow()
            // set the prop back in the parent so it can be resized again
            this.$emit('update:resize', false)
          })
        }
      },
      options: {
        immediate: true,
        deep: true,
        handler(options) {
          this.$nextTick(
            () => (this.mergedOptions = merge({}, defaultOptions, options, this.getHcTheme(this.$vuntangle.theme))),
          )
        },
      },
      'options.series': {
        immediate: true,
        deep: true,
        handler() {
          this.$nextTick(() => this.$refs.hc.chart.reflow())
        },
      },
      '$vuntangle.theme'(theme) {
        this.$nextTick(() => merge(this.mergedOptions, this.getHcTheme(theme)))
      },
    },
    methods: {
      /**
       * Returns light and dark theme settings for highcharts.
       *
       * @param {String} name - The name of the theme ("Base Theme" or "Dark Theme")
       *
       * @returns {Object}
       */
      getHcTheme(name) {
        const lightTheme = {
          colors: [
            '#7cb5ec',
            '#434348',
            '#90ed7d',
            '#f7a35c',
            '#8085e9',
            '#f15c80',
            '#e4d354',
            '#2b908f',
            '#f45b5b',
            '#91e8e1',
          ],
          chart: {
            backgroundColor: '#FFFFFF',
          },
          xAxis: {
            lineColor: '#ccd6eb',
            labels: {
              style: {
                color: '#555555',
              },
            },
          },
          yAxis: {
            gridLineColor: '#e6e6e6',
            labels: {
              style: {
                color: '#555555',
              },
            },
          },
          legend: {
            itemStyle: {
              color: '#333333',
              fontWeight: 'normal',
            },
            itemHoverStyle: {
              'color': '#000000',
            },
            itemHiddenStyle: {
              'color': '#CCCCCC',
            },
            title: {
              style: { color: '#333' },
            },
          },
          plotOptions: {
            pie: {
              borderColor: '#FFFFFF',
            },
            series: {
              dataLabels: {
                style: {
                  color: '#333333',
                  fontWeight: 'normal',
                  textOutline: 0,
                },
              },
            },
          },
        }

        const darkTheme = {
          colors: [
            '#2b908f',
            '#90ee7e',
            '#f45b5b',
            '#7798BF',
            '#aaeeee',
            '#ff0066',
            '#eeaaee',
            '#55BF3B',
            '#DF5353',
            '#7798BF',
          ],
          chart: {
            backgroundColor: 'transparent',
          },
          xAxis: {
            lineColor: '#444444',
            gridLineColor: '#222222',
            labels: {
              style: {
                color: '#AAA',
              },
            },
          },
          yAxis: {
            gridLineColor: '#333333',
            labels: {
              style: {
                color: '#AAA',
              },
            },
          },
          legend: {
            itemStyle: {
              color: '#CCCCCC',
              fontWeight: 'normal',
            },
            itemHoverStyle: {
              'color': '#EEEEEE',
            },
            itemHiddenStyle: {
              'color': '#444444',
            },
            title: {
              style: { color: '#CCC' },
            },
          },
          plotOptions: {
            pie: {
              borderColor: '#1f2427',
            },
            series: {
              dataLabels: {
                style: {
                  color: '#EEEEEE',
                  fontWeight: 'normal',
                  textOutline: 0,
                },
              },
            },
          },
        }

        return name === 'dark' ? darkTheme : lightTheme
      },
    },
  }
</script>
