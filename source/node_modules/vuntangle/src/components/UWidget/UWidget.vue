<template>
  <v-card outlined :class="`d-flex flex-column u-widget ${$vuntangle.theme === 'dark' ? 'u-dark' : ''}`">
    <v-card-title :class="`py-0 pr-2 subtitle-1 u-widget-title ${dragEnabled ? ' drag' : ''}`">
      <span :class="`py-2 font-weight-medium`">{{ title }}</span>
      <span v-if="dragEnabled" class="drag-handle py-2 text-center flex-grow-1" style="color: #555; text-align: center">
        &lt; {{ $vuntangle.$t('drag_me') }} &gt;
      </span>
      <v-spacer v-if="!dragEnabled" />

      <slot name="actions"></slot>

      <u-btn v-if="dragEnabled" icon :min-width="NaN" @click="dragEnabled = false">
        <v-icon>mdi-check</v-icon>
      </u-btn>

      <!-- the widget info tooltip -->
      <v-tooltip v-if="info && !dragEnabled" left max-width="400" transition="none">
        <template #activator="{ on, attrs }">
          <v-icon v-bind="attrs" class="mr-2" v-on="on"> mdi-information-outline </v-icon>
        </template>
        <span>{{ info }}</span>
      </v-tooltip>

      <!-- widget expand handler -->
      <v-tooltip v-if="enableExpand && !dragEnabled" top transition="none">
        <template #activator="{ on, attrs }">
          <v-icon v-bind="attrs" v-on="on" @click="expandActive = true">mdi-arrow-expand</v-icon>
        </template>
        <span>{{ $vuntangle.$t('expand') }}</span>
      </v-tooltip>

      <v-menu v-if="showMenu" offset-y left>
        <template #activator="{ on, attrs }">
          <v-btn icon v-bind="attrs" v-on="on"><v-icon>mdi-dots-vertical</v-icon></v-btn>
        </template>
        <v-list dense>
          <v-list-item v-if="enableRefresh" dense @click="$emit('refresh')">
            <v-list-item-icon class="mr-2"><v-icon>mdi-refresh</v-icon></v-list-item-icon>
            <v-list-item-title>{{ $vuntangle.$t('refresh') }}</v-list-item-title>
          </v-list-item>
          <v-list-item v-if="enableMove" dense @click="dragEnabled = true">
            <v-list-item-icon class="mr-2"><v-icon>mdi-arrow-all</v-icon></v-list-item-icon>
            <v-list-item-title>{{ $vuntangle.$t('move') }}</v-list-item-title>
          </v-list-item>
          <v-list-item v-if="enableRemove" dense @click="$emit('remove')">
            <v-list-item-icon class="mr-2"><v-icon>mdi-close</v-icon></v-list-item-icon>
            <v-list-item-title>{{ $vuntangle.$t('remove') }}</v-list-item-title>
          </v-list-item>
        </v-list>
      </v-menu>
    </v-card-title>

    <!--
       hiding the original slot when expand view is active to avoid
       having two version of the slot active in the DOM at the same time
     -->
    <slot v-if="!expandActive"></slot>
    <v-overlay :value="fetching" class="text-center" absolute color="rgba(255, 255, 255, 0.5)">
      <v-progress-circular indeterminate size="32" color="aristaMediumBlue"></v-progress-circular>
    </v-overlay>
    <u-dialog
      :show-dialog="expandActive"
      width="90%"
      :title="title"
      :retain-focus="false"
      :buttons="[
        {
          'name': $t('close'),
          'handler': 'close-dialog',
        },
      ]"
      @close-dialog="expandActive = false"
    >
      <div style="height: 75vh" class="d-flex flex-column mb-n4">
        <slot></slot>
      </div>
    </u-dialog>
  </v-card>
</template>
<script>
  import {
    VCard,
    VCardTitle,
    VTooltip,
    VIcon,
    VMenu,
    VList,
    VListItem,
    VListItemIcon,
    VListItemTitle,
    VOverlay,
    VProgressCircular,
  } from 'vuetify/lib'
  import UBtn from '../UBtn'
  import UDialog from '../UDialog'

  export default {
    components: {
      VCard,
      VCardTitle,
      VTooltip,
      VIcon,
      VMenu,
      VList,
      VListItem,
      VListItemIcon,
      VListItemTitle,
      VOverlay,
      VProgressCircular,
      UBtn,
      UDialog,
    },
    props: {
      title: {
        type: String,
        default: null,
      },
      info: {
        type: String,
        default: null,
      },
      fetching: {
        type: Boolean,
        default: false,
      },
      enableRefresh: {
        type: Boolean,
        default: false,
      },
      enableMove: {
        type: Boolean,
        default: false,
      },
      enableRemove: {
        type: Boolean,
        default: false,
      },
      enableExpand: {
        type: Boolean,
        default: true,
      },
    },
    data() {
      return {
        dragEnabled: false,
        expandActive: false,
      }
    },
    computed: {
      showMenu() {
        return !this.dragEnabled && (this.enableRefresh || this.enableMove || this.enableRemove)
      },
    },
    deactivated() {
      this.expandActive = false
    },
  }
</script>
<style lang="scss">
  .u-widget {
    width: 100%;
    height: 100%;
    .u-widget-title {
      border-bottom: 1px rgba(0, 0, 0, 0.12) solid;
      &.drag {
        color: #0071dc;
        background: lightgreen;
      }
    }

    &.u-dark {
      .u-widget-title {
        border-bottom: 1px rgba(255, 255, 255, 0.12) solid;
      }
    }
  }
</style>
