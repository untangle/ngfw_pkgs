<template>
  <u-dialog
    :attach="attach"
    :show-dialog="showMfaDialog"
    :title="$vuntangle.$t('verification_code')"
    :buttons="[
      { name: $vuntangle.$t('cancel'), handler: 'close-dialog' },
      { name: $vuntangle.$t('ok'), handler: 'send-mfa-token', showProgress: true },
    ]"
    :reset-state="resetShowMfa"
    @send-mfa-token="submitMfa"
    @close-dialog="dialogCanceled"
  >
    <div v-if="instructions" v-html="instructions" />
    <ValidationObserver ref="mfaObs">
      <ValidationProvider v-slot="{ errors }" name="mfaCode" rules="required">
        <v-text-field
          v-model="mfaCode"
          :label="$vuntangle.$t('verification_code')"
          :error-messages="errors"
          outlined
          hide-details
          class="mt-4 fs-mask fs-mask-without-consent"
          @keyup.enter="submitMfa"
        >
          <template v-if="errors.length" #append>
            <u-errors-tooltip :errors="errors" />
          </template>
        </v-text-field>
      </ValidationProvider>
      <!-- bypassMFA checkbox(if login_mfa_verification_required) -->
      <u-checkbox v-if="showBypassMfa" v-model="bypassMfa" :label="$vuntangle.$t('bypass_mfa')"> </u-checkbox>
    </ValidationObserver>
  </u-dialog>
</template>

<script>
  import UDialog from '../UDialog'
  import UCheckbox from '../UCheckbox'
  import UErrorsTooltip from '../UErrorsTooltip'

  export default {
    components: { UDialog, UCheckbox, UErrorsTooltip },
    props: {
      attach: { type: String, required: false, default: '' },
      showMfa: { type: Boolean, default: false },
      showBypassMfa: { type: Boolean, default: true },

      // display instructions in the MFA dialog, should already be translated so we are not limited to vuntangle keys
      instructions: { type: String, required: true },
    },
    data() {
      return {
        resetShowMfa: false,
        showMfaDialog: this.showMfa,
        mfaCode: '',
        bypassMfa: false,
      }
    },

    watch: {
      showMfa(show) {
        this.showMfaDialog = show
      },
      showMfaDialog(show) {
        if (!show) {
          this.mfaCode = ''
          this.$refs.mfaObs.reset()
          this.resetShowMfa = true
        }
        this.$emit('update:showMfa', show)
      },
    },

    methods: {
      async submitMfa() {
        this.resetShowMfa = false
        const valid = await this.$refs.mfaObs.validate()
        if (valid) {
          this.$emit('submit-mfa', this.mfaCode, this.bypassMfa)
          this.$refs.mfaObs.reset()
        } else {
          this.resetShowMfa = true
        }
      },
      dialogCanceled() {
        this.showMfaDialog = false
        this.$emit('dialog-canceled')
      },
    },
  }
</script>
