<!--
  Component used in nav drawers displaying a list derived from a store (e.g. appliances)
  Sample usage:
  <ut-nav-list
    :items="items"
    :enable-filter="true"
    back-to="/appliances"
  ></ut-nav-list>
-->
<template>
  <div class="d-flex flex-column fill-height align-stretch" style="overflow-y: auto">
    <v-card-actions v-if="showHeader" flat class="pa-2">
      <v-btn v-if="backTo" icon class="mr-2" :to="backTo">
        <v-icon>mdi-arrow-left</v-icon>
      </v-btn>
      <u-text-field
        v-if="enableFilter"
        v-model="filterText"
        :placeholder="$vuntangle.$t('quick_filter')"
        flat
        clearable
      />
      <v-btn v-if="enableRefresh" icon class="ml-2" @click="fetchData(true)">
        <v-icon>mdi-refresh</v-icon>
      </v-btn>
    </v-card-actions>

    <v-divider />

    <v-list dense nav class="flex-grow-1" style="overflow-y: auto">
      <v-tooltip
        v-for="(item, i) in filteredItems"
        :key="i"
        right
        transition="none"
        :color="$vuntangle.theme === 'dark' ? 'white' : 'black'"
      >
        <template #activator="{ on }">
          <v-list-item :to="item.to" exact v-on="on">
            <!-- add icon if set on item -->
            <v-list-item-avatar size="16" tile>
              <v-icon v-if="item.icon" x-small :color="item.iconColor || 'primary'">{{ item.icon }}</v-icon>
              <v-img v-if="item.img" :src="item.img" contain></v-img>
            </v-list-item-avatar>
            <v-list-item-title class="text-none" v-html="item.title" />
          </v-list-item>
        </template>
        <span :class="$vuntangle.theme === 'dark' ? 'black--text' : 'white--text'" v-html="item.tooltip"></span>
      </v-tooltip>
    </v-list>

    <v-overlay :value="isFetching" :absolute="true" z-index="999" class="text-center">
      <v-progress-circular indeterminate size="32" color="aristaMediumBlue" />
    </v-overlay>
  </div>
</template>

<script>
  import {
    VCardActions,
    VBtn,
    VIcon,
    VDivider,
    VList,
    VTooltip,
    VListItem,
    VListItemAvatar,
    VImg,
    VListItemTitle,
    VOverlay,
    VProgressCircular,
  } from 'vuetify/lib'
  import UTextField from '../UTextField'

  export default {
    components: {
      VCardActions,
      VBtn,
      VIcon,
      VDivider,
      VList,
      VTooltip,
      VListItem,
      VListItemAvatar,
      VImg,
      VListItemTitle,
      VOverlay,
      VProgressCircular,
      UTextField,
    },
    props: {
      /**
       * Array with nav items,
       * Item is an object having following props:
       * {
       *   to: '<route>' - required, the route link for this item
       *   title: '<title>' - required, the list title text
       *   icon: '<icon-string>' - optional, the icon string (e.g. 'mdi-cog')
       *   iconColor: '<color>' - optional, the color of the icon
       *   img: '<img-url>' - optional, the image url shown as an avatar
       *   data: {Object} - the full data object (used for filtering/tooltips)
       * }
       */
      items: {
        type: Array,
        default() {
          return []
        },
      },
      /**
       * A string defining the back route, it will show a back button if defined
       */
      backTo: {
        type: String,
        default: '',
      },
      /**
       * Boolean that adds a filtering text field to find a specific item
       * The filter lookups for title and subtitles matches
       */
      enableFilter: {
        type: Boolean,
        default: false,
      },

      /**
       * Boolean adding refresh button to the top of the list
       */
      enableRefresh: {
        type: Boolean,
        default: false,
      },

      /**
       * store actions to be dispatched related with list data to display
       */
      dataActions: {
        type: Array,
        default() {
          return []
        },
      },

      /**
       * store loaders monitoring data state
       */
      dataLoaders: {
        type: Array,
        default() {
          return []
        },
      },

      /**
       * Functioned called if a data action failed in fetchData()
       * @params ex - exception that trigged error
       */
      fetchErrorHandler: {
        type: Function,
        // eslint-disable-next-line no-console
        default: ex => console.error(ex),
      },
    },
    data() {
      return {
        // the filter string used for matching title and subtitles
        filterText: '',
      }
    },
    computed: {
      /**
       * Method that filters out items based on quick filter string
       */
      filteredItems() {
        if (!this.filterText) {
          return this.items
        }
        return this.items.filter(item => {
          let filter = false
          for (const [, value] of Object.entries(item.data)) {
            if (!filter && value && value.toString().toLowerCase().includes(this.filterText.toLowerCase())) {
              filter = true
            }
          }
          return filter
        })
      },

      /**
       * boolean showing list header
       */
      showHeader() {
        return this.backTo || this.enableFilter || this.enableRefresh
      },

      isFetching() {
        return this.dataLoaders.some(loader => {
          return loader.split('.').reduce((a, b) => a[b], this.$store.state)
        })
      },
    },

    mounted() {
      if (this.dataActions) {
        this.fetchData()
      }
    },

    methods: {
      /**
       * dispatches store actions passed via dataActions
       */
      async fetchData(force = false) {
        await Promise.all(
          this.dataActions.map(async action => {
            try {
              await this.$store.dispatch(action, { force })
            } catch (ex) {
              // shows vuex exception when running in dev mode
              this.fetchErrorHandler(ex)
            }
          }),
        )
      },
    },
  }
</script>
