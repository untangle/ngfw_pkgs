<template>
  <u-grid
    :id="id"
    :custom-grid-options="remoteGridOptions"
    :column-defs="columnDefs"
    :enable-export-csv="false"
    :row-node-id="rowNodeId"
    :framework-components="frameworkComponents"
    :selection-type="selectionType"
    :selection.sync="rSelection"
    :resize-columns="resizeColumns"
    :toolbar="toolbar"
    :enable-refresh="enableRefresh"
    :enable-quick-filter="false"
    :row-data="null"
    :modules="$options.modules"
    @gridApiReady="gridApiReady"
    @refresh="onRefresh"
  >
  </u-grid>
</template>
<script>
  import { InfiniteRowModelModule } from '@ag-grid-community/infinite-row-model'
  import props from '../UGrid/props'
  import UGrid from '../UGrid'

  export default {
    modules: [InfiniteRowModelModule],
    components: {
      UGrid,
    },

    props: {
      ...props,
      // function used to populate the grid
      getData: {
        type: Function,
        required: true,
      },
    },

    data() {
      return {
        gridApi: null,
        // global grid options
        remoteGridOptions: {
          pagination: true,
          rowModelType: 'infinite',
          infiniteInitialRowCount: 0,
          cacheBlockSize: 1000,
          paginationPageSize: 1000,
          ...this.customGridOptions,
        },

        datasource: {
          getRows: async params => {
            const { rowData, rowCount } = await this.getData(params)
            params.successCallback(rowData, rowCount)
          },
        },
      }
    },

    computed: {
      // remote selection, wraps prop to prevent direct mutation
      rSelection: {
        get() {
          return this.selection
        },
        set(newSelection) {
          this.$emit('update:selection', newSelection)
        },
      },
    },

    methods: {
      gridApiReady(api) {
        this.gridApi = api
        this.gridApi.setDatasource(this.datasource)
      },
      onRefresh() {
        if (!this.enableRefresh) return
        this.$emit('refresh')
        this.gridApi.purgeInfiniteCache()
      },
    },
  }
</script>
