<template>
  <div id="form-wrapper">
    <!-- this slot can be used by the host app to display any login messages, responses, etc -->
    <slot name="loginMessage" />
    <!-- for validation rules definitions see plugins/vee-validate.js -->
    <ValidationObserver ref="obs" v-slot="{ passes }">
      <!-- Log In section (form) -->
      <v-form id="u-login-form" @submit.prevent>
        <!-- userLogin field -->
        <ValidationProvider v-slot="{ errors }" name="userLogin" :rules="`required${!organizationSso ? '|email' : ''}`">
          <u-text-field
            id="u-login-email"
            v-model="credentials.userLogin"
            name="email"
            type="email"
            class="mb-4"
            :label="userLoginHadFocus ? userLoginLabel : ''"
            prepend-inner-icon="mdi-account"
            :error-messages="errors"
            :disabled="fetching"
            :dense="false"
            :placeholder="userLoginLabel"
            @keyup="$event.keyCode === 13 ? passes(checkSso) : null"
            @focus="userLoginHadFocus = true"
            @change="$emit('update:showPassword', false)"
          >
            <template v-if="errors.length" #append>
              <u-errors-tooltip :errors="errors" />
            </template>
          </u-text-field>
        </ValidationProvider>
        <div :hidden="!showPassword">
          <!-- password field -->
          <ValidationProvider v-slot="{ errors }" name="password" :rules="showPassword ? 'required' : ''">
            <u-text-field
              id="u-login-password"
              v-model="credentials.password"
              :append-icon="passwordReveal ? 'mdi-eye' : 'mdi-eye-off'"
              :type="passwordReveal ? 'text' : 'password'"
              :label="passwordHadFocus ? $vuntangle.$t('password') : ''"
              :disabled="fetching"
              :error-messages="errors"
              :dense="false"
              class="mb-4"
              prepend-inner-icon="mdi-lock"
              :placeholder="$vuntangle.$t('password')"
              @click:append="passwordReveal = !passwordReveal"
              @keyup="$event.keyCode === 13 ? passes(login) : null"
              @focus="passwordHadFocus = true"
            >
              <template v-if="errors.length" #append>
                <u-errors-tooltip :errors="errors" />
              </template>
            </u-text-field>
          </ValidationProvider>

          <!-- forgot password link -->
          <v-card-text v-if="forgotPassword" class="px-0 pb-0 text-right pt-0 mb-4">
            <a class="link-btn" @click="$emit('forgot-password')"> {{ $vuntangle.$t('forgot_your_password') }}</a>
          </v-card-text>
          <!-- Login button -->
          <v-btn large block depressed color="primary" :disabled="fetching" @click="passes(login)">
            {{ $vuntangle.$t('log_in') }}
          </v-btn>
        </div>
        <!-- Continue button -->
        <v-btn v-if="!showPassword" large block depressed color="primary" @click="passes(checkSso)">
          {{ $vuntangle.$t('continue') }}
        </v-btn>
        <div class="d-flex flex-wrap" style="column-gap: 8px">
          <div v-if="googleSso" id="googleLoginDiv" class="sso-login-button mt-4"></div>
          <v-btn
            v-if="microsoftSso"
            id="microsoftLogin"
            small
            depressed
            class="sso-login-button mt-4"
            :dark="!fetching"
            :disabled="fetching"
            @click="microsoftLogin"
          >
            <img :src="require('../../static/icons/sso/microsoft_logo.png')" class="mr-2 sso-login-img" />{{
              $vuntangle.$t('sign_in_with_microsoft')
            }}
          </v-btn>
        </div>
      </v-form>
    </ValidationObserver>
    <!-- SIGN UP section -->
    <div v-if="signupSection">
      <v-divider class="my-4"></v-divider>
      <v-card-title class="px-0 pt-0">{{ $vuntangle.$t('sign_up') }}</v-card-title>
      <v-card-subtitle class="px-0 pt-0">
        {{ $vuntangle.$t('sign_up_msg') }}
        <a class="link-btn" @click="$emit('create-account')">
          {{ $vuntangle.$t('create_an_account') }}
        </a>
      </v-card-subtitle>
    </div>
    <!-- loading overlay while pending calls -->
    <v-overlay absolute :value="fetching" opacity="0.6">
      <v-progress-circular indeterminate color="aristaMediumBlue"></v-progress-circular>
    </v-overlay>
    <!-- Mfa Dialog -->
    <u-mfa-dialog
      :attach="mfaAttach"
      :show-mfa="showMfa"
      :show-bypass-mfa="showBypassMfa"
      :instructions="mfaInstructions"
      @update:showMfa="val => $emit('update:showMfa', val)"
      @submit-mfa="submitMfaCode"
    />
  </div>
</template>

<script>
  import { captureException } from '@sentry/vue'
  import { VForm, VOverlay, VProgressCircular } from 'vuetify/lib'
  import util from '../../plugins/util'
  import UMfaDialog from '../UMfaDialog'
  import UTextField from '../UTextField'
  import UErrorsTooltip from '../UErrorsTooltip'

  export default {
    components: { UMfaDialog, UTextField, UErrorsTooltip, VForm, VOverlay, VProgressCircular },
    props: {
      // prop to display a login with google button and do google sso, will emit 'oauth-login' even when complete
      googleSso: { type: Boolean, required: false, default: true },

      // prop to display a login with microsoft button and do microsoft sso, will emit 'oauth-login' even when complete
      microsoftSso: { type: Boolean, required: false, default: true },

      organizationSso: { type: Boolean, required: false, default: true },

      // prop to display a sign up section, will emit 'create-account' when clicked
      signupSection: { type: Boolean, required: false, default: false },

      // prop to display a forgot password link, will emit 'forgot-password' when clicked
      forgotPassword: { type: Boolean, required: false, default: true },

      // boolean to show an overlay and disable buttons while fetching data, the fetch is initiated in parent
      fetching: { type: Boolean, default: false },

      // used to show popup for Mfa code
      showMfa: { type: Boolean, required: false, default: false },
      mfaInstructions: { type: String, required: false, default: '' },

      // this is used for an iframe login where you can attach the mfa dialog to the form instead of the whole page
      mfaAttach: { type: String, required: false, default: '' },

      // an email prop may be filled in to automatically enter their email address, like coming from an verification link
      email: { type: String, required: false, default: '' },

      // flag to show password field if SSO is not configured
      showPassword: { type: Boolean, required: false, default: false },
    },
    data() {
      return {
        /**
         * these are credentials posted when login in
         * they are reactive on changes made in the fields via v-model prop
         */
        credentials: {
          userLogin: this.email,
          password: '',
        },

        // hold the last login method in case mfa is required
        loginMethod: {
          type: 'login',
          idToken: null,
        },

        // used to manage pop up checkbox, to not display it for Arista/Untangle user
        showBypassMfa: true,

        // boolean used to reveal password field
        passwordReveal: false,

        googleLoginEnabled: true,
        /**
         * Workaround for email/password autocomplete overlapping vuetify label/placeholder behavior.  Once
         * the field has had focus the vuetify label behavior will work like normal.
         */
        userLoginHadFocus: false,
        passwordHadFocus: false,
      }
    },
    computed: {
      userLoginLabel: ({ $vuntangle, organizationSso }) =>
        $vuntangle.$t(organizationSso ? 'email_address_or_organization' : 'email_address'),
    },
    /**
     * Called in 'mounted' instead of 'created' as globals (document.head) should not be called in 'created' lifecycle.
     */
    mounted() {
      // inject google api for SSO login if the google prop is sent
      if (this.googleSso) {
        this.setGoogleApi()
      }
    },
    created() {
      // check if microsoft single sign on passed a token back for login
      const idToken = util.getUrlParameterByName('code')
      if (idToken) {
        this.handleMicrosoftLoginResponse(idToken)
      }
    },
    methods: {
      /**
       * Try the login again based on the previous login method, this time sending Mfa information.
       *
       * @param {string}  mfaCode
       * @param {boolean} bypassMfa
       */
      submitMfaCode(mfaCode, bypassMfa) {
        if (this.loginMethod.type === 'handleMicrosoftLoginResponse') {
          this.$emit(
            'oauth-login',
            'Microsoft',
            this.credentials.userLogin,
            this.loginMethod.idToken,
            mfaCode,
            bypassMfa,
          )
        } else if (this.loginMethod.type === 'handleGoogleLoginResponse') {
          this.$emit('oauth-login', 'Google', this.credentials.userLogin, this.loginMethod.idToken, mfaCode, bypassMfa)
        } else {
          this.login(mfaCode, bypassMfa)
        }
      },
      /**
       * Inject the external google api javascript into the head tag.
       */
      setGoogleApi() {
        const gapiScript = document.createElement('script')
        gapiScript.setAttribute('src', 'https://accounts.google.com/gsi/client')
        gapiScript.async = true
        gapiScript.defer = true
        // determine if the google api loaded
        gapiScript.onload = () => {
          this.googleLoginEnabled = window.google !== undefined
          this.googleLogin()
        }
        document.head.appendChild(gapiScript)
      },
      /**
       * Login with google single sign on.
       */
      googleLogin() {
        // authorize from google api
        window.google.accounts.id.initialize({
          client_id: '1091873417511-s8mjl92mst5n2i6ku8je0nekj3eqsroi.apps.googleusercontent.com',
          callback: response => {
            // return if error response
            if (response.error && response.error !== 'popup_closed_by_user') {
              captureException(response)
            }
            if (!response.error) {
              this.handleGoogleLoginResponse(response.credential)
            }
          },
        })
        // get width of the Microsoft button and set it to the Google button as well
        const buttonWidth = document.getElementById('googleLoginDiv').parentElement.offsetWidth
        window.google.accounts.id.renderButton(
          document.getElementById('googleLoginDiv'),
          { theme: 'outline', size: 'large', logo_alignment: 'center', width: buttonWidth }, // customization attributes
        )
      },
      handleGoogleLoginResponse(idToken, mfaCode = '', bypassMfa = false) {
        this.loginMethod = { type: 'handleGoogleLoginResponse', idToken }
        this.$emit('oauth-login', 'Google', this.credentials.userLogin, idToken, mfaCode, bypassMfa)
      },
      /**
       * Login with microsoft single sign on.
       */
      microsoftLogin() {
        const urlParts = window.location.href.split('?')
        const embedLogin = window.location.search.includes('embed')
        let redirectUrl = encodeURI(urlParts[0])
        let state = ''
        if (urlParts.length > 1) {
          // strip embed directive, since we'll be in a new window
          state = '&state=' + encodeURIComponent(urlParts[1].replace('embed&', ''))
        }

        // remove any hash items
        redirectUrl = redirectUrl.replace('#', '')

        const url =
          'https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=dbee89a4-4f85-4d5c-a013-f532c5d49d4a&response_type=code&prompt=select_account&redirect_uri=' +
          redirectUrl +
          '&response_mode=query&scope=user.read' +
          state
        if (embedLogin) {
          window.open(url) // we have to open a popup if the login form is embedded
        } else {
          window.location.href = url
        }
      },
      /**
       * Handle a possible login response back from the microsoft single sign on.
       */
      handleMicrosoftLoginResponse(idToken, mfaCode = '', bypassMfa = false) {
        // remove microsoft's "code=" query from the URL, change it to the original params which is in "state="
        let state = util.getUrlParameterByName('state')
        state = state ? `?${state}` : ''

        const currentUrl = new URL(window.location.href)
        window.history.replaceState({}, null, `${currentUrl.origin}${currentUrl.pathname}${state}`)

        // login to command center via oAuth
        this.loginMethod = { type: 'handleMicrosoftLoginResponse', idToken }
        this.$emit('oauth-login', 'Microsoft', this.credentials.userLogin, idToken, mfaCode, bypassMfa)
      },
      /**
       * makes the login call with the credentials
       */
      login(mfaCode = '', bypassMfa = false) {
        // checks is user is from Arista or Untangle for updating Mfa Dialog
        this.checkIfAristaOrUntangleUser()

        this.loginMethod = { type: 'login', idToken: null }
        this.$emit('login', this.credentials.userLogin, this.credentials.password, mfaCode, bypassMfa)
      },

      /*
       * If "organizationSso" prop is true, emit an event to check their sso.  If not, just display the
       * password field.
       */
      checkSso() {
        this.$refs.obs.reset()

        if (this.organizationSso) {
          this.$emit('check-sso', this.credentials.userLogin)
        } else {
          this.$emit('update:showPassword', true)
        }
      },

      checkIfAristaOrUntangleUser() {
        // arista and untangle users should not see the checkbox, unless the email string contains a + (default value is true)
        this.showBypassMfa =
          !['arista.com', 'untangle.com'].includes(this.credentials.userLogin.split('@')[1]) ||
          this.credentials.userLogin.split('@')[0].includes('+')
      },
    },
  }
</script>
<style lang="scss">
  @import '../../scss/variables';
  #custom-disabled.v-btn--disabled {
    color: #b3b3b2 !important;
  }
  .sso-login-button {
    color: #5e5e5e !important;
    background-color: #ffffff !important;
    border: 1px #8c8c8c solid !important;
    border-radius: 0px;
    flex-grow: 1;
    display: flex;
    min-height: 41px;
    text-transform: none !important;
    .sso-login-img {
      width: 18px;
      height: 18px;
    }
  }
  .link-btn {
    color: $aristaMediumBlue !important;
  }
  #form-wrapper .v-dialog__content {
    position: absolute;
  }
</style>
