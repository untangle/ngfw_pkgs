<template>
  <v-dialog
    v-model="displayConfirm"
    :transition="false"
    persistent
    :width="width || 600"
    @keydown.esc="onCancel"
    @keydown.enter="onConfirm"
  >
    <v-card class="test">
      <v-card-title class="text-h5 font-weight-light">
        <span v-html="title" />
        <v-spacer />
        <v-btn :small="false" icon color="grey" @click="onCancel">
          <v-icon>mdi-close</v-icon>
        </v-btn>
      </v-card-title>

      <v-card-text v-if="messageList.length" class="text-body-1">
        <span v-html="message" />
        <ul>
          <li v-for="listItem in messageList" :key="listItem">{{ listItem }}</li>
        </ul>
      </v-card-text>
      <v-card-text v-else-if="message" class="text-body-1" v-html="message" />

      <v-card-actions class="pa-6">
        <v-spacer />
        <template v-if="buttons">
          <u-btn
            v-for="button in buttons"
            :key="button.name"
            v-bind="button.props"
            @click="onButtonClick(button.handler)"
          >
            {{ button.name }}
          </u-btn>
        </template>
        <template v-else>
          <u-btn :small="false" color="default" :min-width="80" @click="onCancel">
            {{ cancelLabel || $vuntangle.$t('no') }}
          </u-btn>
          <u-btn :small="false" :min-width="80" elevation="0" @click="onConfirm">
            {{ confirmLabel || $vuntangle.$t('yes') }}
          </u-btn>
        </template>
      </v-card-actions>
      <v-overlay v-if="progress" absolute>
        <v-progress-circular indeterminate color="primary" />
      </v-overlay>
    </v-card>
  </v-dialog>
</template>

<script>
  import {
    VDialog,
    VCard,
    VCardTitle,
    VSpacer,
    VBtn,
    VIcon,
    VCardText,
    VCardActions,
    VOverlay,
    VProgressCircular,
  } from 'vuetify/lib'

  export default {
    components: {
      VDialog,
      VCard,
      VCardTitle,
      VSpacer,
      VBtn,
      VIcon,
      VCardText,
      VCardActions,
      VOverlay,
      VProgressCircular,
    },
    data() {
      return {
        title: null,
        message: null,
        buttons: null,
        confirmLabel: null,
        cancelLabel: null,
        width: null,
        height: null,
        progress: false,
        action: null,
        cancel: null,
        messageList: [],
      }
    },

    computed: {
      displayConfirm() {
        return this.message !== null
      },
    },

    created() {
      this.$vuntangle.vm.$on('show-confirm', this.show)
    },

    methods: {
      show(options) {
        Object.assign(this, { ...options })
      },

      /**
       * Hides and resets the dialog data
       */
      onClose() {
        this.title = null
        this.message = null
        this.buttons = null
        this.cancelLabel = null
        this.confirmLabel = null
        this.width = null
        this.progress = false
        this.action = null
        this.cancel = null
      },

      async onConfirm() {
        this.progress = true
        await new Promise(resolve => this.action(resolve))
        this.onClose()
      },

      async onCancel() {
        this.progress = true
        if (this.cancel) await new Promise(resolve => this.cancel(resolve))
        this.onClose()
      },

      async onButtonClick(handler) {
        // bind 'this' to this component, can use arrow function to get the caller 'this'
        const bindThis = handler.bind(this)
        this.progress = true
        await bindThis()
        this.progress = false
      },
    },
  }
</script>
