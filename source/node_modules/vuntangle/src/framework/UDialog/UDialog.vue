<template>
  <v-dialog
    v-model="displayDialog"
    :transition="false"
    persistent
    :width="width || 600"
    :content-class="edge ? 'dialog-edge' : ''"
    @keydown.esc="onClose"
    @keydown.enter="onAction"
  >
    <v-card class="d-flex flex-column fill-height">
      <v-card-title class="text-h5 font-weight-light px-4">
        <span v-html="title"></span>
        <v-spacer />
        <v-btn :small="false" icon color="grey" @click="onClose"><v-icon>mdi-close</v-icon></v-btn>
      </v-card-title>
      <!-- the component being rendered inside dialog with the props passed to it -->
      <div v-if="component" :style="`max-height: ${height || 400}px; overflow-y: auto`" class="flex-grow-1 px-4 py-2">
        <component
          :is="component"
          ref="content"
          v-bind="componentProps"
          v-on="componentEvents"
          @progress-show="progress = true"
          @progress-hide="progress = false"
          @action-enabled="enabled => (actionEnabled = enabled)"
          @close="onClose"
        />
      </div>
      <v-card-actions class="px-4 pb-4">
        <v-spacer />
        <template v-if="buttons">
          <u-btn
            v-for="button in buttons"
            :key="button.name"
            :small="false"
            :text="button.text"
            @click="onButtonClick(button.handler)"
          >
            {{ button.name }}
          </u-btn>
        </template>
        <template v-else>
          <u-btn :small="false" text :min-width="80" class="px-4 mr-2" @click="onClose" @keydown.enter.stop>
            {{ cancelLabel || $t('cancel') }}
          </u-btn>
          <u-btn
            :disabled="!actionEnabled"
            :small="false"
            :min-width="80"
            class="px-4"
            elevation="0"
            @click="onAction"
            @keydown.enter.stop
          >
            {{ actionLabel || $t('ok') }}
          </u-btn>
        </template>
      </v-card-actions>
      <v-overlay v-if="progress" absolute>
        <v-progress-circular indeterminate color="primary" />
      </v-overlay>
    </v-card>
  </v-dialog>
</template>

<script>
  import {
    VDialog,
    VCard,
    VCardTitle,
    VSpacer,
    VBtn,
    VIcon,
    VCardActions,
    VOverlay,
    VProgressCircular,
  } from 'vuetify/lib'

  export default {
    components: { VDialog, VCard, VCardTitle, VSpacer, VBtn, VIcon, VCardActions, VOverlay, VProgressCircular },
    data() {
      return {
        title: null,
        component: null,
        componentProps: null,
        componentEvents: null,
        buttons: null,
        actionLabel: null,
        cancelLabel: null,
        width: null,
        height: null,
        progress: false,
        actionEnabled: true,
        edge: false, // whether to use the `dialog-edge` class defined in style below
      }
    },
    computed: {
      // returns a boolean showing/hiding the dialog if component is set
      displayDialog() {
        return this.component !== null
      },
    },
    created() {
      this.$vuntangle.vm.$on('show-dialog', this.show)
    },

    methods: {
      show(options) {
        Object.assign(this, { ...options })
      },
      /**
       * Hides and resets the dialog data
       */
      onClose() {
        this.$emit('close') // this notifies dialog opener about closing

        this.title = null
        this.component = null
        this.componentProps = null
        this.buttons = null
        this.cancelLabel = null
        this.actionLabel = null
        this.width = null
        this.progress = false
        this.edge = null

        this.$off('close')
      },

      onAction() {
        if (!this.actionEnabled) return
        // the inner content component must implement "action" method
        this.$refs.content.action()
      },
      onButtonClick(handler) {
        // bind 'this' to this component, can use arrow function to get the caller 'this'
        const bindThis = handler.bind(this)
        bindThis()
      },
    },
  }
</script>

<style lang="scss">
  // show a 90% visible height of the window height
  .dialog-edge {
    height: 90vh;
  }
</style>
