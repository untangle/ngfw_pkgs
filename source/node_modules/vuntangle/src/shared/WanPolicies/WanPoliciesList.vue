<template>
  <v-container>
    <div class="d-flex align-center">
      <h1 v-if="classicView" class="headline">{{ $vuntangle.$t('wan_policies') }}</h1>
      <h2 v-else class="font-weight-light">{{ $vuntangle.$t('wan_policies') }}</h2>
      <v-spacer />
      <slot name="actions" :updated-policies="policiesCopy"> </slot>
    </div>
    <v-divider class="my-2" />
    <p class="body-2 my-4">
      {{ $vuntangle.$t('wan_policies_description') }}
    </p>

    <v-card outlined>
      <v-row dense class="d-flex flex-grow-0 mx-2 my-1" align="center">
        <v-col cols="3"><u-text-field v-model="filter" :label="$vuntangle.$t('filter')" /></v-col>
        <v-col>
          <div class="d-flex caption align-center">
            <u-btn
              v-if="localFilteredPolicies.length + etmFilteredPolicies.length < policiesCopy.length"
              :small="false"
              :min-width="null"
              outlined
              @click="clearFilter"
            >
              {{ $vuntangle.$t('clear') }}
            </u-btn>
            <v-spacer />
            {{
              $vuntangle.$t('showing_filtered_rules', [
                localFilteredPolicies.length + etmFilteredPolicies.length,
                policiesCopy.length,
              ])
            }}
          </div>
        </v-col>
      </v-row>

      <v-divider />

      <v-simple-table fixed-header>
        <thead>
          <tr>
            <th style="width: 25%">{{ $vuntangle.$t('description') }}</th>
            <th style="width: 25%">{{ $vuntangle.$t('type') }}</th>
            <th>{{ $vuntangle.$t('interfaces') }}</th>
            <th style="width: 120px" class="text-center">{{ $vuntangle.$t('wan_criteria') }}</th>
            <th style="width: 120px"></th>
          </tr>
        </thead>

        <!-- show no policies -->
        <tbody v-if="!policiesCopy.length">
          <tr>
            <td colspan="6" class="text-center">
              <br /><br />
              <span>{{ $vuntangle.$t('no_policies_defined') }}</span>
              <br /><br /><br />
            </td>
          </tr>
        </tbody>

        <!-- show no filter -->
        <tbody v-if="policiesCopy.length > 0 && !localFilteredPolicies.length && !etmFilteredPolicies.length">
          <tr>
            <td colspan="6" class="text-center">
              <br /><br />
              <span>{{ $vuntangle.$t('no_policy_meets_filter') }}</span>
              <br /><br />
              <u-btn outlined @click="clearFilter">{{ $vuntangle.$t('clear_filters') }}</u-btn>
              <br /><br /><br />
            </td>
          </tr>
        </tbody>

        <tbody v-if="etmFilteredPolicies.length">
          <tr>
            <td colspan="6" class="font-weight-bold body-1" style="background: rgba(200, 200, 200, 0.2)">
              {{ $vuntangle.$t('etm_defined_policies') }}
            </td>
          </tr>
          <tr v-for="policy in etmFilteredPolicies" :key="policy.policyId">
            <td class="font-weight-bold">{{ policy.description }}</td>
            <td v-html="policyTypeCellRenderer(policy)"></td>
            <td v-html="interfacesRenderer(policy.interfaces)"></td>
            <td class="text-center">
              <v-tooltip
                v-if="policy.criteria && policy.criteria.length"
                left
                transition="fade"
                color="primary"
                min-width="300"
              >
                <template #activator="{ on, attrs }">
                  <v-icon color="primary" dark v-bind="attrs" v-on="on"> mdi-information </v-icon>
                </template>
                <div class="py-2" v-html="criteriaRenderer(policy.criteria)"></div>
              </v-tooltip>
            </td>
            <td></td>
          </tr>
          <tr></tr>
        </tbody>

        <tbody v-if="localFilteredPolicies.length">
          <tr>
            <td colspan="6" class="font-weight-bold body-1" style="background: rgba(200, 200, 200, 0.2)">
              {{ $vuntangle.$t('local_defined_policies') }}
            </td>
          </tr>
          <tr v-for="policy in localFilteredPolicies" :key="policy.policyId">
            <td class="font-weight-bold">{{ policy.description }}</td>
            <td v-html="policyTypeCellRenderer(policy)"></td>
            <td v-html="interfacesRenderer(policy.interfaces)"></td>
            <td class="text-center">
              <v-tooltip
                v-if="policy.criteria && policy.criteria.length"
                left
                transition="fade"
                color="primary"
                min-width="300"
              >
                <template #activator="{ on, attrs }">
                  <v-icon color="primary" dark v-bind="attrs" v-on="on"> mdi-information </v-icon>
                </template>
                <div class="py-2" v-html="criteriaRenderer(policy.criteria)"></div>
              </v-tooltip>
            </td>
            <td class="row-actions text-right">
              <v-btn
                v-if="!policy.readOnly"
                icon
                dense
                :disabled="disabled"
                @click="$emit('edit-policy', policy.policyId)"
              >
                <v-icon>mdi-pencil</v-icon>
              </v-btn>
              <v-btn v-if="!policy.readOnly" icon dense :disabled="disabled" @click="onDeletePolicy(policy.policyId)">
                <v-icon>mdi-close</v-icon>
              </v-btn>
            </td>
          </tr>
        </tbody>
      </v-simple-table>
    </v-card>
  </v-container>
</template>
<script>
  import { VContainer, VSpacer, VDivider, VCard, VRow, VCol, VSimpleTable, VTooltip, VIcon, VBtn } from 'vuetify/lib'
  import cloneDeep from 'lodash/cloneDeep'
  import { policyTypes, policyBestOfMetrics, policyBalanceAlgorithms } from './data/options'

  export default {
    components: {
      VContainer,
      VSpacer,
      VDivider,
      VCard,
      VRow,
      VCol,
      VSimpleTable,
      VTooltip,
      VIcon,
      VBtn,
    },
    props: {
      policies: { type: Array, default: () => [] },
      wans: { type: Array, default: () => [] },
      classicView: { type: Boolean, default: false },
      disabled: { type: Boolean, default: false },
    },
    data: () => ({
      policiesCopy: [],
      filter: undefined,
    }),
    computed: {
      etmPolicies: ({ policiesCopy }) => policiesCopy.filter(policy => policy.createdBy === 'CommandCenter'),
      localPolicies: ({ policiesCopy }) => policiesCopy.filter(policy => !policy.createdBy),
      etmFilteredPolicies: ({ etmPolicies, policyFilter }) => etmPolicies.filter(policyFilter),
      localFilteredPolicies: ({ localPolicies, policyFilter }) => localPolicies.filter(policyFilter),
    },
    watch: {
      policies: {
        immediate: true,
        deep: true,
        handler(value) {
          this.policiesCopy = cloneDeep(value)
        },
      },
    },
    methods: {
      policyFilter(policy) {
        if (this.filter && !policy.description.toLowerCase().includes(this.filter.toLowerCase())) return false
        return true
      },

      clearFilter() {
        this.filter = undefined
      },

      /**
       * confirmation dialog when deleting a policy
       */
      onDeletePolicy(id) {
        const policy = this.policies.find(policy => policy.policyId === id)
        if (!policy) return
        this.$vuntangle.confirm.show({
          title: `<i class="mdi mdi-alert" style="font-style: normal;"> ${this.$vuntangle.$t('confirm')}</i>`,
          message: this.$vuntangle.$t('remove_policy', [policy.description]),
          confirmLabel: this.$vuntangle.$t('yes'),
          cancelLabel: this.$vuntangle.$t('no'),
          action: async resolve => {
            await this.$emit('delete-policy', id)
            resolve()
          },
        })
      },

      policyTypeCellRenderer(policy) {
        if (policy.type === 'SPECIFIC_WAN') {
          return `<strong>${this.$vuntangle.$t('specific_wan')}</strong>`
        }
        if (policy.type === 'BEST_OF') {
          return `<strong>${this.$vuntangle.$t('best_wan_with')}</strong>
          ${this.$vuntangle.$t(policyBestOfMetrics[policy.best_of_metric])}`
        }
        if (policy.type === 'BALANCE') {
          return `<strong>${this.$vuntangle.$t(policyTypes[policy.type])}</strong>
          ${this.$vuntangle.$t(policyBalanceAlgorithms[policy.balance_algorithm])}`
        }
      },

      interfacesRenderer(interfaces) {
        if (interfaces.length === 1 && interfaces[0].interfaceId === 0) {
          return `<strong>${this.$vuntangle.$t('all_wans')}</strong>`
        }
        const selected = []
        interfaces.forEach(intf => {
          const wan = this.wans.find(wan => wan.interfaceId === intf.interfaceId)
          if (!wan) return
          if (intf.weight) {
            selected.push(`<strong>${wan.name}</strong> (${this.computePercent(interfaces, intf.weight)}%)`)
          } else {
            selected.push(`<strong>${wan.name}</strong>`)
          }
        })
        return selected.join(', ')
      },

      criteriaRenderer(criteria) {
        if (!criteria.length) return
        const list = []
        criteria.forEach(crt => {
          if (crt.type === 'ALWAYS_UP') {
            list.push(`<strong>${this.$vuntangle.$t('always_up')}</strong>`)
          }
          if (crt.type === 'ATTRIBUTE') {
            if (crt.attribute === 'VPN') list.push(`<strong>${this.$vuntangle.$t('is_vpn')}</strong>`)
            if (crt.attribute === 'NAME')
              list.push(`<strong>${this.$vuntangle.$t('name_contains')}</strong>: &ldquo;${crt.name_contains}&rdquo;`)
          }
          if (crt.type === 'METRIC') {
            let unit = this.$vuntangle.$t('milliseconds')
            if (crt.metric === 'AVAILABLE_BANDWIDTH') unit = '%'
            if (crt.metric === 'PACKET_LOSS') unit = '%'

            list.push(
              `<strong>${this.$vuntangle.$t(crt.metric.toLowerCase())}</strong> ${crt.metric_op} ${
                crt.metric_value
              } ${unit}`,
            )
          }
          if (crt.type === 'CONNECTIVITY') {
            list.push(`<strong>${crt.connectivityTestType}</strong>: ${crt.connectivityTestTarget}`)
          }
        })
        return list.join('<br/>')
      },

      /**
       * used for showing a percentage corresponding to each wan weight
       */
      computePercent(interfaces, weight) {
        let totalWeight = 0
        interfaces.forEach(intf => {
          totalWeight += intf.weight
        })
        return ((weight / totalWeight) * 100).toFixed(2)
      },
    },
  }
</script>
