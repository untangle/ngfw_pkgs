<template>
  <v-row dense>
    <v-col cols="3">
      <ValidationProvider v-slot="{ errors }" rules="required">
        <u-select
          v-model="criteriaType"
          :items="criteriaTypeOptions"
          :label="$vuntangle.$t(criteriaTypes[criteriaCopy.type] || 'policy_select_criteria_type')"
          :error-messages="errors"
        >
          <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
        </u-select>
      </ValidationProvider>
    </v-col>
    <v-col v-if="criteriaCopy.attribute === 'NAME'">
      <ValidationProvider v-slot="{ errors }" rules="required">
        <u-text-field
          v-model="criteriaCopy.name_contains"
          :error-messages="errors"
          :label="$vuntangle.$t('enter_value')"
        >
          <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
        </u-text-field>
      </ValidationProvider>
    </v-col>
    <v-col v-if="criteriaCopy.type === 'METRIC'" cols="2">
      <ValidationProvider v-slot="{ errors }" rules="required">
        <u-select v-model="criteriaCopy.metric_op" :items="metricOperatorOptions" :error-messages="errors">
          <template #selection="{ item }">{{ $vuntangle.$t(item.text) }}</template>
          <template #item="{ item }">{{ $vuntangle.$t(item.text) }}</template>
          <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
        </u-select>
      </ValidationProvider>
    </v-col>
    <v-col v-if="criteriaCopy.type === 'METRIC'">
      <ValidationProvider v-slot="{ errors }" :rules="metricValueRules">
        <u-text-field
          v-model="criteriaCopy.metric_value"
          :suffix="$vuntangle.$t(metricValueSuffix).toLowerCase()"
          :label="$vuntangle.$t('enter_value')"
          :error-messages="errors"
        >
          <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
        </u-text-field>
      </ValidationProvider>
    </v-col>
    <v-col v-if="criteriaCopy.type === 'CONNECTIVITY'" cols="6" md="3" lg="2">
      <ValidationProvider v-slot="{ errors }" rules="required|integer|min_value:1">
        <u-text-field
          v-model="criteriaCopy.connectivityTestInterval"
          :suffix="$vuntangle.$t('seconds').toLowerCase()"
          :label="$vuntangle.$t('interval')"
          :error-messages="errors"
        >
          <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
        </u-text-field>
      </ValidationProvider>
    </v-col>
    <v-col v-if="criteriaCopy.type === 'CONNECTIVITY'" cols="6" md="3" lg="2">
      <ValidationProvider v-slot="{ errors }" rules="required|integer|min_value:1">
        <u-text-field
          v-model="criteriaCopy.connectivityTestTimeout"
          :suffix="$vuntangle.$t('seconds').toLowerCase()"
          :label="$vuntangle.$t('timeout_seconds')"
          :error-messages="errors"
        >
          <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
        </u-text-field>
      </ValidationProvider>
    </v-col>
    <v-col v-if="criteriaCopy.type === 'CONNECTIVITY'" cols="2">
      <ValidationProvider v-slot="{ errors }" rules="required">
        <u-select
          v-model="criteriaCopy.connectivityTestFailureThreshold"
          :items="failureThresholdOptions"
          :label="$vuntangle.$t('failure_threshold')"
          :error-messages="errors"
        >
          <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
        </u-select>
      </ValidationProvider>
    </v-col>
    <v-col v-if="criteriaCopy.type === 'CONNECTIVITY'">
      <ValidationProvider v-slot="{ errors }" rules="required|ip">
        <u-text-field
          v-model="criteriaCopy.connectivityTestTarget"
          :label="$vuntangle.$t('target')"
          :placeholder="$vuntangle.$t('host_address_to_test')"
          :error-messages="errors"
        >
          <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
        </u-text-field>
      </ValidationProvider>
    </v-col>
  </v-row>
</template>
<script>
  import { VRow, VCol } from 'vuetify/lib'
  import { ValidationProvider } from 'vee-validate'
  import cloneDeep from 'lodash/cloneDeep'
  import { criteriaTypes, metricOperatorOptions } from './data/options'

  export default {
    components: { VRow, VCol, ValidationProvider },
    props: {
      criteria: { type: Object, default: () => {} },
    },
    data() {
      return {
        criteriaCopy: null,
        criteriaTypes,
        metricOperatorOptions,
        failureThresholdOptions: Array.from({ length: 10 }, (_, i) => i + 1).map(i => ({
          text: this.$tc('failures', i, [i]),
          value: i,
        })),
      }
    },
    computed: {
      /**
       * placed in computed so header items can also be translated
       */
      criteriaTypeOptions() {
        return [
          { text: this.$vuntangle.$t('always_up'), value: 'ALWAYS_UP' },
          { divider: true },
          { header: this.$vuntangle.$t('attribute') },
          { text: this.$vuntangle.$t('is_vpn'), value: 'VPN' },
          { text: this.$vuntangle.$t('name_contains'), value: 'NAME' },
          { divider: true },
          { header: this.$vuntangle.$t('metric') },
          { text: this.$vuntangle.$t('latency'), value: 'LATENCY' },
          { text: this.$vuntangle.$t('available_bandwidth'), value: 'AVAILABLE_BANDWIDTH' },
          { text: this.$vuntangle.$t('jitter'), value: 'JITTER' },
          { text: this.$vuntangle.$t('packet_loss'), value: 'PACKET_LOSS' },
          { divider: true },
          { header: this.$vuntangle.$t('connectivity_test') },
          { text: 'PING', value: 'PING' },
          { text: 'ARP', value: 'ARP' },
          { text: 'DNS', value: 'DNS' },
          { text: 'HTTP', value: 'HTTP' },
        ]
      },

      criteriaType: {
        get: ({ criteriaCopy }) => {
          if (criteriaCopy.type === 'ALWAYS_UP') return criteriaCopy.type
          if (criteriaCopy.type === 'ATTRIBUTE') return criteriaCopy.attribute
          if (criteriaCopy.type === 'METRIC') return criteriaCopy.metric
          if (criteriaCopy.type === 'CONNECTIVITY') return criteriaCopy.connectivityTestType
        },
        set(value) {
          switch (value) {
            case 'ALWAYS_UP':
              this.criteriaCopy = {
                type: 'ALWAYS_UP',
              }
              break
            case 'VPN':
            case 'NAME':
              this.criteriaCopy = {
                type: 'ATTRIBUTE',
                attribute: value,
              }
              break
            case 'LATENCY':
            case 'AVAILABLE_BANDWIDTH':
            case 'JITTER':
            case 'PACKET_LOSS':
              this.criteriaCopy = {
                type: 'METRIC',
                metric_op: '<=',
                metric: value,
              }
              break
            case 'PING':
            case 'ARP':
            case 'DNS':
            case 'HTTP':
              if (this.criteriaCopy.type !== 'CONNECTIVITY') {
                this.criteriaCopy = {
                  type: 'CONNECTIVITY',
                  connectivityTestType: value,
                }
              } else {
                this.criteriaCopy.connectivityTestType = value
              }
          }
        },
      },

      metricValueSuffix: ({ criteriaCopy }) => {
        switch (criteriaCopy.metric) {
          case 'JITTER':
          case 'LATENCY':
            return 'milliseconds'
          case 'AVAILABLE_BANDWIDTH':
            return 'percent'
          case 'PACKET_LOSS':
            return 'percent'
        }
      },

      metricValueRules: ({ criteriaCopy }) => {
        switch (criteriaCopy.metric) {
          case 'JITTER':
          case 'LATENCY':
            return 'required|integer|min_value:1'
          case 'AVAILABLE_BANDWIDTH':
            return 'required|integer|min_value:1|max_value:100'
          case 'PACKET_LOSS':
            return 'required|integer|min_value:1|max_value:100'
        }
      },
    },
    watch: {
      criteria: {
        handler(newCriteria, oldCriteria) {
          if (JSON.stringify(newCriteria) === JSON.stringify(oldCriteria)) return
          this.criteriaCopy = cloneDeep(newCriteria)
        },
        immediate: true,
      },
      criteriaCopy: {
        handler(criteria) {
          this.$emit('update:criteria', criteria)
        },
        deep: true,
      },
    },
  }
</script>
