<template>
  <v-container fluid :class="`${classicView ? 'pa-4 ' : ''}shared-cmp ${disabled ? 'disabled' : ''}`">
    <div class="d-flex align-center">
      <h2 class="font-weight-light">{{ $vuntangle.$t('denial_of_service_prevention') }}</h2>
      <v-spacer />
      <slot name="actions" :new-settings="settingsCopy" :is-dirty="isDirty" :defaults="$options.defaults"></slot>
    </div>
    <v-divider class="my-2" />

    <div v-if="!!$slots['extra-fields']">
      <slot name="extra-fields" />
    </div>

    <div>
      <v-switch
        v-model="settingsCopy.enabled"
        :disabled="disabled"
        class="body-2 mb-4"
        dense
        inset
        hide-details
        :label="$t('denial_of_service_toggle', [settingsCopy.enabled ? $t('enabled') : $t('disabled')])"
      />
    </div>

    <h3>{{ $vuntangle.$t('session_limits') }}</h3>
    <p>{{ $vuntangle.$t('session_limits_description') }}</p>

    <ValidationObserver ref="obs">
      <v-card flat class="mt-0">
        <table>
          <thead>
            <tr>
              <th></th>
              <th>{{ $vuntangle.$t('tcp_sessions') }}</th>
              <th>{{ $vuntangle.$t('udp_sessions') }}</th>
              <th>{{ $vuntangle.$t('icmp_sessions') }}</th>
              <th>{{ $vuntangle.$t('all_sessions') }}</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="limit in limits" :key="limit.key">
              <td class="pr-4">{{ $vuntangle.$t(limit.key) }}</td>
              <td v-for="field in limit.fields" :key="field" class="pa-1">
                <ValidationProvider v-slot="{ errors }" rules="numeric|integer|min_value: 0|max_value: 100000">
                  <u-text-field
                    v-if="field"
                    v-model.number="settingsCopy[field]"
                    :error-messages="errors"
                    :placeholder="$options.defaults[field].toString()"
                    style="max-width: 140px"
                  >
                    <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
                  </u-text-field>
                </ValidationProvider>
              </td>
            </tr>
          </tbody>
        </table>
      </v-card>

      <h3 class="mt-8">{{ $vuntangle.$t('block_actions') }}</h3>
      <div class="d-flex align-center">
        <span>{{ $vuntangle.$t('block_duration') }}</span>
        <!-- max block duration set to 1 day -->
        <ValidationProvider v-slot="{ errors }" rules="numeric|integer|min_value: 0|max_value: 86400">
          <u-text-field
            v-model.number="settingsCopy.block_duration"
            class="mx-4"
            :error-messages="errors"
            :suffix="$vuntangle.$t('seconds')"
            :placeholder="$options.defaults.block_duration.toString()"
            style="max-width: 200px"
          >
            <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
          </u-text-field>
        </ValidationProvider>
        <u-checkbox v-model="settingsCopy.remove_active_sessions" :label="$vuntangle.$t('remove_active_sessions')" />
      </div>
    </ValidationObserver>
  </v-container>
</template>
<script>
  import { VContainer, VSpacer, VSwitch, VCard } from 'vuetify/lib'
  import settingsMixin from '../settingsMixin'
  import defaults from './defaults'

  export default {
    components: { VContainer, VSpacer, VSwitch, VCard },
    mixins: [settingsMixin],
    defaults,

    data() {
      return {
        limits: [
          {
            key: 'source_host_max_sessions',
            fields: [
              'source_sessions_max_tcp',
              'source_sessions_max_udp',
              'source_sessions_max_icmp',
              'source_sessions_max_all',
            ],
          },
          {
            key: 'destination_host_max_sessions',
            fields: [
              'dest_sessions_max_tcp',
              'dest_sessions_max_udp',
              'dest_sessions_max_icmp',
              'dest_sessions_max_all',
            ],
          },
          // hide New sessions per second according to CD-5951
          // {
          //   key: 'new_sessions_per_second_one_host',
          //   fields: ['new_sessions_per_second_tcp', 'new_sessions_per_second_udp', 'new_sessions_per_second_icmp'],
          // },
        ],
      }
    },
    methods: {
      // method called from parent component upon save to validate input data
      async validate() {
        const isValid = await this.$refs.obs.validate()
        return isValid
      },
    },
  }
</script>
