<template>
  <v-container
    :fluid="classicView ? true : false"
    :class="`${classicView ? 'pa-4 ' : ''}shared-cmp ${disabled ? 'disabled ' : ''}d-flex flex-column flex-grow-1`"
  >
    <div class="d-flex align-center">
      <h1 v-if="classicView" class="headline">{{ $t('threat_prevention') }}</h1>
      <h2 v-else class="font-weight-light">{{ $t('threat_prevention') }}</h2>
      <v-spacer />
      <!-- threat lookup button placed besides slot actions -->
      <u-btn
        v-if="!features.isTemplateView"
        :disabled="disabled || !settings.enabled"
        class="mx-2"
        @click="onThreatLookup"
      >
        {{ $t('threat_lookup') }}
      </u-btn>
      <slot name="actions" :new-settings="settingsCopy" :is-dirty="isDirty" :defaults="$options.defaults" />
    </div>

    <v-divider class="my-2" />
    <p v-html="$t('threat_prevention_description')" />
    <u-section v-if="!!$slots['extra-fields']">
      <slot name="extra-fields" />
    </u-section>
    <div class="d-flex flex-column flex-grow-1 body-2">
      <v-switch
        v-model="settingsCopy.enabled"
        class="body-2 mb-4"
        dense
        inset
        hide-details
        :disabled="disabled"
        :label="$t('toggle_threat_prevention', [settingsCopy.enabled ? $t('enabled') : $t('disabled')])"
      />
      {{ $t('blocked_traffic_assessed_as') }} {{ assessed }}

      <v-slider
        v-model="settingsCopy.sensitivity"
        class="flex-grow-0 body-2"
        min="20"
        max="60"
        step="20"
        color="#e51313"
        track-color="#e2e2e2"
        :disabled="disabled"
        :tick-labels="threatLevelLabels"
        style="width: 50%"
      />
      <v-switch
        v-model="settingsCopy.redirect"
        :disabled="disabled"
        class="body-2 mb-4"
        dense
        inset
        hide-details
        :label="
          $t('toggle_threat_prevention_redirect', [
            settingsCopy.redirect ? $t('enabled').toLowerCase() : $t('disabled').toLowerCase(),
          ])
        "
      />
      <div class="d-flex flex-1 align-center mb-2">
        <h2 class="font-weight-light">{{ $t('pass_list') }}</h2>
        <v-spacer />
        <u-btn :min-width="null" :disabled="disabled" @click="onEditHost(null)">{{ $t('add') }}</u-btn>
      </div>
      <v-card elevation="0" class="d-flex flex-grow-1">
        <u-grid
          id="threat-prevention-pass-list"
          :no-data-message="$t('no_data_defined_hostname')"
          :row-data="settingsCopy.passList"
          :column-defs="columnDefs"
          :enable-refresh="false"
        />
      </v-card>
    </div>

    <invalid-settings
      v-if="invalidSettingsErrors"
      service="Threat Prevention"
      :settings="settings"
      :schema="$options.schema"
      :errors.sync="invalidSettingsErrors"
    />
  </v-container>
</template>
<script>
  import { VContainer, VSpacer, VDivider, VSwitch, VSlider, VCard } from 'vuetify/lib'

  import settingsMixin from '../settingsMixin'
  import InvalidSettings from '../InvalidSettings/Main.vue'
  import defaults from './defaults'
  import schema from './schema'
  import HostDialog from './components/HostDialog.vue'
  import LookupDialog from './components/LookupDialog.vue'

  const actionButtonColumn = {
    width: 30,
    resizable: false,
    sortable: false,
    suppressMenu: true,
    cellRenderer: 'ActionButton',
  }

  export default {
    components: { VContainer, VSpacer, VDivider, VSwitch, VSlider, VCard, InvalidSettings },
    mixins: [settingsMixin],
    defaults,
    schema,

    computed: {
      // threat values
      threatLevels() {
        return { 20: this.$t('high_risk'), 40: this.$t('suspicious'), 60: this.$t('moderate_risk') }
      },
      // threat labels
      threatLevelLabels() {
        return Object.keys(this.threatLevels).map(threatLevel => this.threatLevels[threatLevel])
      },
      // threat assessed renderer
      assessed() {
        const assessed = []
        for (let i = 20; i <= this.settingsCopy.sensitivity; i += 20) {
          assessed.push(this.threatLevels[i])
        }

        // separate the list by an 'or'
        if (assessed.length <= 2) {
          return assessed.join(` ${this.$t('or')} `)
        }

        const [one, two, three] = assessed
        return `${one}, ${two} ${this.$t('or')} ${three}`
      },
      columnDefs() {
        return [
          {
            headerName: this.$t('network'),
            field: 'host',
            comparator: (a, b) => this.$vuntangle.util.compareIpAny(a, b),
          },
          { headerName: this.$t('description'), field: 'description' },
          {
            ...actionButtonColumn,
            cellRendererParams: {
              icon: 'mdi-pencil',
              small: true,
              click: ({ node }) => this.onEditHost(node.id),
            },
          },
          {
            ...actionButtonColumn,
            cellRendererParams: {
              icon: 'mdi-delete',
              small: true,
              click: ({ node }) => this.settingsCopy.passList.splice(node.id, 1),
            },
          },
        ]
      },
    },

    methods: {
      onThreatLookup() {
        const that = this
        this.$vuntangle.dialog.show({
          title: this.$t('threat_lookup'),
          component: LookupDialog,
          componentEvents: {
            async lookup(ip, resolve) {
              await that.$emit('lookup', ip, result => resolve(result))
            },
          },
          width: 600,
          buttons: [
            {
              name: this.$t('close'),
              handler() {
                this.onClose()
              },
            },
          ],
        })
      },

      /**
       * Add or edits passed host
       * @param {number} index - the record index being edited, if null record is added
       */
      onEditHost(index = null) {
        this.$vuntangle.dialog.show({
          title: index === null ? this.$t('add_host') : this.$t('edit_host'),
          component: HostDialog,
          width: 500,
          actionLabel: index === null ? this.$t('add') : this.$t('update'),
          componentProps: {
            settings: this.settingsCopy,
            index,
          },
        })
      },
    },
  }
</script>
