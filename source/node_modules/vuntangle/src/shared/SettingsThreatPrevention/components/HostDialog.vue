<template>
  <v-container class="px-0">
    <ValidationObserver ref="obs">
      <v-row>
        <v-col>
          <ValidationProvider v-slot="{ errors }" rules="required|ip">
            <u-text-field v-model="ipAddress" :label="$t('ip_address')" :error-messages="errors">
              <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
            </u-text-field>
          </ValidationProvider>
        </v-col>
        <v-col>
          <ValidationProvider v-slot="{ errors }" rules="required">
            <ipv-4-prefix-autocomplete v-model="netmask" :errors="errors" />
          </ValidationProvider>
        </v-col>
      </v-row>
      <v-row>
        <v-col>
          <ValidationProvider v-slot="{ errors }" rules="required">
            <u-text-field v-model="description" :label="$t('description')" :error-messages="errors">
              <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
            </u-text-field>
          </ValidationProvider>
        </v-col>
      </v-row>
    </ValidationObserver>
  </v-container>
</template>
<script>
  import { VContainer, VRow, VCol } from 'vuetify/lib'
  import { ValidationObserver, ValidationProvider } from 'vee-validate'
  import cloneDeep from 'lodash/cloneDeep'
  import Ipv4PrefixAutocomplete from '../../../components/Ipv4PrefixAutocomplete'

  export default {
    components: { VContainer, VRow, VCol, ValidationObserver, ValidationProvider, Ipv4PrefixAutocomplete },
    props: {
      settings: { type: Object, required: true },
      index: { type: Number, required: false, default: null },
    },
    data: () => ({
      ipAddress: '',
      netmask: 32,
      description: '',
    }),
    computed: {
      passList() {
        return this.settings.passList
      },
      existingHost() {
        if (this.index !== null && this.passList[this.index]) {
          return this.passList[this.index]
        }

        return null
      },
    },
    created() {
      // set host if editing
      if (this.existingHost) {
        // split host into ip/netmask
        const [ipAddress, netmask] = this.existingHost.host.split('/')

        this.ipAddress = ipAddress
        this.netmask = parseInt(netmask)
        this.description = this.existingHost.description
      }
    },
    methods: {
      async action() {
        const isValid = await this.$refs.obs.validate()
        if (!isValid) {
          return
        }

        // copy threat prevention (all data must be sent) from store and add/update the host
        const settings = cloneDeep(this.settings)
        const host = { description: this.description, host: `${this.ipAddress.trim()}/${this.netmask}` }
        if (this.existingHost) {
          settings.passList[this.index] = host
        } else {
          settings.passList.push(host)
        }
        this.$set(this.settings, 'passList', settings.passList)
        this.$emit('close')
      },
    },
  }
</script>
