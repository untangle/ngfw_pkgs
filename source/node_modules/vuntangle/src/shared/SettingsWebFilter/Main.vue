<template>
  <v-container
    :fluid="classicView ? true : false"
    :class="`${classicView ? 'pa-4 ' : ''}shared-cmp ${disabled ? 'disabled' : ''}`"
  >
    <div class="d-flex align-center">
      <h1 v-if="classicView" class="headline">{{ $t('web_filter') }}</h1>
      <h2 v-else class="font-weight-light">{{ $t('web_filter') }}</h2>
      <v-spacer />
      <slot name="actions" :new-settings="settingsCopy" :is-dirty="isDirty" :defaults="$options.defaults" />
    </div>
    <v-divider class="my-2" />
    <p v-html="$t('web_filter_description')" />
    <u-section v-if="!!$slots['extra-fields']">
      <slot name="extra-fields" />
    </u-section>
    <component :is="!$slots['extra-fields'] ? 'div' : 'u-section'">
      <div class="body-2 mt-4">
        <!-- Enable/Disable toggle -->
        <div class="d-flex">
          <v-switch
            v-model="settingsCopy.enabled"
            :disabled="disabled"
            class="body-2 my-2 pt-0"
            dense
            inset
            hide-details
            :label="$t('toggle_web_filter', [settingsCopy.enabled ? $t('enabled') : $t('disabled')])"
          />
        </div>
      </div>

      <!-- Tabs -->
      <v-card :disabled="disabled" flat color="transparent">
        <div class="d-flex flex-row align-center my-4">
          <v-divider />
          <v-btn-toggle v-model="selectedTab" dense rounded mandatory>
            <v-btn
              v-for="tab in tabs"
              :key="tab"
              :value="tab"
              :class="`${tab === selectedTab ? 'white--text' : ''} font-weight-bold px-8`"
              active-class="primary"
              :disabled="tab === 'site_lookup' && !settings.enabled"
              min-width="150"
            >
              {{ $t(tab) }}
            </v-btn>
          </v-btn-toggle>
          <v-divider />
        </div>

        <!-- Tabs content -->
        <v-tabs-items v-model="selectedTab" style="overflow: visible; background-color: transparent">
          <v-tab-item value="categories" :transition="false" :reverse-transition="false">
            <h3>{{ $vuntangle.$t('categories') }}</h3>
            <p>{{ $vuntangle.$t('categories_description') }}</p>
            <u-list-group :items="allCategories" :selected-items.sync="settingsCopy.categories"></u-list-group>
          </v-tab-item>
          <v-tab-item value="block_sites" :transition="false" :reverse-transition="false">
            <sites :list.sync="settingsCopy.blockList" type="block" />
          </v-tab-item>
          <v-tab-item value="pass_sites" :transition="false" :reverse-transition="false">
            <sites :list.sync="settingsCopy.passList" type="pass" />
          </v-tab-item>
          <v-tab-item value="site_lookup" :transition="false" :reverse-transition="false">
            <site-lookup :settings="settingsCopy" :selected-tab="selectedTab" @lookup="$emit('lookup', $event)" />
          </v-tab-item>
        </v-tabs-items>
      </v-card>
    </component>
    <invalid-settings
      v-if="invalidSettingsErrors"
      service="Web Filter"
      :settings="settings"
      :schema="$options.schema"
      :errors.sync="invalidSettingsErrors"
    />
  </v-container>
</template>
<script>
  import { VContainer, VSpacer, VDivider, VSwitch, VBtnToggle, VCard, VTabItem, VTabsItems } from 'vuetify/lib'
  import cloneDeep from 'lodash/cloneDeep'

  import { UListGroup } from '../../components'
  import settingsMixin from '../settingsMixin'
  import InvalidSettings from '../InvalidSettings/Main.vue'
  import categoriesDefs from './categories.json'
  import defaults from './defaults'
  import schema from './schema'
  import Sites from './components/Sites.vue'
  import SiteLookup from './components/SiteLookup.vue'

  export default {
    components: {
      VContainer,
      VSpacer,
      VDivider,
      VSwitch,
      VCard,
      VBtnToggle,
      VTabItem,
      VTabsItems,

      UListGroup,
      Sites,
      SiteLookup,
      InvalidSettings,
    },
    mixins: [settingsMixin],
    defaults,
    schema,

    data() {
      return {
        selectedTab: 'categories', // current selected tab
      }
    },
    computed: {
      tabs() {
        return ['categories', 'block_sites', 'pass_sites', ...(!this.features.isTemplateView ? ['site_lookup'] : [])]
      },
      // returns all categories sorted by translated name
      allCategories() {
        return cloneDeep(categoriesDefs).sort((a, b) => {
          return this.$vuntangle.$t(a.name).localeCompare(this.$vuntangle.$t(b.name))
        })
      },
    },
  }
</script>
