<template>
  <div>
    <h3 class="d-flex">
      <span>{{ type === 'block' ? $t('block_sites') : $t('pass_sites') }}</span>
      <v-spacer />
      <u-btn :min-width="null" @click="siteDialog(null)">{{ $t('add_site') }}</u-btn>
    </h3>

    <p>{{ type === 'block' ? $t('block_sites_description') : $t('pass_sites_description') }}</p>

    <!-- search filter for sites -->
    <div class="d-flex mb-4">
      <u-text-field v-model="filterTerm" :placeholder="$t('filter_sites')" clearable class="flex-grow-1" />
    </div>

    <template v-if="filteredSites.length">
      <div v-for="(site, idx) in filteredSites" :key="idx" class="d-flex align-start">
        <div class="d-flex">
          <v-checkbox
            v-model="site.enabled"
            dense
            class="mt-0 mr-4"
            hide-details
            :label="type === 'block' ? $t('block') : $t('pass')"
            :color="type === 'block' ? 'red' : 'aristaBlue'"
            @change="toggleFlag($event, idx, 'enabled')"
          />
          <v-checkbox
            v-model="site.flagged"
            dense
            class="mt-0"
            hide-details
            :label="$t('flag')"
            :disabled="site.enabled && type === 'block'"
            @change="toggleFlag($event, idx, 'flagged')"
          />
        </div>
        <div class="mx-6 mt-1">
          <h4
            v-html="
              `${$options.filters.highlight($t(site.name), filterTerm)}
               ${site.exact ? '<span class=\'font-weight-light\'>(' + $t('exact_match') + ')</span>' : ''}`
            "
          />
          <p
            class="body-2"
            style="line-height: 1.2"
            v-html="$options.filters.highlight($t(site.description), filterTerm)"
          />
        </div>
        <v-spacer />
        <div class="d-flex align-center">
          <!-- <v-checkbox v-model="site.exact" dense class="mr-8 pa-0" hide-details :label="$t('exact_match')" /> -->
          <u-btn icon :min-width="null" :small="false" class="mr-2" @click="siteDialog(site)">
            <v-icon dense>mdi-pencil</v-icon>
          </u-btn>
          <u-btn icon :min-width="null" :small="false" color="red" @click="siteRemove(site)">
            <v-icon>mdi-delete</v-icon>
          </u-btn>
        </div>
      </div>
    </template>
    <template v-else-if="listCopy.length">
      <div class="text-center">
        <p class="body-1 mt-12"><v-icon dense class="mr-2">mdi-information</v-icon>{{ $t('no_sites') }}</p>
        <u-btn @click="filterTerm = null">{{ $t('clear_filters') }}</u-btn>
      </div>
    </template>
    <template v-else>
      <div class="text-center">
        <p class="body-1 mt-12"><v-icon dense class="mr-2">mdi-information</v-icon>{{ $t('no_sites') }}</p>
      </div>
    </template>
  </div>
</template>
<script>
  import { VSpacer, VIcon, VCheckbox } from 'vuetify/lib'
  import cloneDeep from 'lodash/cloneDeep'
  import SiteDialog from './SiteDialog.vue'

  export default {
    components: { VSpacer, VIcon, VCheckbox },
    props: {
      // the sync list of sites passed from `main`
      list: { type: Array, default: () => [] },
      // denotes `block` or `pass` list type
      type: { type: String, default: 'block' },
    },
    data() {
      return {
        filterTerm: null,
        listCopy: null,
      }
    },

    computed: {
      // returns all or filtered sites based on filter term
      filteredSites() {
        const list = this.listCopy
        if (this.filterTerm) {
          return this.list.filter(site => {
            return (
              site.name?.toLowerCase().includes(this.filterTerm?.toLowerCase()) ||
              site.description?.toLowerCase().includes(this.filterTerm?.toLowerCase())
            )
          })
        }
        return list
      },
    },

    watch: {
      // updates the list in `main`
      list: {
        immediate: true,
        deep: true,
        handler(value) {
          this.listCopy = cloneDeep(value)
        },
      },
    },

    methods: {
      toggleFlag(value, idx, type) {
        const list = cloneDeep(this.list)
        list[idx][type] = value || false
        if (type === 'enabled' && value) {
          list[idx].flagged = value
        }
        this.$emit('update:list', list)
      },

      siteDialog(site) {
        const index = this.list.findIndex(s => s.name === site?.name)
        this.$vuntangle.dialog.show({
          title: this.type === 'block' ? this.$t('block_site') : this.$t('pass_site'),
          component: SiteDialog,
          componentProps: {
            list: this.list,
            type: this.type,
            index,
          },
          width: 600,
        })
      },

      siteRemove(site) {
        const index = this.list.findIndex(s => s.name === site?.name)
        this.listCopy.splice(index, 1)
        this.$emit('update:list', this.listCopy)
      },
    },
  }
</script>
