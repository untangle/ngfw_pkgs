<template>
  <div>
    <h3>{{ $t('site_lookup') }}</h3>
    <p>{{ $t('site_lookup_description') }}</p>

    <v-row no-gutters>
      <v-col>
        <u-text-field
          v-model="site"
          :disabled="!settings.enabled"
          :label="$t('enter_site_domain')"
          clearable
          @keyup.enter="onLookup"
        />
      </v-col>
      <v-col class="shrink">
        <u-btn :disabled="!site || !settings.enabled" :loading="loading" height="40" class="ml-4" @click="onLookup">
          {{ $t('lookup') }}
        </u-btn>
      </v-col>
    </v-row>

    <div v-if="site && matchedCategories" class="mt-4">
      <u-alert v-if="!matchedCategories.length" class="mt-4">
        {{ $t('no_matched_categories') }}
      </u-alert>

      <template v-else>
        <div>{{ $t('category_match') }}</div>
        <v-divider class="my-2" />

        <div v-for="(mCat, idx) in matchedCategories" :key="idx">
          <strong>{{ $t(mCat.def.name) }}</strong> ({{ $t(mCat.def.category) }})
          <template v-if="mCat.settings">
            <v-chip
              v-if="mCat.settings.enabled"
              x-small
              color="red"
              class="white--text text-uppercase font-weight-bold mx-2"
            >
              {{ $t('blocked') }}
            </v-chip>
            <v-chip
              v-if="mCat.settings.flagged"
              x-small
              color="blue"
              class="white--text text-uppercase font-weight-bold"
            >
              {{ $t('flagged') }}
            </v-chip>
          </template>
          <p class="body-2" style="line-height: 1.2">{{ $t(mCat.def.description) }}</p>
        </div>
      </template>
    </div>

    <u-alert v-if="lookupError" error class="mt-4">
      {{ $t(lookupError) }}
    </u-alert>
  </div>
</template>
<script>
  import { VRow, VCol, VDivider, VChip } from 'vuetify/lib'
  import categoriesDefs from '../categories.json'

  export default {
    components: {
      VRow,
      VCol,
      VDivider,
      VChip,
    },
    props: {
      settings: { type: Object, default: () => {} },
      selectedTab: { type: String, default: undefined },
    },
    data: () => ({
      site: null, // the site to lookup for
      resultCategories: [], // the lookup result array
      lookupError: null,
      loading: false,
    }),

    computed: {
      /**
       * combines categories defs, settings and results for display
       */
      matchedCategories() {
        if (!this.resultCategories) return null
        const matchedCategories = []
        this.resultCategories.forEach(catId => {
          const cDef = categoriesDefs.find(c => c.id === catId)
          const cSetting = this.settings.categories.find(c => c.id === catId)
          matchedCategories.push({
            def: cDef,
            settings: cSetting,
          })
        })
        return matchedCategories.length ? matchedCategories : undefined
      },
    },

    watch: {
      selectedTab(value) {
        if (value !== 'site_lookup') {
          this.site = null
          this.resultCategories = []
          this.lookupError = null
        }
      },
      site(value) {
        if (!value) {
          this.resultCategories = []
          this.lookupError = null
        }
      },
    },

    methods: {
      async onLookup() {
        this.resultCategories = []
        this.lookupError = null
        this.loading = true
        await this.$emit('lookup', {
          site: this.site,
          resolve: res => {
            this.loading = false
            if (res.error) {
              this.lookupError = res.error
              return
            }
            const ids = res[0]?.cats?.map(({ cat }) => cat)
            this.resultCategories = ids || []
          },
        })
      },
    },
  }
</script>
