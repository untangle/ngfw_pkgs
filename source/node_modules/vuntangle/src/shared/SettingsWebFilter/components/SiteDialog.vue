<template>
  <v-container class="pb-0 px-0">
    <ValidationObserver ref="obs">
      <div class="d-flex align-center">
        <ValidationProvider
          v-slot="{ errors }"
          :rules="{
            required: true,
            domain: true,
            unique_insensitive: { list: sitesValidationList, message: $t('site_already_in_list') },
          }"
          class="flex-grow-1"
        >
          <u-text-field
            ref="sitename"
            v-model="site.name"
            :label="$t('enter_site_domain')"
            :error-messages="errors"
            class="mr-4"
          >
            <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
          </u-text-field>
        </ValidationProvider>
        <v-checkbox
          v-model="site.enabled"
          dense
          class="mt-0 mr-4 pa-0"
          hide-details
          :label="type === 'block' ? $t('block') : $t('pass')"
          :color="type === 'block' ? 'red' : 'utGreen'"
        />
        <v-checkbox
          v-model="site.flagged"
          dense
          class="ma-0 pa-0"
          hide-details
          :label="$t('flag')"
          :disabled="site.enabled && type === 'block'"
        />
      </div>
      <div class="d-flex mt-2">
        <v-checkbox v-model="site.exact" dense class="ma-0 pa-0" hide-details :label="$t('exact_match')" />
      </div>
      <v-textarea
        v-model="site.description"
        outlined
        rows="3"
        :label="$t('description')"
        no-resize
        hide-details
        class="mt-4"
      >
      </v-textarea>
    </ValidationObserver>
  </v-container>
</template>
<script>
  import { VContainer, VCheckbox, VTextarea } from 'vuetify/lib'
  import { ValidationObserver, ValidationProvider } from 'vee-validate'
  import cloneDeep from 'lodash/cloneDeep'

  export default {
    components: {
      VContainer,
      VCheckbox,
      VTextarea,
      ValidationObserver,
      ValidationProvider,
    },
    props: {
      // the cloned list of sites
      list: { type: Array, default: () => [] },
      // index of site being edited
      index: { type: Number, default: -1 },
      // site list type: `block` or `pass`
      type: { type: String, default: 'block' },
    },

    data: () => ({
      // default new site values
      site: null,
      sitesValidationList: [],
    }),

    created() {
      // create a list of site names used to show field error on duplicate name
      const names = this.list.map(({ name }) => name)
      if (this.index > -1) {
        this.site = cloneDeep(this.list[this.index])
        names.splice(names.indexOf(this.site.name), 1)
      } else {
        this.site = { name: '', description: '', enabled: true, flagged: this.type === 'block', exact: false }
      }
      this.sitesValidationList = names
    },

    methods: {
      async action() {
        // domain validation
        const isValid = await this.$refs.obs.validate()
        if (!isValid) return
        // updates or adds the site to the list
        this.$set(this.list, this.index > -1 ? this.index : this.list.length, this.site)
        // close dialog
        this.$emit('close')
      },
    },
  }
</script>
