<template>
  <v-container v-if="boxSettings" fluid class="pa-4">
    <h1 class="headline">{{ $vuntangle.$t('settings') }}</h1>

    <v-divider class="my-2" />

    <!-- `hostName`, `domainName` and `timeZone` settings -->
    <u-section :title="$vuntangle.$t('system')">
      <ValidationObserver ref="systemObserver">
        <v-row>
          <v-col cols="12" lg="3">
            <ValidationProvider v-slot="{ errors }" rules="required">
              <u-text-field v-model="system.hostName" :label="$vuntangle.$t('host_name')" :error-messages="errors">
                <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
              </u-text-field>
            </ValidationProvider>
          </v-col>
          <v-col cols="12" lg="3">
            <ValidationProvider v-slot="{ errors }" rules="required">
              <u-text-field v-model="system.domainName" :label="$vuntangle.$t('domain_name')" :error-messages="errors">
                <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
              </u-text-field>
            </ValidationProvider>
          </v-col>
          <v-col cols="12" lg="3">
            <!--
            timezone is represented in the settings as { displayName: 'Continent/City', value: 'tz value' }
            because the value is not unique, and is attached to multiple cities
            the autocomplete uses `return-object` props to show all the options (not only uniques)
          -->
            <ValidationProvider v-slot="{ errors }" rules="required">
              <v-autocomplete
                :value="system.timeZone.displayName"
                :items="timeZones"
                :label="$vuntangle.$t('time_zone')"
                outlined
                dense
                hide-details
                return-object
                :error-messages="errors"
                @input="val => (system.timeZone = { displayName: val ? val.value : '', value: val ? val.openwrt : '' })"
              >
                <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
              </v-autocomplete>
            </ValidationProvider>
          </v-col>
        </v-row>
        <u-btn class="mt-4" @click="onSaveSystem">{{ $vuntangle.$t('save') }}</u-btn>
      </ValidationObserver>
    </u-section>

    <!-- `httpPort` and `httpsPort` settings -->
    <u-section :title="$vuntangle.$t('web_admin_ports')">
      <ValidationObserver ref="portsObserver">
        <v-row>
          <v-col cols="12" lg="3">
            <ValidationProvider v-slot="{ errors }" rules="required|port">
              <u-text-field
                v-model="systemPorts.httpPort"
                type="number"
                :label="$vuntangle.$t('http_port')"
                :error-messages="errors"
              >
                <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
              </u-text-field>
            </ValidationProvider>
          </v-col>
          <v-col cols="12" lg="3">
            <ValidationProvider v-slot="{ errors }" rules="required|port">
              <u-text-field
                v-model="systemPorts.httpsPort"
                type="number"
                :label="$vuntangle.$t('https_port')"
                :error-messages="errors"
              >
                <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
              </u-text-field>
            </ValidationProvider>
          </v-col>
        </v-row>
        <u-btn class="mt-4" @click="onSaveWebPorts">{{ $vuntangle.$t('save') }}</u-btn>
      </ValidationObserver>
    </u-section>

    <!-- `admin` password -->
    <u-section :title="$vuntangle.$t('admin_account')">
      <p class="body-2" v-html="$vuntangle.$t('admin_password_info')" />
      <ValidationObserver ref="passwordObserver">
        <v-row>
          <v-col cols="12" md="3">
            <ValidationProvider v-slot="{ errors }" vid="newPassword" rules="required|min:4">
              <u-text-field
                v-model="newPassword"
                :append-icon="newPasswordReveal ? 'mdi-eye' : 'mdi-eye-off'"
                :type="newPasswordReveal ? 'text' : 'password'"
                :label="$vuntangle.$t('enter_new_password')"
                :error-messages="errors"
                :placeholder="$vuntangle.$t('password')"
                @click:append="newPasswordReveal = !newPasswordReveal"
              >
                <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
              </u-text-field>
            </ValidationProvider>
          </v-col>
          <v-col cols="12" md="3">
            <ValidationProvider v-slot="{ errors }" rules="required|confirmed:newPassword">
              <u-text-field
                v-model="newPasswordConfirm"
                :append-icon="newPasswordConfirmReveal ? 'mdi-eye' : 'mdi-eye-off'"
                :type="newPasswordConfirmReveal ? 'text' : 'password'"
                :label="$vuntangle.$t('confirm_new_password')"
                :error-messages="errors"
                :placeholder="$vuntangle.$t('password')"
                @click:append="newPasswordConfirmReveal = !newPasswordConfirmReveal"
              >
                <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
              </u-text-field>
            </ValidationProvider>
          </v-col>
        </v-row>
        <u-btn class="mt-4" @click="onSavePassword">{{ $vuntangle.$t('save') }}</u-btn>
      </ValidationObserver>
    </u-section>

    <!-- backup and restore -->
    <u-section :title="$vuntangle.$t('configuration_backup_and_restore')">
      <p class="body-2" v-html="$vuntangle.$t('backup_restore_info')" />
      <u-btn class="mr-4" @click="onExportBackup">{{ $vuntangle.$t('export_backup') }}</u-btn>
      <u-btn @click="onRestoreBackup">{{ $vuntangle.$t('restore_backup') }}</u-btn>
    </u-section>

    <!-- Remote support settings -->
    <u-section v-if="showRemoteSupport" :title="$vuntangle.$t('remote_support')">
      <p class="body-2" v-html="$vuntangle.$t('remote_support_info')" />
      <u-checkbox
        v-model="supportAccessEnabledModel"
        class="mb-4"
        :label="$t('remote_support_enabled')"
        hide-details
      ></u-checkbox>
      <u-btn @click="onSaveRemoteSupport">{{ $vuntangle.$t('save') }}</u-btn>
    </u-section>

    <!-- reset to factory defaults -->
    <u-section :title="$vuntangle.$t('configuration_reset')">
      <p class="body-2" v-html="$vuntangle.$t('configuration_reset_info')" />
      <u-btn @click="onFactoryReset">{{ $vuntangle.$t('reset_configuration') }}</u-btn>
    </u-section>

    <!-- reboot -->
    <u-section :title="$vuntangle.$t('reboot')">
      <u-btn @click="onReboot">{{ $vuntangle.$t('reboot') }}</u-btn>
    </u-section>

    <!-- Refresh settings -->
    <u-section v-if="showRefreshSettings" :title="$vuntangle.$t('refresh_settings')">
      <p class="body-2" v-html="$vuntangle.$t('refresh_settings_info')" />
      <u-btn @click="onRefreshSettings">{{ $vuntangle.$t('refresh') }}</u-btn>
    </u-section>
  </v-container>
</template>
<script>
  import cloneDeep from 'lodash/cloneDeep'
  import { VContainer, VDivider, VRow, VCol, VAutocomplete } from 'vuetify/lib'
  import dates from '../../plugins/dates'
  import RestoreBackupDialog from './RestoreBackupDialog.vue'

  export default {
    components: { VContainer, VDivider, VRow, VCol, VAutocomplete },

    props: {
      boxSettings: { type: Object, default: undefined },
      // flag to show remote support field if @arista user
      showRemoteSupport: { type: Boolean, default: false },
      supportAccessEnabled: { type: Boolean, required: true },
      showRefreshSettings: { type: Boolean, required: false },
    },

    data() {
      return {
        system: undefined,
        systemPorts: undefined,

        newPassword: undefined,
        newPasswordConfirm: undefined,
        newPasswordReveal: false,
        newPasswordConfirmReveal: false,
        supportAccessEnabledModel: this.supportAccessEnabled,
      }
    },

    computed: {
      /**
       * Returns the timezone items for select box (openwrt only)
       * @returns {Array<Object>}
       */
      timeZones: () => dates.timeZones.filter(tz => 'openwrt' in tz),
    },

    watch: {
      boxSettings: {
        handler(settings) {
          // populate system amd ports data
          this.system = cloneDeep(settings?.system)
          this.systemPorts = cloneDeep(settings?.system)
        },
        immediate: true,
      },
    },

    methods: {
      /**
       * Validates the system fields then emits event that passes the updated system settings
       * @returns {undefined}
       */
      async onSaveSystem() {
        const isValid = await this.$refs.systemObserver.validate()
        if (!isValid) return

        this.$emit('save-system', this.system)
      },

      /**
       * Validates web ports end emit save event
       * web ports are still under `system` settings
       * @returns {undefined}
       */
      async onSaveWebPorts() {
        const isValid = await this.$refs.portsObserver.validate()
        if (!isValid) return

        this.$vuntangle.confirm.show({
          title: this.$vuntangle.$t('warning'),
          message: this.$vuntangle.$t('web_admin_ports_message'),
          action: resolve => {
            this.$emit('save-web-ports', {
              system: this.systemPorts,
              cb: success => {
                if (success) {
                  this.$vuntangle.toast.add(this.$vuntangle.$t('webports_update_success'))
                } else {
                  this.$vuntangle.toast.add(this.$vuntangle.$t('webports_update_failed'), 'error')
                }
                resolve()
              },
            })
          },
        })
      },

      /**
       * Validates the password fields then emits event with updated "account" password in credentials list
       * @returns {undefined}
       */
      async onSavePassword() {
        const isValid = await this.$refs.passwordObserver.validate()
        if (!isValid) return

        const credentials = cloneDeep(this.boxSettings?.accounts?.credentials)
        const adminAccount = credentials?.find(account => account.username === 'admin')
        if (!adminAccount) return

        // the password is passed as clear text and hashed on the backend
        adminAccount.passwordCleartext = this.newPassword

        this.$emit('save-credentials', credentials)

        // reset the password fields and observer
        this.newPassword = undefined
        this.newPasswordConfirm = undefined
        this.$refs.passwordObserver.reset()
      },

      // exports settings to file
      onExportBackup() {
        this.$emit('export-backup')
      },

      // show restores backup from file dialog
      onRestoreBackup() {
        const vm = this
        this.$vuntangle.dialog.show({
          title: this.$vuntangle.$t('restore_backup'),
          component: RestoreBackupDialog,
          componentEvents: {
            /**
             * capture the `restore` event emitted from dialog,
             * and pass it along with the restore data to the host app component
             * @param {Object} data - restore data
             */
            restore(data) {
              vm.$emit('restore-backup', data)
            },
          },
          width: 600,
          actionLabel: this.$vuntangle.$t('restore'),
        })
      },

      // resets all settings to their factory defaults
      onFactoryReset() {
        this.$vuntangle.confirm.show({
          title: this.$vuntangle.$t('warning'),
          message: this.$vuntangle.$t('configuration_reset_message'),
          action: resolve => {
            this.$emit('factory-reset', success => {
              if (success) {
                this.$vuntangle.toast.add(this.$vuntangle.$t('configuration_reset_success'))
              } else {
                this.$vuntangle.toast.add(this.$vuntangle.$t('configuration_reset_failure'), 'error')
              }
              resolve()
            })
          },
        })
      },

      // reboots the box
      onReboot() {
        this.$vuntangle.confirm.show({
          title: this.$vuntangle.$t('reboot'),
          message: this.$vuntangle.$t('reboot_message'),
          action: resolve => {
            this.$emit('reboot', success => {
              if (success) {
                this.$vuntangle.toast.add(this.$vuntangle.$t('reboot_success'))
              } else {
                this.$vuntangle.toast.add(this.$vuntangle.$t('reboot_failure'), 'error')
              }
              resolve()
            })
          },
        })
      },

      // Emits an event with RemoteSupport checkbox value
      onSaveRemoteSupport() {
        this.$emit('save-remote-support', this.supportAccessEnabledModel)
      },

      // Emits an event to refresh settings
      onRefreshSettings() {
        this.$emit('refresh-settings')
      },
    },
  }
</script>
