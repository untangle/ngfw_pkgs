<template>
  <div>
    <p class="body-2">{{ $vuntangle.$t('restore_info') }}</p>

    <!-- backup input file -->
    <v-file-input
      outlined
      dense
      :label="$vuntangle.$t('choose_backup_file')"
      :hint="settings ? $vuntangle.$t('found_mfw_version', [settings.version]) : null"
      persistent-hint
      @change="fileHandler"
    />

    <!-- error alert when importing file -->
    <u-alert v-if="importError" error class="mt-4 mb-0">
      {{ $vuntangle.$t(importError) }}
    </u-alert>

    <!-- restore options when backup file is valid -->
    <div v-if="settings">
      <p class="font-weight-bold mb-1">{{ $vuntangle.$t('restore_all_settings_except') }}:</p>
      <div class="d-flex">
        <u-checkbox
          v-model="exceptionKeys.accounts"
          hide-details
          class="my-0 mr-4"
          :label="$vuntangle.$t('accounts')"
          :ripple="false"
        />
        <u-checkbox
          v-model="exceptionKeys.network"
          hide-details
          class="ma-0"
          :label="$vuntangle.$t('interfaces')"
          :ripple="false"
        />
      </div>

      <u-alert info class="mt-4 mb-0">
        <span v-html="$vuntangle.$t('restore_warning')"></span>
      </u-alert>
    </div>
  </div>
</template>
<script>
  import { VFileInput } from 'vuetify/lib'
  import { UAlert, UCheckbox } from '../../components'

  export default {
    components: { UAlert, UCheckbox, VFileInput },
    data: () => ({
      settings: null, // keeps settings loaded from a backup file
      importError: null, // the error on importing/reading a backup file

      // exclude by default `accounts` and `network` from restore
      exceptionKeys: {
        accounts: true,
        network: true,
      },
    }),

    computed: {
      /**
       * Returns the settings keys that should be excepted from restore
       * The only available keys are: `accounts` and `network`
       * @param {Object} vm - vue instance
       * @param {Object} vm.exceptionKeys - flag true/false for each key
       * @returns {Array<String>} - the key(s) set as `true`
       */
      exceptions: ({ exceptionKeys }) => Object.keys(exceptionKeys).filter(key => exceptionKeys[key]),
    },

    methods: {
      /**
       * Framework dialog `action` implementation upon pushing the restored file
       */
      action() {
        if (!this.settings) return

        // show dialog progress
        this.$emit('progress-show')

        // pass restore data and callback helper by emitting `restore` event
        this.$emit('restore', {
          restoreData: {
            file: this.settings,
            exceptions: this.exceptions,
          },
          cb: success => {
            if (success) {
              this.$vuntangle.toast.add(this.$vuntangle.$t('backup_restore_success'))
            } else {
              this.$vuntangle.toast.add(this.$vuntangle.$t('backup_restore_error'), 'error')
            }
            // hide and close dialog
            this.$emit('progress-hide')
            this.$emit('close')
          },
        })
      },

      /**
       * Reads the file contents from file input field
       * @param {Object} file - the File object
       */
      fileHandler(file) {
        this.importError = null
        this.settings = null
        if (!file) return

        // use FileReader to read the content and bind `this` context
        const reader = new FileReader()
        reader.onload = function (e) {
          this.settings = e.target.result
        }.bind(this)
        reader.readAsDataURL(file)
      },
    },
  }
</script>
