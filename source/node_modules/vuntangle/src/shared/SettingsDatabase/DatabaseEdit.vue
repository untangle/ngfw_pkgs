<template>
  <div v-if="settingsCopy" class="py-2">
    <ValidationObserver ref="obs">
      <component :is="!classicView ? 'div' : 'u-section'">
        <v-row>
          <v-col cols="12">
            <ValidationProvider v-slot="{ errors }" rules="required">
              <u-text-field v-model="settingsCopy.name" :label="$vuntangle.$t('name')" :error-messages="errors">
                <template v-if="errors.length" #append>
                  <u-errors-tooltip :errors="errors" />
                </template>
              </u-text-field>
            </ValidationProvider>
          </v-col>

          <v-col cols="12">
            <ValidationProvider v-slot="{ errors }" rules="required">
              <u-text-field
                v-model="settingsCopy.description"
                :label="$vuntangle.$t('description')"
                :error-messages="errors"
              >
                <template v-if="errors.length" #append>
                  <u-errors-tooltip :errors="errors" />
                </template>
              </u-text-field>
            </ValidationProvider>
          </v-col>
        </v-row>
        <v-row dense class="my-4" align="center">
          <v-col cols="auto">
            <v-checkbox
              v-model="settingsCopy.enabled"
              :label="$vuntangle.$t('ct_enabled')"
              hide-details
              class="mr-4 mt-0 pt-0"
            />
          </v-col>
          <v-col cols="auto">
            <v-checkbox
              v-model="settingsCopy.default"
              :label="$vuntangle.$t('ct_default')"
              hide-details
              class="mr-4 mt-0 pt-0"
            />
          </v-col>
          <v-col v-if="!isTemplateView">
            <v-icon small :color="statusOnline ? 'green' : 'red'">{{ 'mdi-circle' }}</v-icon>
            <span class="ml-1">{{ statusOnline ? $t('online') : $t('offline') }}</span>
          </v-col>
          <v-col class="justify-end">
            <u-btn v-if="settings && !isTemplateView" :disabled="isDirty" @click="$emit('refresh', settingsCopy.id)"
              >{{ $t('refresh_connection') }}
            </u-btn>
          </v-col>
        </v-row>
        <h4 class="my-4">{{ $vuntangle.$t('database_config') }}</h4>
        <v-row>
          <v-col cols="4">
            <ValidationProvider v-slot="{ errors }" rules="required">
              <u-select
                v-model="settingsCopy.type"
                :items="dbTypeOptions"
                :error-messages="errors"
                :label="$vuntangle.$t('database_type')"
              >
                <template v-if="errors.length" #append>
                  <u-errors-tooltip :errors="errors" />
                </template>
              </u-select>
            </ValidationProvider>
          </v-col>
          <v-col cols="4">
            <ValidationProvider v-slot="{ errors }" rules="required">
              <u-text-field
                v-model="settingsCopy.db_name"
                :label="
                  settingsCopy.type === 'sqlite' ? $vuntangle.$t('database_path') : $vuntangle.$t('database_name')
                "
                :error-messages="errors"
              >
                <template v-if="errors.length" #append>
                  <u-errors-tooltip :errors="errors" />
                </template>
              </u-text-field>
            </ValidationProvider>
          </v-col>
          <v-col v-if="settingsCopy.type !== 'sqlite'" cols="4">
            <ValidationProvider v-slot="{ errors }" :rules="dbPortRules">
              <u-text-field v-model.number="settingsCopy.db_port" :label="$t('database_port')" :error-messages="errors">
                <template v-if="errors.length" #append>
                  <u-errors-tooltip :errors="errors" />
                </template>
              </u-text-field>
            </ValidationProvider>
          </v-col>
        </v-row>

        <v-row v-if="settingsCopy.type !== 'sqlite'">
          <v-col cols="4">
            <ValidationProvider v-slot="{ errors }" rules="required|ip">
              <u-text-field
                v-model="settingsCopy.db_server"
                :label="$vuntangle.$t('database_server')"
                :error-messages="errors"
              >
                <template v-if="errors.length" #append>
                  <u-errors-tooltip :errors="errors" />
                </template>
              </u-text-field>
            </ValidationProvider>
          </v-col>
          <v-col cols="4">
            <ValidationProvider v-slot="{ errors }" rules="required|max:32|alpha_dash_period">
              <u-text-field
                v-model="settingsCopy.db_username"
                :label="$vuntangle.$t('database_username')"
                :error-messages="errors"
              >
                <template v-if="errors.length" #append>
                  <u-errors-tooltip :errors="errors" />
                </template>
              </u-text-field>
            </ValidationProvider>
          </v-col>
          <v-col cols="4">
            <ValidationProvider v-slot="{ errors }" rules="required|min:6">
              <div>
                <u-text-field
                  v-model="dbPassword"
                  :label="$vuntangle.$t('database_password')"
                  type="password"
                  :error-messages="errors"
                  @focus="onFocus"
                  @blur="onBlur"
                >
                  <template v-if="errors.length" #append>
                    <u-errors-tooltip :errors="errors" />
                  </template>
                </u-text-field>
              </div>
            </ValidationProvider>
          </v-col>
        </v-row>
      </component>
    </ValidationObserver>
  </div>
</template>
<script>
  import { VCheckbox, VCol, VContainer, VDivider, VRow, VSpacer } from 'vuetify/lib'
  import util from '../../plugins/util'
  import USelect from '../../components/USelect'
  import settingsMixin from '../settingsMixin'
  import UTextField from '../../components/UTextField'
  import { defaultDbConfigs as defaults } from './defaults'

  const passwordFill = '******'

  const DB_TYPE = {
    SQLITE: 'sqlite',
    MYSQL: 'mysql',
    POSTGRES: 'postgres',
  }

  const DEFAULT_PORT = {
    MYSQL: 3306,
    POSTGRES: 5432,
  }

  export default {
    components: {
      VContainer,
      VSpacer,
      VDivider,
      VRow,
      VCol,
      VCheckbox,
      USelect,
      UTextField,
    },
    mixins: [settingsMixin],
    defaults,
    props: {
      allSettings: { type: Array, default: () => [] },
      statusOnline: { type: Boolean },
      isTemplateView: { type: Boolean },
    },
    data: () => ({
      showPassword: false,
      showConnectionString: false,
      isTestConnectionDisabled: true, // TODO: MFW-4764

      // database types used in select field options
      dbTypeOptions: [
        { text: 'SQLite', value: DB_TYPE.SQLITE },
        { text: 'MySQL', value: DB_TYPE.MYSQL },
        { text: 'Postgres', value: DB_TYPE.POSTGRES },
      ],

      connectionString: '',
    }),
    computed: {
      dbPassword: {
        get() {
          return this.settingsCopy.db_password_encrypted && !('db_password' in this.settingsCopy)
            ? passwordFill
            : this.settingsCopy.db_password
        },
        set(value) {
          this.$set(this.settingsCopy, 'db_password', value)
        },
      },
      // database port field validations rules
      dbPortRules: ({ settingsCopy }) => ({
        required: [DB_TYPE.MYSQL, DB_TYPE.POSTGRES].includes(settingsCopy.type),
        numeric: true,
        port: true,
      }),
    },

    watch: {
      /**
       * Resets/removes settings data upon database type change,
       * @param {String} type - database type
       */
      'settingsCopy.type'(type) {
        this.$set(this.settingsCopy, 'db_name', '')
        switch (type) {
          case DB_TYPE.MYSQL:
            this.$set(this.settingsCopy, 'db_server', '')
            this.$set(this.settingsCopy, 'db_port', DEFAULT_PORT.MYSQL)
            this.$set(this.settingsCopy, 'db_username', '')
            this.$set(this.settingsCopy, 'db_password', '')
            break
          case DB_TYPE.POSTGRES:
            this.$set(this.settingsCopy, 'db_server', '')
            this.$set(this.settingsCopy, 'db_port', DEFAULT_PORT.POSTGRES)
            this.$set(this.settingsCopy, 'db_username', '')
            this.$set(this.settingsCopy, 'db_password', '')
            break
          case DB_TYPE.SQLITE:
            delete this.settingsCopy.db_username
            delete this.settingsCopy.db_password
            delete this.settingsCopy.db_server
            delete this.settingsCopy.db_port
            break
        }
      },

      /**
       * Enables connection when set as default
       * @param {Boolean} value - is default connection
       */
      'settingsCopy.default'(value) {
        if (value) this.settingsCopy.enabled = true
      },

      settingsCopy: {
        handler(settings) {
          if (!settings.type || !settings.db_name) return

          if (settings.type === DB_TYPE.SQLITE) {
            this.settingsCopy.db_connection_string = `${settings.type}://${settings.db_name}`
            return
          }

          if (!settings.db_username || !settings.db_password || !settings.db_server || !settings.db_port) return ''
          this.settingsCopy.db_connection_string = `${settings.type}://${settings.db_username}:${settings.db_password}@${settings.db_server}:${settings.db_port}`
        },
        immediate: true,
        deep: true,
      },
    },

    mounted() {
      // if it's a new db connection setting, set uuid for it
      if (!this.settingsCopy.id) {
        this.settingsCopy.id = util.uuidv4()
      }
      if (!this.allSettings.length) {
        this.settingsCopy.default = true
      }
    },

    methods: {
      /** copies the generated connection string to the clipboard**/
      onCopy() {
        this.$vuntangle.util.copyToClipboard(this.settingsCopy.db_connection_string)
      },

      // Dialog main action emitting updated settings
      async action() {
        const isValid = await this.$refs.obs.validate()
        if (!isValid) return

        this.$emit('update', this.settingsCopy)
        this.$emit('close')
      },

      onFocus() {
        if (this.dbPassword === passwordFill) {
          this.dbPassword = '' // Clear the password when focused if it's the placeholder value
        }
      },

      onBlur() {
        if (this.dbPassword === '') {
          this.$delete(this.settingsCopy, 'db_password') // Optionally remove password from settingsCopy
        }
      },
    },
  }
</script>
