<template>
  <v-container :fluid="true" :class="`d-flex flex-column flex-grow-1 shared-cmp ${disabled ? 'disabled' : ''}`">
    <div class="d-flex align-center">
      <h2 class="font-weight-light">{{ $t('database') }}</h2>
      <v-spacer />
      <slot
        name="actions"
        :new-settings="settingsCopy"
        :is-dirty="isDirty"
        :disabled="disabled"
        :is-invalid="invalidDefaultCount"
      />
    </div>
    <v-divider class="my-2" />
    <p class="body-2 my-4">
      {{ $vuntangle.$t('database_description') }}
    </p>
    <u-section v-if="!!$slots['extra-fields']">
      <slot name="extra-fields" />
    </u-section>

    <div class="d-flex my-2 align-center">
      <u-alert v-if="showAlert" error dense class="mb-0">
        {{ $vuntangle.$t('database_error_default_count') }}
      </u-alert>
      <v-spacer />
      <u-btn v-if="!features.isTemplateView" :disabled="disabled" class="mr-2" @click="$emit('refresh')">
        {{ $vuntangle.$t('refresh_connections') }}
      </u-btn>
      <u-btn :disabled="disabled" color="primary" @click="onEdit({})">
        <v-icon left>mdi-plus</v-icon>
        {{ $vuntangle.$t('add_db') }}
      </u-btn>
    </div>

    <u-grid
      id="databases"
      row-node-id="id"
      :row-data="combinedData"
      :row-actions="rowActions"
      :column-defs="columnDefs"
      :enable-export-csv="true"
      :enable-refresh="!features.isTemplateView"
      :fetching="fetching"
      :framework-components="frameworkComponents"
      @refresh="$emit('refresh')"
      @row-clicked="onEdit"
    />
  </v-container>
</template>

<script>
  import cloneDeep from 'lodash/cloneDeep'
  import { VContainer, VDivider, VSpacer } from 'vuetify/lib'
  import UGrid from '../../components/UGrid'
  import settingsMixin from '../settingsMixin'
  import CheckboxRenderer from '../../components/UGrid/renderers/CheckboxRenderer.vue'
  import DatabaseEdit from './DatabaseEdit.vue'

  export default {
    components: { UGrid, VContainer, VSpacer, VDivider },
    mixins: [settingsMixin],
    props: {
      fetching: { type: Boolean, default: false },
      status: { type: Array, default: () => [] },
    },
    data() {
      return {
        combinedData: [],
        statusOnline: false,
        frameworkComponents: {
          CheckboxRenderer,
        },
      }
    },
    computed: {
      columnDefs() {
        const columns = [
          {
            headerName: this.$vuntangle.$t('enabled'),
            field: 'enabled',
            minWidth: 50,
            width: 80,
            flex: 0,
            sortable: true,
            cellRenderer: 'CheckboxRenderer',
          },
          { headerName: this.$vuntangle.$t('connection_name'), field: 'name', flex: 1 },
          { headerName: this.$vuntangle.$t('description'), field: 'description', flex: 2 },
          { headerName: this.$vuntangle.$t('database_type'), field: 'type', flex: 2 },
          { headerName: this.$vuntangle.$t('database_name'), field: 'db_name', flex: 2 },
          { headerName: this.$vuntangle.$t('database_server'), field: 'db_server', flex: 2 },
          { headerName: this.$vuntangle.$t('database_port'), field: 'db_port', flex: 2 },
          {
            headerName: this.$vuntangle.$t('ct_default'),
            field: 'default',
            flex: 2,
            cellRenderer: ({ value }) => (value ? this.$t('yes') : this.$t('no')),
          },
        ]

        if (!this.features.isTemplateView) {
          columns.splice(1, 0, {
            headerName: this.$vuntangle.$t('status'),
            field: 'status',
            minWidth: 50,
            width: 80,
            flex: 0,
            sortable: true,
            valueGetter: ({ data }) => {
              return this.$vuntangle.$t(this.getStatusTooltip(data))
            },
            cellRenderer: 'CellWithTooltip',
            cellRendererParams: params => {
              if (params.data.status) {
                return {
                  icon: 'mdi-circle',
                  small: true,
                  color: 'utGreen',
                  top: true,
                  tooltip: this.$vuntangle.$t(this.getStatusTooltip(params.data)),
                }
              } else {
                return {
                  icon: 'mdi-alert',
                  small: true,
                  color: 'red',
                  top: true,
                  tooltip: this.$vuntangle.$t(this.getStatusTooltip(params.data)),
                }
              }
            },
          })
        }
        return columns
      },
      rowActions() {
        return [
          {
            icon: 'mdi-pencil',
            tooltip: this.$vuntangle.$t('edit'),
            handler: this.onEdit,
          },
          {
            icon: 'mdi-delete',
            tooltip: this.$vuntangle.$t('remove'),
            handler: ({ data }) => this.onDeleteConfiguration(data),
          },
        ]
      },
      // flag to validates exactly one default should be configured
      invalidDefaultCount: ({ settingsCopy }) => settingsCopy.filter(db => db.default).length > 1,
      // flag to show alert on validation errors
      showAlert: ({ features, isDirty, invalidDefaultCount }) =>
        features.isTemplateView && isDirty && invalidDefaultCount,
    },
    watch: {
      settingsCopy: {
        handler() {
          this.setCombinedData()
        },
        immediate: true,
        deep: true,
      },
      status: {
        handler() {
          this.setCombinedData()
        },
        immediate: true,
        deep: true,
      },
      /** sets the enabled flag on configurations when using the grid Enabled column checkboxes  */
      combinedData: {
        handler(data) {
          data.forEach((entry, index) => {
            this.settingsCopy[index].enabled = entry.enabled
          })
        },
        immediate: true,
        deep: true,
      },
    },
    methods: {
      setCombinedData() {
        if (!this.settingsCopy || !this.status) return
        const list = cloneDeep(this.settingsCopy)
        list.forEach(conf => {
          const confStatus = this.status.find(s => s.uuid === conf.id)
          if (confStatus) {
            this.$set(conf, 'status', confStatus.status)
            this.$set(conf, 'statusMessage', confStatus.statusMessage)
          }
        })
        this.combinedData = list
      },
      /**
       * Shows confirm dialog when deleting a configuration
       * Upon confirm the `delete-configuration` gets emitted to the host app
       * @param configuration - complete configuration object for respective row
       */
      onDeleteConfiguration(configuration) {
        /**
         * in case of global templates the entry is not just removed from list
         * without being pushed, as the template may not have been yet created
         */
        if (this.features.isTemplateView) {
          const index = this.settingsCopy.findIndex(conf => conf.id === configuration.id)
          if (index >= 0) {
            this.settingsCopy.splice(index, 1)
          }
          return
        }

        this.$vuntangle.confirm.show({
          title: `<i class="mdi mdi-alert" style="font-style: normal;"> ${this.$vuntangle.$t('confirm')}</i>`,
          message: this.$vuntangle.$t('remove_database', [configuration.name]),
          confirmLabel: this.$vuntangle.$t('yes'),
          cancelLabel: this.$vuntangle.$t('no'),
          action: async resolve => {
            await this.$emit('delete-configuration', configuration.id)
            resolve()
          },
        })
      },
      /**
       * Get the tooltip text for the status icon
       * @param item - row item
       */
      getStatusTooltip(item) {
        if (item.status) {
          return 'online'
        } else {
          return item.statusMessage || 'offline'
        }
      },
      /**
       * Shows route edit dialog, it adds a new route if index undefined
       * @param index - number
       */
      onEdit({ data }) {
        const id = data?.id
        // extract only conf data on grid row click (avoid getting status data in conf columns)
        const settings = this.settingsCopy.find(conf => conf.id === id) || undefined
        const status = this.status.find(status => status.uuid === id) || undefined
        let statusOnline = status?.status
        const isTemplateView = this.features.isTemplateView
        this.$vuntangle.dialog.show({
          title: !id ? this.$vuntangle.$t('add_db_connection') : this.$vuntangle.$t('edit_db_connection'),
          component: DatabaseEdit,
          width: 800,
          height: 'auto',
          actionLabel: !id ? this.$vuntangle.$t('add') : this.$vuntangle.$t('update'),
          componentProps: {
            settings,
            allSettings: this.settingsCopy,
            statusOnline,
            isTemplateView,
          },
          componentEvents: {
            // updates configuration
            update: entry => {
              const index = this.settingsCopy.findIndex(conf => conf.id === id)
              if (index >= 0) this.settingsCopy.splice(index, 1, entry)
              else this.settingsCopy.push(entry)
              /**
               * for global templates the changes are not going to be pushed right away
               * upon add/edit/delete a list entry as the template might not have been created yet
               */
              if (this.features.isTemplateView) return
              if (entry.default) {
                const currentDefaultDb = this.settings.find(db => db.default === true)
                if (currentDefaultDb) {
                  this.$vuntangle.confirm.show({
                    title: `<i class="mdi mdi-alert" style="font-style: normal;"> ${this.$vuntangle.$t('confirm')}</i>`,
                    message: this.$vuntangle.$t('update_default_databse', [entry.name, currentDefaultDb.name]),
                    confirmLabel: this.$vuntangle.$t('yes'),
                    cancelLabel: this.$vuntangle.$t('no'),
                    action: resolve => {
                      currentDefaultDb.default = false
                      this.$emit('update-settings', entry)
                      resolve()
                    },
                    cancel: resolve => {
                      currentDefaultDb.default = true
                      entry.default = false
                      this.$emit('update-settings', entry)
                      resolve()
                    },
                  })
                } else {
                  this.$emit('update-settings', entry)
                }
              } else {
                this.$emit('update-settings', entry)
              }
            },
            refresh: id => {
              this.$emit('refresh-connection', {
                uuid: id,
                cb: response => {
                  statusOnline = response
                },
              })
            },
          },
        })
      },
    },
  }
</script>
