<template>
  <v-container>
    <div class="d-flex flex-column fill-height">
      <div class="flex-shrink-1">
        <div class="d-flex align-center">
          <h2 class="font-weight-light">{{ $vuntangle.$t('logging') }}</h2>
          <v-spacer />
          <u-btn class="mx-2" @click="reload">{{ $vuntangle.$t('refresh') }}</u-btn>
          <u-btn @click="saveLogs">{{ $vuntangle.$t('export') }}</u-btn>
        </div>
        <v-divider class="my-2" />
        <v-tabs v-model="activeTab" class="mb-4">
          <v-tab>
            {{ $vuntangle.$t('logread') }}
          </v-tab>
          <v-tab>{{ $vuntangle.$t('dmesg') }}</v-tab>
        </v-tabs>
      </div>
      <u-sheet class="flex-grow-1">
        <pre style="font-size: 11px; max-height: 0">{{ log }}</pre>
      </u-sheet>
    </div>
  </v-container>
</template>
<script>
  import { VContainer, VSpacer, VDivider, VTabs, VTab } from 'vuetify/lib'
  import USheet from '../../components/USheet/USheet.vue'
  import UBtn from '../../components/UBtn'

  export default {
    components: { USheet, UBtn, VContainer, VSpacer, VDivider, VTabs, VTab },
    props: {
      logProp: { type: String, default: '' },
    },
    data() {
      return {
        activeTab: null,
      }
    },
    computed: {
      tabName() {
        // active tab is either 0 (for logread) or 1 (for dmesg) since we're using v-model with tabs instead of "to"
        return this.activeTab === 1 ? 'dmesg' : 'logread'
      },
      log() {
        return this.logProp ? window.atob(this.logProp) : ''
      },
    },
    watch: {
      activeTab() {
        this.$emit('tab-switched', this.tabName)
      },
    },
    methods: {
      reload() {
        this.$emit('on-reload', this.tabName)
      },
      saveLogs() {
        const time = new Date()
        const type = this.$vuntangle.$t(this.tabName)
        const log = this.log
        // create a link with log content and save to a file
        const link = document.createElement('a')
        // using data:text/plan and base64 content will create a log file that's human readable
        link.setAttribute('href', 'data:text/plain;base64,' + window.btoa(log))
        link.setAttribute('download', type.toLowerCase() + '_' + time + '.log')
        link.click()
      },
    },
  }
</script>
