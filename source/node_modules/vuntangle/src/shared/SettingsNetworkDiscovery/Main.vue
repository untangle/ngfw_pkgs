<template>
  <v-container
    :fluid="classicView ? true : false"
    :class="`${classicView ? 'pa-4 ' : ''}shared-cmp ${disabled ? 'disabled' : ''}`"
  >
    <ValidationObserver ref="obs" v-slot="{ valid }">
      <div class="d-flex align-center">
        <h1 v-if="classicView" class="headline">{{ $t('network_discovery') }}</h1>
        <h2 v-else class="font-weight-light">{{ $t('network_discovery') }}</h2>
        <v-spacer />
        <slot
          name="actions"
          :new-settings="settingsCopy"
          :is-valid="valid"
          :is-dirty="isDirty"
          :defaults="$options.defaults"
        />
      </div>

      <v-divider class="my-2" />
      <u-section v-if="!!$slots['extra-fields']">
        <slot name="extra-fields" />
      </u-section>
      <component :is="!$slots['extra-fields'] ? 'div' : 'u-section'">
        <div class="body-2 mt-4">
          <!-- Enable/Disable toggle (hidden if not licensed) -->
          <v-switch
            v-model="settingsCopy.enabled"
            :disabled="disabled"
            class="body-2 mb-4"
            dense
            inset
            hide-details
            :label="$t('toggle_network_discovery', [settingsCopy.enabled ? $t('enabled') : $t('disabled')])"
          />
        </div>

        <h3 class="mt-4">{{ $t('plugins') }}</h3>
        <p class="text--secondary">
          {{ $t('network_discovery_plugins') }}
        </p>

        <div class="mt-4">
          <div v-for="(plugin, idx) in settingsCopy.plugins" :key="idx">
            <div class="d-flex align-center my-6" style="align-items: center">
              <v-tooltip bottom>
                <template #activator="{ on }">
                  <div style="width: 160px" v-on="on">
                    <ValidationProvider rules="required" class="d-flex align-center">
                      <v-switch
                        v-model="plugin.enabled"
                        :label="$t(`collector_${plugin.type}`)"
                        hide-details
                        inset
                        dense
                        :disabled="disabled || !settingsCopy.enabled"
                        class="my-0 py-0"
                      />
                    </ValidationProvider>
                  </div>
                </template>
                <span>{{ $t(`collector_${plugin.type}_tooltip`) }}</span>
              </v-tooltip>
              <auto-interval
                v-model="plugin.autoInterval"
                :disabled="!plugin.enabled || !settingsCopy.enabled"
                class="flex-grow-0 mr-2"
              />
              <u-btn
                v-if="!features.isTemplateView"
                :small="false"
                :disabled="disabled || !plugin.enabled || !settingsCopy.enabled"
                :min-width="null"
                @click="$emit('run-collector', plugin.type)"
              >
                {{ $t('run_sync') }}
              </u-btn>
            </div>
          </div>
        </div>
      </component>
    </ValidationObserver>
    <invalid-settings
      v-if="invalidSettingsErrors"
      service="Network Discovery"
      :settings="settings"
      :schema="$options.schema"
      :errors.sync="invalidSettingsErrors"
    />
  </v-container>
</template>
<script>
  import { VContainer, VSpacer, VDivider, VSwitch, VTooltip } from 'vuetify/lib'
  import { ValidationObserver, ValidationProvider } from 'vee-validate'
  import InvalidSettings from '../InvalidSettings/Main.vue'
  import settingsMixin from '../settingsMixin'
  import AutoInterval from './AutoInterval.vue'

  import defaults from './defaults'
  import schema from './schema'

  export default {
    components: {
      VContainer,
      VSpacer,
      VDivider,
      VSwitch,
      VTooltip,
      ValidationObserver,
      ValidationProvider,

      AutoInterval,
      InvalidSettings,
    },
    mixins: [settingsMixin],
    inheritAttrs: false,
    schema,
    defaults,
    methods: {
      // method called from parent component upon save to validate input data
      async validate() {
        const isValid = await this.$refs.obs.validate()
        return isValid
      },
    },
  }
</script>
