<template>
  <div>
    <!-- display `no conditions` if there is none initially -->
    <div v-if="!conditions.length">
      <u-alert v-if="!conditions.length" class="body-2 mb-0 py-3">
        {{ $vuntangle.$t('no_conditions') }}
      </u-alert>
    </div>

    <div v-else>
      <v-row v-for="(condition, index) in conditions" :key="`condition-${index}`" class="align-center" dense>
        <v-col :cols="4">
          <!-- condition type selector -->
          <ValidationProvider v-slot="{ errors }" rules="required">
            <u-select
              v-model="condition.type"
              :items="conditionList"
              :placeholder="$t('type')"
              :error-messages="errors"
              @change="onChangeConditionType(condition)"
            >
              <template #selection="{ item }">{{ $t(item.value.toLowerCase()) }}</template>
              <template #item="{ item }">{{ $t(item.value.toLowerCase()) }}</template>
              <template v-if="errors.length" #append>
                <u-errors-tooltip :errors="errors" />
              </template>
            </u-select>
          </ValidationProvider>
        </v-col>
        <v-col :cols="2">
          <!-- condition operator selector -->
          <ValidationProvider v-slot="{ errors }" rules="required">
            <u-select
              v-model="condition.op"
              :disabled="!condition.type"
              :items="conditionDefs[condition.type] ? conditionDefs[condition.type].ops : isOperatorOptions"
              :error-messages="errors"
            >
              <template #selection="{ item }">{{ $t(item.text) }}</template>
              <template #item="{ item }">{{ $t(item.text) }}</template>
              <template v-if="errors.length" #append>
                <u-errors-tooltip :errors="errors" />
              </template>
            </u-select>
          </ValidationProvider>
        </v-col>
        <v-col v-if="condition.type === 'IP_PROTOCOL'">
          <!-- condition value field -->
          <ValidationProvider
            v-slot="{ errors }"
            :rules="conditionDefs[condition.type] ? conditionDefs[condition.type].rules : ''"
          >
            <v-autocomplete
              v-model="condition.value"
              :items="conditionDefs[condition.type].autocompleteItems"
              multiple
              :placeholder="$t('value')"
              outlined
              dense
              hide-details
              :error-messages="errors"
            ></v-autocomplete>
          </ValidationProvider>
        </v-col>
        <v-col v-else-if="condition.type === 'SOURCE_INTERFACE_ZONE'">
          <!-- condition value field -->
          <ValidationProvider v-slot="{ errors }" rules="required">
            <u-select
              v-if="!condition.value.text"
              v-model="condition.value"
              :items="zoneItems"
              :disabled="!condition.type"
              :placeholder="$t('value')"
              :error-messages="errors"
            >
              <template #selection="{ item }">{{ $t(item.text) || item }}</template>
              <template #item="{ item }">{{ $t(item.text) || item }}</template>
              <template v-if="errors.length" #append>
                <u-errors-tooltip :errors="errors" />
              </template>
            </u-select>
            <u-select
              v-else
              v-model="condition.value.text"
              :items="zoneItems"
              :disabled="!condition.type"
              :placeholder="$t('value')"
              :error-messages="errors"
            >
              <template #selection="{ item }">{{ $t(item.text) || item }}</template>
              <template #item="{ item }">{{ $t(item.text) || item }}</template>
              <template v-if="errors.length" #append>
                <u-errors-tooltip :errors="errors" />
              </template>
            </u-select>
          </ValidationProvider>
        </v-col>
        <v-col v-else>
          <!-- condition value field -->
          <ValidationProvider
            v-slot="{ errors }"
            :rules="conditionDefs[condition.type] ? conditionDefs[condition.type].rules : ''"
          >
            <u-text-field
              v-model="condition.value"
              :disabled="!condition.type"
              :placeholder="$t('value')"
              :error-messages="errors"
            >
              <template v-if="errors.length" #append>
                <u-errors-tooltip :errors="errors" />
              </template>
            </u-text-field>
          </ValidationProvider>
        </v-col>
        <!-- icon button to remove the condition -->
        <v-col :cols="1" class="text-right">
          <v-btn icon @click="removeCondition(index)">
            <v-icon>mdi-close</v-icon>
          </v-btn>
        </v-col>
      </v-row>
    </div>
    <div class="mt-2">
      <u-btn class="mr-2" @click="addCondition()">{{ $t('add_condition') }}</u-btn>
    </div>
  </div>
</template>
<script>
  import { ValidationProvider } from 'vee-validate'
  import { VRow, VCol, VIcon } from 'vuetify/lib'
  import { conditionDefs, conditionTypeOptions, conditionTypeHeaders } from '../conditionDefs'
  import { isOperatorOptions } from '../../../constants'
  import { addConditionHeaders } from '../../Conditions/util/addConditionHeaders'

  export default {
    components: { VRow, VCol, VIcon, ValidationProvider },
    props: {
      zoneItems: { type: Array, required: true },
      /**
       * conditions like
       * [ { type: 'CLIENT_PORT', op: '==', value: '45' }, {...}, {...} ]
       */
      conditions: {
        type: Array,
        default: () => [],
      },
    },
    data() {
      return {
        conditionDefs,
        isOperatorOptions,
      }
    },

    computed: {
      conditionDef: ({ conditionDefs, condition }) => conditionDefs[condition.type],
      conditionList: () => addConditionHeaders(conditionTypeHeaders, conditionTypeOptions),
    },

    methods: {
      addCondition() {
        const newCondition = { type: '', op: '==', value: '' }
        this.$set(this.conditions, this.conditions.length, newCondition)
      },

      removeCondition(index) {
        this.$delete(this.conditions, index)
      },

      /**
       * MFW-2749
       * when editing (changing) a condition type, reset operator and value
       * cause each condition type has it's specific value type, otherwise might throw errors
       * @param {Object} cond - the condition object
       */
      onChangeConditionType(cond) {
        cond.op = '=='
        cond.value = ''
      },
    },
  }
</script>
