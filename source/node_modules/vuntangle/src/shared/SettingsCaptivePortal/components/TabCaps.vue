<template>
  <div class="cp-settings--full">
    <v-card>
      <v-row dense class="pa-2 cp-settings--full" style="flex-grow: 0">
        <div :is="!$slots['extra-fields'] ? 'div' : 'u-section'">
          <!-- settings.logo may be undefined in some circumstances while fetching data on cloud etm -->
          <template v-if="settings.logo">
            <u-btn
              :disabled="!settings.enabled"
              color="primary"
              class="mr-2"
              :loading="isSelecting"
              :label="$t('logo')"
              @click="handleFileImport"
            >
              {{ settings.logo.imageData ? $t('update_logo') : $t('add_logo') }}
            </u-btn>
            <p></p>
            <p v-if="fileSizeExceeded" style="color: #d30000">{{ $t('file_upload_max_size') }}</p>
            <input
              ref="uploader"
              class="d-none"
              type="file"
              accept="image/*"
              :disabled="!settings.enabled"
              @change="onChange"
            />
            <div>
              <div v-if="settings.logo.imageData" class="image-container">
                <img
                  :disabled="!settings.enabled"
                  :src="settings.logo.imageData"
                  data-testid="captive-portal-img"
                  style="width: 200px; max-width: 200px; max-height: 200px"
                />
                <button class="cross-button" @click="removeImage">âœ–</button>
              </div>
              <div
                v-else
                style="width: 200px; height: 100px; border: 1px solid #000; text-align: center; line-height: 90px"
              >
                {{ $t('your_logo_here') }}
              </div>
            </div>
          </template>
          <p></p>
          <div class="body-2 mb-4">
            <ValidationProvider v-slot="{ errors }" rules="required">
              <u-text-field
                v-model="settings.pageTitle"
                :disabled="!settings.enabled"
                :label="$t('page_title')"
                outlined
              >
                <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
              </u-text-field>
            </ValidationProvider>
          </div>
          <div class="body-2 mb-4">
            <u-text-field
              v-model="settings.welcomeText"
              :disabled="!settings.enabled"
              :label="$t('welcome_text')"
              outlined
            ></u-text-field>
          </div>
          <div class="body-2 mb-4">
            <u-text-field
              v-model="settings.messageHeading"
              :disabled="!settings.enabled"
              :label="$t('message_heading')"
              outlined
            ></u-text-field>
          </div>
          <div class="body-2 mb-4">
            <v-textarea
              v-model="settings.messageText"
              :disabled="!settings.enabled"
              :label="$t('message_text')"
              outlined
            ></v-textarea>
          </div>
          <div class="body-2 mb-4">
            <u-text-field
              v-model="settings.acceptText"
              :disabled="!settings.enabled"
              :label="$t('accept_text')"
              outlined
            ></u-text-field>
          </div>
          <div class="body-2 mb-4">
            <ValidationProvider v-slot="{ errors }" rules="required">
              <u-text-field
                v-model="settings.acceptButtonText"
                :disabled="!settings.enabled"
                :label="$t('accept_button_text')"
                outlined
              >
                <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
              </u-text-field>
            </ValidationProvider>
          </div>
          <div class="body-2 mb-4u-select d-flex flex-row">
            <u-text-field
              v-model.number="settings.timeoutValue"
              type="number"
              min="1"
              :disabled="!settings.enabled"
              :label="$t('timeout')"
              class="mr-1 body-2 mb-4"
            >
            </u-text-field>
            <p></p>
            <!-- DAY HOUR MINUTE -->
            <u-select
              v-model="settings.timeoutPeriod"
              :disabled="!settings.enabled"
              :items="timeoutData"
              :label="$tc('Timeout Period', 1)"
            >
              <template #selection="{ item }">{{ $vuntangle.$t(item.name) }}</template>
              <template #item="{ item }">{{ $vuntangle.$t(item.name) }}</template>
            </u-select>
            <select v-model="settings.timeoutPeriod" :disabled="!settings.enabled"></select>
          </div>
        </div>
      </v-row>
    </v-card>
  </div>
</template>
<script>
  import {
    VCard,
    VRow,
    VCol,
    VDivider,
    VListItem,
    VListItemContent,
    VListItemTitle,
    VListItemSubtitle,
    VCheckbox,
    VVirtualScroll,
    VContainer,
    VSpacer,
    VSwitch,
    VSlider,
  } from 'vuetify/lib'
  import { ValidationProvider } from 'vee-validate'
  import settingsMixin from '../../settingsMixin'
  import InvalidSettings from '../../InvalidSettings/Main.vue'
  import defaults from '../defaults'
  import schema from '../schema'

  export default {
    components: {
      VSwitch,
      VSlider,
      VSpacer,
      VContainer,
      VCard,
      VRow,
      VCol,
      VDivider,
      VListItem,
      VListItemContent,
      VListItemTitle,
      VListItemSubtitle,
      VCheckbox,
      VVirtualScroll,
      InvalidSettings,
      ValidationProvider,
    },
    mixins: [settingsMixin],
    defaults,
    schema,
    props: {
      caps: { type: Array, default: () => null },
    },

    data() {
      return {
        isSelecting: false,
        maxFileSize: 2097152,
        fileSizeExceeded: false,
        timeoutData: [
          { value: 'd', name: 'Days' },
          { value: 'h', name: 'Hours' },
          { value: 'm', name: 'Minutes' },
        ],
      }
    },

    methods: {
      removeImage() {
        this.settings.logo.imageData = ''
      },
      handleFileImport() {
        this.isSelecting = true
        window.addEventListener(
          'focus',
          () => {
            this.isSelecting = false
          },
          { once: true },
        )
        this.$refs.uploader.click()
      },

      onChange(e) {
        const file = e.target.files[0]
        if (file) {
          if (file.size > this.maxFileSize) {
            this.fileSizeExceeded = true
            return // do not process the file if it exceeds the size limit
          }
          this.fileSizeExceeded = false
          this.createBase64Image(file)
        }
      },

      createBase64Image(fileO) {
        const reader = new FileReader()
        reader.onloadend = e => {
          this.settings.logo.imageData = e.target.result
        }
        reader.readAsDataURL(fileO)
      },
    },
  }
</script>
<style scoped>
  .cp-settings--full {
    display: flex;
    flex-direction: column;
    flex: 0;
  }
  .image-container {
    position: relative;
    display: inline-block;
  }
  .cross-button {
    position: absolute;
    top: 0px;
    right: 0px;
    cursor: pointer;
    background: red;
    color: white;
    border: none;
    font-size: 20px;
  }
</style>
