<template>
  <div class="cp-rules--full">
    <v-card v-if="!selectedRule" class="cp-rules--full" outlined>
      <v-row dense class="pa-2 align-center" style="flex-grow: 0">
        <v-col cols="2">
          <u-text-field v-model="filter.text" :label="$t('filter')" clearable></u-text-field>
        </v-col>
        <v-col cols="3">
          <u-select v-model="filter.type" :items="actionItems" clearable :label="$t('action')" />
        </v-col>
        <v-col>
          <div class="caption">
            {{ $t('filtered_text', { filtered: filteredRules.length, total: cpRules.length }) }}
          </div>
        </v-col>
        <v-col class="text-right">
          <u-btn :min-width="null" @click="onRuleToggle()">{{ $t('cp_add_rule') }}</u-btn>
        </v-col>
      </v-row>
      <v-divider />
      <div v-if="filteredRules.length === 0 && cpRules.length > 0" class="body-2 text-center my-8">
        <p>{{ $t('no_rule_meets_filter') }}</p>
        <u-btn outlined @click="clearFilters">{{ $t('clear_filters') }}</u-btn>
      </div>
      <div v-if="cpRules.length === 0" class="body-2 text-center my-8 cp-rules-full">
        <p>{{ $t('cp_no_rules_defined') }}</p>
      </div>

      <v-simple-table v-if="filteredRules.length > 0">
        <thead>
          <tr>
            <th style="width: 90px" class="text-center">{{ $vuntangle.$t('order') }}</th>
            <th style="width: 50px">{{ $t('enable') }}</th>
            <th style="width: 20%">{{ $t('description') }}</th>
            <th>{{ $t('conditions') }}</th>
            <th>{{ $t('action') }}</th>
            <th style="width: 120px"></th>
          </tr>
        </thead>
        <transition-group
          is="draggable"
          v-if="filteredRules.length"
          :list="filteredRules"
          tag="tbody"
          :name="!drag ? 'flip-list' : null"
          animation="500"
          handle=".handle"
          @start="drag = true"
          @end="onEndDrag"
        >
          <tr
            v-for="rule in filteredRules"
            :key="rule.description"
            :class="multiLineRow(rule.conditions) ? 'multi-conditions' : ''"
          >
            <td class="text-right">
              <v-icon v-if="!orderDisabled" class="handle mr-4" style="cursor: move">
                mdi-drag-horizontal-variant
              </v-icon>
              <span>{{ copyRules.findIndex(r => r.ruleId === rule.ruleId) + 1 }}</span>
            </td>
            <td>
              <v-checkbox v-model="rule.enabled" hide-details class="ma-0 pa-0" />
            </td>
            <td class="font-weight-bold">
              <div class="d-flex align-center">
                <span>{{ rule.description }}</span>
              </div>
            </td>
            <td v-html="conditionsCellRenderer(rule.conditions)"></td>
            <td class="font-weight-bold">
              <div class="d-flex align-center">
                <span>{{ rule.action.type }}</span>
              </div>
            </td>
            <td class="row-actions text-right">
              <v-btn icon dense @click="onRuleToggle(rule.ruleId)"><v-icon>mdi-pencil</v-icon></v-btn>
              <v-btn icon dense @click="onDeleteRule(rule.ruleId)"><v-icon>mdi-close</v-icon></v-btn>
            </td>
          </tr>
        </transition-group>
        <tr></tr>
      </v-simple-table>
    </v-card>
    <rule v-else ref="cpRules" :rule="selectedRule" :zone-items="zoneItems" @cancel="selectedRule = null">
      <template #actions="{ updatedRule }">
        <u-btn text :min-width="null" class="mr-2" @click="selectedRule = null">{{ $t('cancel') }}</u-btn>
        <u-btn :min-width="null" @click="onRuleUpdate(updatedRule)">
          {{ isAddRule ? $t('add') : $t('update') }}
        </u-btn>
      </template>
    </rule>
  </div>
</template>
<script>
  import { VCard, VRow, VCol, VDivider, VSimpleTable, VCheckbox, VIcon, VBtn } from 'vuetify/lib'
  import draggable from 'vuedraggable'
  import cloneDeep from 'lodash/cloneDeep'
  import { protocols } from '../../../constants'
  import util from '../../../plugins/util'
  import Rule from './Rule.vue'

  export default {
    components: {
      VCard,
      VRow,
      VCol,
      VDivider,
      VSimpleTable,
      VCheckbox,
      VIcon,
      VBtn,
      draggable,
      Rule,
    },
    props: {
      apps: { type: Array, default: () => [] },
      cpRules: { type: Array, default: () => [] },
      zoneData: { type: Array, default: () => [] },
    },
    data() {
      return {
        filter: {
          type: null,
          text: null,
          action: null,
        },
        selectedRule: null,
        protocols,
        zoneItems: [],
        isAddRule: true,
        drag: false,
        copyRules: [],
      }
    },
    computed: {
      orderDisabled: ({ filter }) => filter.text || filter.condition || filter.action,
      filteredRules: ({ cpRules, ruleFilter }) => cpRules.filter(ruleFilter),
      enabled: ({ $vuntangle }) => {
        return [
          { text: $vuntangle.$t('enable'), value: 'true' },
          { text: $vuntangle.$t('disable'), value: 'false' },
        ]
      },
      actionItems: ({ $vuntangle }) => {
        return [
          { text: $vuntangle.$t('enable'), value: 'enable' },
          { text: $vuntangle.$t('disable'), value: 'disable' },
        ]
      },
      ruleDesci: ({ cpRules, selectedRule }) => {
        const out = []
        cpRules.forEach(rule => {
          if (selectedRule.description !== rule.description) out.push(rule.description)
        })
        return out
      },
    },
    watch: {
      cpRules: {
        immediate: true,
        deep: true,
        handler(cpRules) {
          this.copyRules = cpRules ? cloneDeep(cpRules) : []
        },
      },
    },
    methods: {
      onEndDrag() {
        this.copyRules = this.filteredRules
        this.drag = false
        this.$emit('updateCPSettingsRule', this.copyRules)
      },
      ruleFilter(rule) {
        let textFilter = true
        let actFilter = true

        if (this.filter.text) {
          const text = this.filter.text.toLowerCase()
          if (!rule.description.toLowerCase().includes(text) && !rule.description?.toLowerCase().includes(text))
            textFilter = false
        }
        if (this.filter.type) {
          if (this.filter.type === 'enable' && rule.action.type !== 'ENABLE') actFilter = false
          if (this.filter.type === 'disable' && rule.action.type !== 'DISABLE') actFilter = false
        }
        return textFilter && actFilter
      },
      onRuleToggle(ruleId = null) {
        if (!ruleId) {
          this.selectedRule = {
            description: '',
            conditions: [{ type: '', op: '==', value: '' }],
            action: { type: null },
            ruleId: null,
          }
          this.isAddRule = true
        } else {
          this.isAddRule = false
          this.selectedRule = this.cpRules.find(rule => rule.ruleId === ruleId)
        }
        for (const zone of this.zoneData) {
          this.zoneItems.push({ text: zone.name, value: String(zone.name) })
        }
      },
      async onRuleUpdate(updatedRule) {
        const ruleIsValid = await this.$refs.cpRules.validate()
        if (!ruleIsValid) return
        if (!updatedRule.ruleId) updatedRule.ruleId = util.uuidv4()
        const index = this.cpRules.findIndex(rule => rule.description === this.selectedRule.description)
        this.$set(this.cpRules, index >= 0 ? index : this.cpRules.length, updatedRule)
        this.selectedRule = null
      },

      onDeleteRule(ruleId) {
        const index = this.cpRules.findIndex(rule => rule.ruleId === ruleId)
        this.$delete(this.cpRules, index)
      },

      clearFilters() {
        this.filter = {
          text: null,
          action: null,
        }
      },

      multiLineRow(conditions) {
        return conditions.length > 1
      },

      /**
       * conditions cell renderer to show readable data instead of id's for some condition values that require this
       */
      conditionsCellRenderer(conditions) {
        const text = []
        conditions.forEach(cond => {
          const conditionType = this.$t(cond.type.toLowerCase())
          let op = cond.op
          if (cond.op === '==') op = '='
          let value = cond.value
          if (cond.type === 'IP_PROTOCOL') {
            if (typeof cond.value === 'string') {
              cond.value = cond.value.split(',')
            }
            const values = []
            cond.value.forEach(protocol => values.push(protocols[protocol]))
            value = values.join(', ')
          }
          text.push(`<span class="font-weight-bold">${conditionType}</span> <span>${op}</span> ${value}`)
        })
        return text.join('<br/>')
      },

      reset() {
        this.selectedRule = null
      },
    },
  }
</script>
<style scoped lang="scss">
  tr.multi-conditions td {
    vertical-align: top;
    padding: 8px 16px !important;
    &:not(.row-actions) {
      padding: 16px !important;
    }
  }

  .cp-rules--full {
    display: flex;
    flex-direction: column;
    flex: 1;
  }
</style>
