<template>
  <v-card outlined style="flex-grow: 1">
    <v-card-title class="py-3 px-4">
      <span>{{ $t(`${!rule.ruleId ? 'cp_add_rule' : 'cp_edit_rule'}`) }}</span>
      <v-spacer />
      <slot name="actions" :updated-rule="ruleCopy"></slot>
    </v-card-title>
    <v-divider />
    <div class="pa-4">
      <ValidationObserver ref="obs">
        <ValidationProvider v-slot="{ errors }" rules="required">
          <u-text-field v-model="ruleCopy.description" :label="$t('description')" outlined>
            <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
          </u-text-field>
        </ValidationProvider>
        <div class="d-flex">
          <v-checkbox v-model="ruleCopy.enabled" :ripple="false" :label="$vuntangle.$t('rule_enabled')" hide-details />
        </div>

        <h3 class="mt-8 mb-2">{{ $t('conditions') }}</h3>

        <rule-conditions :conditions="ruleCopy.conditions" :zone-items="zoneItems" />
        <ValidationProvider v-slot="{ errors }" rules="required">
          <h3 class="mt-8">{{ $t('action') }}</h3>
          <div class="d-flex">
            <u-select
              v-model="ruleCopy.action.type"
              :items="actionItems"
              value="enable"
              :ripple="false"
              :label="$t('action')"
              hide-details
              class="my-0 mr-4"
            >
              <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template
            ></u-select>
          </div>
        </ValidationProvider>
      </ValidationObserver>
    </div>
  </v-card>
</template>
<script>
  import { VCard, VCardTitle, VSpacer, VDivider, VCheckbox } from 'vuetify/lib'
  import { ValidationObserver, ValidationProvider } from 'vee-validate'
  import cloneDeep from 'lodash/cloneDeep'
  import RuleConditions from './RuleConditions.vue'

  export default {
    components: {
      VCard,
      VCardTitle,
      VSpacer,
      VDivider,
      VCheckbox,
      ValidationObserver,
      RuleConditions,
      ValidationProvider,
    },
    props: {
      rule: { type: Object, default: () => null },
      zoneItems: { type: Array, required: true },
    },
    data: () => ({
      ruleCopy: null,
      actionItems: [
        { text: 'Enable', value: 'ENABLE' },
        { text: 'Disable', value: 'DISABLE' },
      ],
    }),
    watch: {
      rule: {
        handler(rule) {
          // Assign an identifiable ruleID to the new rules
          // This rule Id is not sent to the POST settings call
          if (!rule.ruleId) {
            rule.enabled = true
            rule.conditions = []
            rule.action = { type: 'ENABLE' }
          }
          this.ruleCopy = cloneDeep(rule)
        },
        immediate: true,
      },
    },

    methods: {
      async validate() {
        const isValid = await this.$refs.obs.validate()
        return isValid
      },
    },
  }
</script>
