<template>
  <v-container
    :fluid="classicView ? true : false"
    :class="`${classicView ? 'pa-4 ' : ''}shared-cmp d-flex flex-column fill-height align-stretch ${
      disabled ? 'disabled' : ''
    }`"
  >
    <div class="d-flex flex-column fill-height">
      <div class="d-flex align-center">
        <h1 v-if="classicView" class="headline">{{ $t('captive_portal') }}</h1>
        <h2 v-else class="font-weight-light">{{ $t('captive_portal') }}</h2>
        <v-spacer />
        <slot name="actions" :new-settings="settingsCopy" :is-dirty="isDirty" :defaults="$options.defaults" />
      </div>

      <v-divider class="my-2" />
      <p v-html="$t('captive_portal_description')" />
      <u-section v-if="!!$slots['extra-fields']">
        <slot name="extra-fields" />
      </u-section>
      <component :is="!$slots['extra-fields'] ? 'div' : 'u-section'" class="d-flex flex-column fill-height">
        <div class="d-flex">
          <v-switch
            v-model="settingsCopy.enabled"
            dense
            inset
            hide-details
            :label="$t('enabled')"
            :class="(!showRules ? 'mt-0 mb-4 ' : '') + 'mr-8'"
          />
        </div>
        <div v-if="showRules">
          <v-card :disabled="disabled" flat color="transparent" class="d-flex flex-column fill-height">
            <div class="d-flex flex-row align-center my-4">
              <v-divider />
              <v-btn-toggle v-model="selectedTab" dense rounded mandatory>
                <v-btn
                  v-for="tab in tabs"
                  :key="tab"
                  :value="tab"
                  :class="`${tab === selectedTab ? 'white--text' : ''} font-weight-bold px-8`"
                  active-class="primary"
                  min-width="150"
                >
                  {{ $t(tab) }}
                </v-btn>
              </v-btn-toggle>
              <v-divider />
            </div>
            <v-tabs-items v-model="selectedTab" class="cp-tab-items">
              <v-tab-item
                class="cp-tab-captiveport"
                value="cp_settings"
                :transition="false"
                :reverse-transition="false"
              >
                <tab-caps :settings="settingsCopy" />
              </v-tab-item>
              <v-tab-item class="cp-tab-rules" value="cp_rules" :transition="false" :reverse-transition="false">
                <tab-cap-rules
                  ref="cpRules"
                  :cp-rules="settingsCopy.rules"
                  :zone-data="zoneData.interfaces"
                  @updateCPSettingsRule="updateCPSettingsRule"
                />
              </v-tab-item>
            </v-tabs-items>
          </v-card>
        </div>
        <div v-else><tab-caps :settings="settingsCopy" /></div>
      </component>
    </div>
  </v-container>
</template>
<script>
  import { VContainer, VDivider, VSwitch, VCard, VBtn, VBtnToggle, VTabItem, VTabsItems, VSpacer } from 'vuetify/lib'
  import settingsMixin from '../settingsMixin'
  import defaults from './defaults'
  import schema from './schema'
  import TabCaps from './components/TabCaps.vue'
  import TabCapRules from './components/TabCapRules.vue'

  export default {
    components: {
      VContainer,
      VDivider,
      VSwitch,
      VCard,
      VBtn,
      VBtnToggle,
      VTabItem,
      VTabsItems,
      VSpacer,

      TabCaps,
      TabCapRules,
    },

    // add the generic settings mixin
    mixins: [settingsMixin],

    // attach `defaults` and `schema` to the component $options as no reactive data
    defaults,
    schema,
    props: {
      showRules: {
        type: Boolean,
        default: true,
      },
      zoneData: {
        type: Object,
        default: () => {},
      },
    },
    data() {
      return {
        selectedTab: 'cp_settings',
      }
    },
    computed: {
      tabs() {
        return ['cp_settings', 'cp_rules']
      },
    },
    watch: {
      selectedTab() {
        // when switching from caps reset its view
        if (this.$refs.cpRules) this.$refs.cpRules.reset()
      },
    },
    methods: {
      updateCPSettingsRule(data) {
        this.settingsCopy.rules = data
      },
    },
  }
</script>
<style>
  .cp-tab-items {
    overflow: visible;
    background-color: transparent;
  }

  .cp-tab-items,
  .cp-tab-rules,
  .cp-tab-captiveport {
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .cp-tab-items .v-window__container {
    flex: 1;
  }
</style>
