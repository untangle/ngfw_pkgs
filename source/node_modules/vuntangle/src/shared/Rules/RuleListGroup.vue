<template>
  <transition-group
    is="draggable"
    v-if="rules.length"
    :list="rules"
    tag="tbody"
    :name="!drag ? 'flip-list' : null"
    animation="500"
    handle=".handle"
    @start="drag = true"
    @end="onEndDrag"
  >
    <tr v-for="rule in rules" :key="rule.ruleId" :class="rule.conditions.length > 1 ? 'multi-conditions' : ''">
      <td class="text-right">
        <v-icon v-if="!orderDisabled && !disabled" class="handle mr-4" style="cursor: move">
          mdi-drag-horizontal-variant
        </v-icon>
        <span>{{ rules.findIndex(r => r.ruleId === rule.ruleId) + 1 }}</span>
      </td>
      <td class="text-right">
        <v-simple-checkbox
          :value="rule.enabled"
          :disabled="rule.readOnly || disabled"
          :ripple="false"
          class="ma-0 pa-0"
          color="primary"
          @input="event => $emit('toggle-rule', rule.ruleId, event)"
        />
      </td>
      <td class="font-weight-bold">{{ rule.description }}</td>
      <td v-html="conditionsCellRenderer(rule.conditions)"></td>
      <td v-if="ruleType !== 'bypass'" class="font-weight-bold" v-html="actionCellRenderer(rule.action)"></td>
      <td v-else>{{ rule.log }}</td>
      <td class="row-actions text-right">
        <v-btn v-if="!rule.readOnly" icon dense :disabled="disabled" @click="$emit('edit-rule', rule.ruleId)">
          <v-icon>mdi-pencil</v-icon>
        </v-btn>
        <v-btn v-if="!rule.readOnly" icon dense :disabled="disabled" @click="onDeleteRule(rule)">
          <v-icon>mdi-close</v-icon>
        </v-btn>
      </td>
    </tr>
  </transition-group>
</template>
<script>
  import { VSimpleCheckbox, VIcon, VBtn } from 'vuetify/lib'

  import draggable from 'vuedraggable'
  import util from '../../plugins/util'

  import {
    priorities,
    protocols,
    limitRateUnits,
    limitBurstUnits,
    productivityLevels,
    limitExceedActions,
    addressTypes,
    interfaceTypes,
  } from '../../constants'

  export default {
    components: {
      VSimpleCheckbox,
      VIcon,
      VBtn,

      draggable,
    },
    props: {
      // the actual rules list to be listed/edited
      rules: { type: Array, default: () => [] },
      ruleType: { type: String, default: undefined },

      /**
       * contains remote wanPolicies and zoneInterfaces needed for data rendering
       * `wanPolicies` expected as policies array [{ policyId, description, etc.. }]
       * `zoneInterfaces` expected as options array with name and id (e.g. { text: 'interface_name', value: 2 })
       */
      remoteData: { type: Object, default: () => ({ wanPolicies: undefined, zoneInterfaces: undefined }) },

      disabled: { type: Boolean, default: false },
      orderDisabled: { type: Boolean },
    },
    data: () => ({
      drag: false,
    }),

    methods: {
      /**
       * updates the rules after order is changed
       */
      onEndDrag() {
        this.drag = false
        this.$emit('rules-reorder', this.rules)
      },

      /**
       * confirmation dialog when deleting a rule
       *
       * @param rule rule to be deleted
       */
      onDeleteRule(rule) {
        this.$vuntangle.confirm.show({
          title: `<i class="mdi mdi-alert" style="font-style: normal;"> ${this.$vuntangle.$t('confirm')}</i>`,
          message: this.$vuntangle.$t('remove_rule', [rule.description]),
          confirmLabel: this.$vuntangle.$t('yes'),
          cancelLabel: this.$vuntangle.$t('no'),
          action: async resolve => {
            await this.$emit('delete-rule', rule.ruleId)
            resolve()
          },
        })
      },

      /**
       * conditions cell renderer to show readable data instead of id's for some condition values that require this
       */
      conditionsCellRenderer(conditions) {
        // MFW-2671 display `no conditions` if not present
        if (!conditions.length) {
          return this.$vuntangle.$t('no_conditions')
        }
        const text = []
        conditions.forEach(cond => {
          const conditionType = this.$vuntangle.$t(cond.type.toLowerCase())
          let op = cond.op
          if (cond.op === '==') {
            op = '='
          }

          let value
          const type = cond.type.replace('_INFERRED', '')
          switch (type) {
            /**
             * app category is in english and retrieved via apps classify (e.g. `Streaming Media`)
             * translations are still applied to them
             */
            case 'APPLICATION_CATEGORY':
              value = this.$vuntangle.$t(cond.value.replace(/ /g, '_').toLowerCase())
              break

            case 'SOURCE_INTERFACE_ZONE':
            case 'DESTINATION_INTERFACE_ZONE':
            case 'CLIENT_INTERFACE_ZONE':
            case 'SERVER_INTERFACE_ZONE':
              value = this.remoteData?.zoneInterfaces.find(intf => intf.value === cond.value)
              value = value?.text
              break

            case 'CLIENT_INTERFACE_TYPE':
            case 'SERVER_INTERFACE_TYPE':
            case 'SOURCE_INTERFACE_TYPE':
            case 'DESTINATION_INTERFACE_TYPE':
              value = this.$vuntangle.$t(interfaceTypes[cond.value])
              break

            case 'APPLICATION_PRODUCTIVITY':
            case 'APPLICATION_RISK':
              value = this.$vuntangle.$t(productivityLevels[cond.value])
              break

            case 'SOURCE_ADDRESS_TYPE':
            case 'DESTINATION_ADDRESS_TYPE':
              value = this.$vuntangle.$t(addressTypes[cond.value])
              break

            case 'SOURCE_PORT':
            case 'DESTINATION_PORT':
              if (Array.isArray(cond.port_protocol)) {
                value = []
                cond.port_protocol.forEach(p => value.push(protocols[p]))
                value = value.join(', ')
              } else {
                value = protocols[cond.port_protocol]
              }
              value = `${cond.value} (${value})`
              break

            case 'GEOIP':
              value = util.country_codes[cond.value]
              break

            case 'CT_STATE':
              value = this.$vuntangle.$t(cond.value)
              break

            case 'IP_PROTOCOL':
              value = []
              cond.value = cond.value.toString()
              cond.value.split(',').forEach(protocol => value.push(protocols[protocol]))
              value = value.join(', ')
              break

            case 'LIMIT_RATE':
              value = this.$vuntangle.$t(limitRateUnits[cond.rate_unit])
              value = `${cond.value} ${value}`
              break

            case 'BURST_SIZE':
              value = this.$vuntangle.$t(limitBurstUnits[cond.burst_unit])
              value = `${cond.value} ${value}`
              break

            default:
              value = cond.value
          }
          text.push(
            `<span class="font-weight-bold">${conditionType}</span> <span class="cond-op">${op}</span> ${value}`,
          )
        })
        return text.join('<br/>')
      },

      /**
       * action cell renderer for each possible action type
       */
      actionCellRenderer(action) {
        if (!action) return this.$vuntangle.$t('bypass')
        switch (action.type) {
          case 'ACCEPT':
          case 'REJECT':
          case 'DROP':
          case 'MASQUERADE':
            return this.$vuntangle.$t(`rule_action_${action.type.toLowerCase()}`)
          case 'DNAT':
            return `${this.$vuntangle.$t('rule_action_dnat')}:
                 ${action.dnat_address}${action.dnat_port ? ':' + action.dnat_port : ''}`
          case 'SET_PRIORITY':
            return this.$vuntangle.$t(priorities[action.priority])
          case 'LIMIT_EXCEED_ACTION':
            return this.$vuntangle.$t(limitExceedActions[action.limit_exceed_action])
          case 'SNAT':
            return `${this.$vuntangle.$t('rule_action_snat')}: ${action.snat_address}`
          case 'WAN_POLICY':
            return this.remoteData.wanPolicies.find(p => p.policyId === action.policy)?.description || ''
        }
      },
    },
  }
</script>
<style lang="scss">
  tr:hover {
    background: none !important;
  }
  tr.multi-conditions td {
    vertical-align: top;
    padding: 8px 16px !important;
    &:not(.row-actions) {
      padding: 16px !important;
    }
  }

  td span.cond-op {
    display: inline-block;
    border-radius: 3px;
    width: 24px;
    font-weight: bold;
    text-align: center;
    line-height: 1.25;
  }
</style>
