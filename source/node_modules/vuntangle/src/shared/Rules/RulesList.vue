<template>
  <v-container>
    <div class="d-flex align-center">
      <h1 v-if="classicView" class="headline">{{ title }}</h1>
      <h2 v-else class="font-weight-light">{{ title }}</h2>
      <v-spacer />
      <!-- #action slot used in parent component for action buttons -->
      <slot name="actions" :updated-rules="rulesCopy" :updated-etm-rules="etmRulesCopy"></slot>
    </div>

    <v-divider class="my-2" />

    <p class="body-2 my-4">
      <span v-if="description">{{ description }}<br /></span>
      {{ $vuntangle.$t('rules_executed_in_order') }}
    </p>

    <u-section v-if="!!$slots['extra-fields']">
      <slot name="extra-fields" />
    </u-section>

    <component :is="!$slots['extra-fields'] ? 'div' : 'u-section'">
      <v-card outlined>
        <v-row dense class="d-flex flex-grow-0 mx-2 my-1" align="center">
          <v-col cols="3"><u-text-field v-model="filter.text" :label="$vuntangle.$t('filter')" /></v-col>
          <v-col cols="4">
            <u-select
              v-model="filter.condition"
              :items="ruleDefs[ruleType].conditions"
              :label="$vuntangle.$t('condition_type')"
            >
              <template #selection="{ item }">{{ $vuntangle.$t(item.toLowerCase()) }}</template>
              <template #item="{ item }">{{ $vuntangle.$t(item.toLowerCase()) }}</template>
            </u-select>
          </v-col>
          <v-col v-if="ruleDefs[ruleType].actions && ruleDefs[ruleType].actions.length > 1" cols="2">
            <u-select v-model="filter.action" :items="ruleDefs[ruleType].actions" :label="$vuntangle.$t('action')">
              <template #selection="{ item }">{{ $vuntangle.$t(`rule_action_${item.toLowerCase()}`) }}</template>
              <template #item="{ item }">{{ $vuntangle.$t(`rule_action_${item.toLowerCase()}`) }}</template>
            </u-select>
          </v-col>
          <v-col>
            <div class="d-flex caption align-center">
              <u-btn v-if="orderDisabled" :small="false" :min-width="null" outlined @click="clearFilters">
                {{ $vuntangle.$t('clear') }}
              </u-btn>
              <v-spacer />
              {{
                $vuntangle.$t('showing_filtered_rules', [
                  filteredRules.length + etmFilteredRules.length,
                  rulesCopy.length + etmRulesCopy.length,
                ])
              }}
            </div>
          </v-col>
        </v-row>

        <v-divider />

        <v-simple-table fixed-header>
          <thead>
            <tr>
              <th style="width: 90px" class="text-center">{{ $vuntangle.$t('order') }}</th>
              <th style="width: 60px">{{ $vuntangle.$t('enabled') }}</th>
              <th style="width: 25%">{{ $vuntangle.$t('description') }}</th>
              <th>{{ $vuntangle.$t('conditions') }}</th>
              <th style="width: 25%">
                {{ ruleType !== 'bypass' ? $vuntangle.$t('action') : $vuntangle.$t('log') }}
              </th>
              <th style="width: 120px"></th>
            </tr>
          </thead>
          <!-- show no rules meets filter and clear filter button -->
          <tbody v-if="showEmptyFilter">
            <tr>
              <td colspan="6" class="text-center">
                <br /><br />
                <span>{{ $vuntangle.$t('no_rule_meets_filter') }}</span>
                <br /><br />
                <u-btn outlined @click="clearFilters">{{ $vuntangle.$t('clear_filters') }}</u-btn>
                <br /><br /><br />
              </td>
            </tr>
          </tbody>

          <!-- show no rules defined -->
          <tbody v-if="showNoRules">
            <tr>
              <td colspan="6" class="text-center">
                <br /><br />
                <span>{{ $vuntangle.$t('no_rules_defined') }}</span>
                <br /><br /><br />
              </td>
            </tr>
          </tbody>

          <tbody v-if="etmRules.length">
            <tr v-if="etmFilteredRules.length > 0">
              <td colspan="6" class="font-weight-bold body-1" style="background: rgba(200, 200, 200, 0.2)">
                <div class="d-flex align-center">
                  <span>{{ $vuntangle.$t('etm_defined_rules') }}</span>
                  <v-spacer />
                  <!-- slot used for MFW specific action to redirect to etm rules editing -->
                  <slot name="etm-rules"></slot>
                </div>
              </td>
            </tr>
          </tbody>

          <!--etm rules-->
          <rule-list-group
            :rules="etmFilteredRules"
            :remote-data="remoteData"
            :order-disabled="orderDisabled || disableEtmRules"
            :disabled="disabled || disableEtmRules"
            @rules-reorder="rules => onRulesReorder(rules, true)"
            @toggle-rule="(ruleId, isEnabled) => onToggleRule(ruleId, isEnabled, true)"
            v-on="$listeners"
          />

          <tbody v-if="etmRules.length && filteredRules.length > 0">
            <tr>
              <td colspan="6" class="font-weight-bold body-1" style="background: rgba(200, 200, 200, 0.2)">
                {{ $vuntangle.$t('local_defined_rules') }}
              </td>
            </tr>
          </tbody>

          <rule-list-group
            :rules="filteredRules"
            :rule-type="ruleType"
            :remote-data="remoteData"
            :order-disabled="orderDisabled"
            :disabled="disabled"
            @rules-reorder="onRulesReorder"
            @toggle-rule="onToggleRule"
            v-on="$listeners"
          />
        </v-simple-table>
      </v-card>
    </component>
  </v-container>
</template>
<script>
  import {
    VContainer,
    VSpacer,
    VDivider,
    VCard,
    VRow,
    VCol,
    VSimpleTable,
    VSimpleCheckbox,
    VIcon,
    VBtn,
  } from 'vuetify/lib'

  import cloneDeep from 'lodash/cloneDeep'
  import draggable from 'vuedraggable'
  import USection from '../../components/USection/USection.vue'

  import { ruleDefs } from '../Conditions/data/rulesDefinitions'
  import RuleListGroup from './RuleListGroup.vue'

  export default {
    components: {
      VContainer,
      VSpacer,
      VDivider,
      VCard,
      VRow,
      VCol,
      VSimpleTable,
      VSimpleCheckbox,
      VIcon,
      VBtn,

      draggable,
      USection,
      RuleListGroup,
    },
    props: {
      title: { type: String, default: null },

      // extra rules description text (e.g. shaping rules have an extra description)
      description: { type: String, default: null },
      // rules type (e.g. 'wan-rules', 'nat', 'shaping' etc...)
      ruleType: { type: String, default: null },
      // the actual rules list to be listed/edited
      rules: { type: Array, default: () => [] },

      // ETM readonly wan rules ( from command center)
      etmRules: { type: Array, default: () => [] },

      /**
       * contains remote wanPolicies and zoneInterfaces needed for data rendering
       * `wanPolicies` expected as policies array [{ policyId, description, etc.. }]
       * `zoneInterfaces` expected as options array with name and id (e.g. { text: 'interface_name', value: 2 })
       */
      remoteData: { type: Object, default: () => ({ wanPolicies: undefined, zoneInterfaces: undefined }) },

      classicView: { type: Boolean, default: false },
      disabled: { type: Boolean, default: false },
      disableEtmRules: { type: Boolean, default: false },
    },
    data: () => ({
      rulesCopy: [],
      etmRulesCopy: [],
      filter: {
        text: null,
        condition: null,
        action: null,
      },
      ruleDefs,
    }),

    computed: {
      /**
       * rules shown in the table based on filter
       */
      filteredRules: ({ rulesCopy, ruleFilter }) => rulesCopy.filter(ruleFilter),

      /**
       * etm rules shown in the table based on filter
       */
      etmFilteredRules: ({ etmRulesCopy, ruleFilter }) => etmRulesCopy.filter(ruleFilter),

      /**
       * when filter is applied, the manual order is disabled to avoid inconsistency
       */
      orderDisabled: ({ filter }) => !!(filter.text || filter.condition || filter.action),

      // compute empty filter
      showEmptyFilter: ({ rulesCopy, filteredRules, etmRulesCopy, etmFilteredRules }) => {
        return rulesCopy.length + etmRulesCopy.length > 0 && filteredRules.length + etmFilteredRules.length === 0
      },

      // compute no rules
      showNoRules: ({ rulesCopy, etmRulesCopy }) => {
        return !rulesCopy.length && !etmRulesCopy.length
      },
    },

    watch: {
      // updated working rules on rules prop change
      rules: {
        immediate: true,
        deep: true,
        handler(value) {
          this.rulesCopy = cloneDeep(value).filter(item => !item.isHidden)
        },
      },
      // updated working rules on rules prop change
      etmRules: {
        immediate: true,
        deep: true,
        handler(value) {
          this.etmRulesCopy = cloneDeep(value).filter(item => !item.isHidden)
        },
      },
    },

    methods: {
      /**
       * filter rules based on condition type, rule action or generic text
       */
      ruleFilter(rule) {
        if (!rule.action) return true
        const actionObjectvalues = Object.values(rule.action)
        if (
          this.filter.text &&
          actionObjectvalues.length > 0 &&
          actionObjectvalues.some(item => item.toString().toLowerCase().includes(this.filter.text.toLowerCase()))
        ) {
          return true
        }

        if (
          (this.filter.condition && rule.conditions.findIndex(cond => cond.type.includes(this.filter.condition)) < 0) ||
          (this.filter.action && rule.action.type !== this.filter.action) ||
          (this.filter.text && !rule.description.toLowerCase().includes(this.filter.text.toLowerCase()))
        ) {
          return false
        }
        return true
      },

      clearFilters() {
        this.filter.text = null
        this.filter.condition = null
        this.filter.action = null
      },

      /**
       * called when rule's enabled state is toggled
       * @param ruleId id of the rule
       * @param isEnabled flag depicting if rule was enabled or disabled
       * @param etmRuleChain flag to detect if etm rule chain was toggled
       */
      onToggleRule(ruleId, isEnabled, etmRuleChain = false) {
        const list = etmRuleChain ? this.etmRulesCopy : this.rulesCopy
        const rule = list.find(rule => rule.ruleId === ruleId)
        if (rule) {
          rule.enabled = isEnabled
        }
      },

      /**
       * called on rules re-order
       * @param rules new ordered list of rules
       * @param etmRuleChain flag to detect if etm rule chain was reordered
       */
      onRulesReorder(rules, etmRuleChain = false) {
        if (etmRuleChain) {
          this.etmRulesCopy = rules
        } else {
          this.rulesCopy = rules
        }
      },
    },
  }
</script>
