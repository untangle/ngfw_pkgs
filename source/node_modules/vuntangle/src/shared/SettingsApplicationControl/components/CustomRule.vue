<template>
  <v-card outlined style="flex-grow: 1">
    <v-card-title class="py-3 px-4">
      <span>{{ $t(`${!rule.name ? 'ac_add_custom_rule' : 'ac_edit_custom_rule'}`) }}</span>
      <v-spacer />
      <slot name="actions" :updated-rule="ruleCopy"></slot>
    </v-card-title>
    <v-divider />
    <div class="pa-4">
      <ValidationObserver ref="obs">
        <v-row dense>
          <v-col cols="6">
            <ValidationProvider
              v-slot="{ errors }"
              :rules="{
                required: true,
                unique_insensitive: { list: ruleNames, message: $t('ac_rule_name_already_used') },
              }"
            >
              <u-text-field v-model="ruleCopy.name" :label="$t('name')" :error-messages="errors">
                <template v-if="errors.length" #append>
                  <u-errors-tooltip :errors="errors" />
                </template>
              </u-text-field>
            </ValidationProvider>
          </v-col>

          <v-col cols="6">
            <ValidationProvider v-slot="{ errors }" rules="required">
              <u-select v-model="ruleCopy.category" :items="categories" :label="$t('category')">
                <template #selection="{ item }">{{ $t(item.replace(/ /g, '_').toLowerCase()) }}</template>
                <template #item="{ item }">{{ $t(item.replace(/ /g, '_').toLowerCase()) }}</template>
                <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
              </u-select>
            </ValidationProvider>
          </v-col>
        </v-row>
        <v-row dense>
          <v-col cols="12">
            <u-text-field v-model="ruleCopy.description" :label="$t('description')" />
          </v-col>
        </v-row>

        <h3 class="mt-8 mb-2">{{ $t('conditions') }}</h3>

        <custom-rule-conditions :conditions="ruleCopy.conditions" />

        <h3 class="mt-8">{{ $t('action') }}</h3>
        <div class="d-flex">
          <v-checkbox
            v-model="ruleCopy.action"
            value="reject"
            :ripple="false"
            :label="$t('reject')"
            hide-details
            class="my-0 mr-4"
            @change="onChange($event, ruleCopy, 'REJECT')"
          />
          <v-checkbox
            v-model="ruleCopy.action"
            value="block"
            :ripple="false"
            :label="$t('block')"
            hide-details
            class="my-0 mr-4"
            @change="onChange($event, ruleCopy, 'BLOCK')"
          />
          <v-checkbox
            v-model="ruleCopy.flag"
            value="flag"
            :ripple="false"
            :label="$t('flag')"
            hide-details
            class="my-0 mr-4"
            :disabled="ruleCopy.disabled"
            @change="onChange($event, ruleCopy, 'FLAG')"
          />
          <v-checkbox
            v-model="ruleCopy.action"
            value="bypass"
            :ripple="false"
            :label="$t('bypass')"
            hide-details
            class="my-0 mr-4"
            @change="onChange($event, ruleCopy, 'BYPASS')"
          />
        </div>
      </ValidationObserver>
    </div>
  </v-card>
</template>
<script>
  import { VCard, VCardTitle, VSpacer, VDivider, VRow, VCol, VCheckbox } from 'vuetify/lib'
  import { ValidationObserver, ValidationProvider } from 'vee-validate'
  import cloneDeep from 'lodash/cloneDeep'
  import CustomRuleConditions from './CustomRuleConditions.vue'

  export default {
    components: {
      VCard,
      VCardTitle,
      VSpacer,
      VDivider,
      VRow,
      VCol,
      VCheckbox,
      ValidationObserver,
      ValidationProvider,

      CustomRuleConditions,
    },
    props: {
      rule: { type: Object, default: () => null },
      categories: { type: Array, default: () => [] },
      ruleNames: { type: Array, default: () => [] },
    },
    data: () => ({
      ruleCopy: null,
      levels: [
        { text: 'lowest', value: 1 },
        { text: 'low', value: 2 },
        { text: 'medium', value: 3 },
        { text: 'high', value: 4 },
        { text: 'highest', value: 5 },
      ],
    }),
    watch: {
      rule: {
        handler(rule) {
          this.ruleCopy = cloneDeep(rule)
        },
        immediate: true,
      },
    },

    methods: {
      onChange(checked, rule, value) {
        if (checked === 'reject' || checked === 'block') {
          // Show Flag whenever reject/block is checked
          rule.flag = 'flag'
          rule.disabled = true
        } else if (checked === null && (value === 'REJECT' || value === 'BLOCK')) {
          // Remove Flag whenever reject/block is unchecked
          rule.flag = ''
          rule.disabled = false
        } else if (checked === 'flag') {
          rule.action = 'flag'
        } else {
          rule.flag = ''
          rule.disabled = false
        }
      },
      async validate() {
        const isValid = await this.$refs.obs.validate()
        return isValid
      },
    },
  }
</script>
