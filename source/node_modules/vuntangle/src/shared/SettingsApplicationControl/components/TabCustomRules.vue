<template>
  <div class="ac-custom-rules--full">
    <v-card v-if="!selectedRule" class="ac-custom-rules--full" outlined>
      <v-row dense class="pa-2 align-center" style="flex-grow: 0">
        <v-col cols="2">
          <u-text-field v-model="filter.text" :label="$t('filter')" clearable></u-text-field>
        </v-col>
        <v-col cols="3">
          <u-select v-model="filter.category" :items="appCategories" clearable :label="$t('category')">
            <template #selection="{ item }">{{ $t(item.replace(/ /g, '_').toLowerCase()) }}</template>
            <template #item="{ item }">{{ $t(item.replace(/ /g, '_').toLowerCase()) }}</template>
          </u-select>
        </v-col>
        <v-col cols="3">
          <u-select v-model="filter.action" :items="actionItems" clearable :label="$t('action')" />
        </v-col>
        <v-col>
          <div class="caption">
            {{ $t('filtered_text', { filtered: filteredRules.length, total: customRules.length }) }}
          </div>
        </v-col>
        <v-col class="text-right">
          <u-btn :min-width="null" @click="onRuleToggle()">{{ $t('ac_add_rule') }}</u-btn>
        </v-col>
      </v-row>
      <v-divider />
      <div v-if="filteredRules.length === 0 && customRules.length > 0" class="body-2 text-center my-8">
        <p>{{ $t('no_rule_meets_filter') }}</p>
        <u-btn outlined @click="clearFilters">{{ $t('clear_filters') }}</u-btn>
      </div>
      <div v-if="customRules.length === 0" class="body-2 text-center my-8 ac-custom-rules-full">
        <p>{{ $t('ac_no_custom_rules_defined') }}</p>
      </div>

      <v-simple-table v-if="filteredRules.length > 0" fixed-header>
        <thead>
          <tr>
            <th style="width: 50px">{{ $t('reject') }}</th>
            <th style="width: 50px">{{ $t('block') }}</th>
            <th style="width: 50px">{{ $t('flag') }}</th>
            <th style="width: 50px">{{ $t('bypass') }}</th>
            <th style="width: 20%">{{ $t('ac_rule_name') }}</th>
            <th style="width: 20%">{{ $t('category') }}</th>
            <th>{{ $t('conditions') }}</th>
            <th style="width: 120px"></th>
          </tr>
        </thead>
        <tbody>
          <tr
            v-for="rule in filteredRules"
            :key="rule.name"
            :class="multiLineRow(rule.conditions) ? 'multi-conditions' : ''"
          >
            <td>
              <v-checkbox
                v-model="rule.action"
                value="reject"
                :ripple="false"
                hide-details
                class="ma-0 pa-0"
                @change="onChange($event, rule, 'REJECT')"
              />
            </td>
            <td>
              <v-checkbox
                v-model="rule.action"
                value="block"
                :ripple="false"
                hide-details
                class="ma-0 pa-0"
                @change="onChange($event, rule, 'BLOCK')"
              />
            </td>
            <td>
              <v-checkbox
                v-model="rule.flag"
                value="flag"
                :ripple="false"
                hide-details
                class="ma-0 pa-0"
                :disabled="rule.disabled"
                @change="onChange($event, rule, 'FLAG')"
              />
            </td>
            <td>
              <v-checkbox
                v-model="rule.action"
                value="bypass"
                :ripple="false"
                hide-details
                class="ma-0 pa-0"
                @change="onChange($event, rule, 'BYPASS')"
              />
            </td>
            <td class="font-weight-bold">
              <div class="d-flex align-center">
                <span class="mr-2">{{ rule.name }}</span>
                <v-tooltip v-if="rule.description" right transition="fade">
                  <template #activator="{ on }">
                    <v-icon v-on="on">mdi-information-outline</v-icon>
                  </template>
                  <span>{{ rule.description }}</span>
                </v-tooltip>
              </div>
            </td>
            <td>{{ $t(rule.category.replace(/ /g, '_').toLowerCase()) }}</td>
            <td v-html="conditionsCellRenderer(rule.conditions)"></td>
            <td class="row-actions text-right">
              <v-btn icon dense @click="onRuleToggle(rule.name)"><v-icon>mdi-pencil</v-icon></v-btn>
              <v-btn icon dense @click="onDeleteRule(rule.name)"><v-icon>mdi-close</v-icon></v-btn>
            </td>
          </tr>
          <tr></tr>
        </tbody>
      </v-simple-table>
    </v-card>
    <custom-rule
      v-else
      ref="customRules"
      :rule="selectedRule"
      :categories="appCategories"
      :rule-names="ruleNames"
      @cancel="selectedRule = null"
    >
      <template #actions="{ updatedRule }">
        <u-btn :min-width="null" class="mr-2" @click="selectedRule = null">{{ $t('cancel') }}</u-btn>
        <u-btn :min-width="null" @click="onRuleUpdate(updatedRule)">
          {{ !selectedRule.name ? $t('add') : $t('update') }}
        </u-btn>
      </template>
    </custom-rule>
  </div>
</template>
<script>
  import { VCard, VRow, VCol, VDivider, VSimpleTable, VCheckbox, VTooltip, VIcon, VBtn } from 'vuetify/lib'
  import { protocols } from '../../../constants'
  import CustomRule from './CustomRule.vue'

  export default {
    components: {
      VCard,
      VRow,
      VCol,
      VDivider,
      VSimpleTable,
      VCheckbox,
      VTooltip,
      VIcon,
      VBtn,

      CustomRule,
    },
    props: {
      apps: { type: Array, default: () => [] },
      customRules: { type: Array, default: () => [] },
    },
    data() {
      return {
        filter: {
          text: null,
          category: null,
          action: null,
        },
        selectedRule: null,
        protocols,
      }
    },
    computed: {
      appCategories: ({ apps }) => [...new Set(apps.map(app => app.category))].sort(),
      filteredRules: ({ customRules, ruleFilter }) => customRules.filter(ruleFilter),
      actionItems: ({ $vuntangle }) => {
        return [
          { text: $vuntangle.$t('reject'), value: 'reject' },
          { text: $vuntangle.$t('block'), value: 'block' },
          { text: $vuntangle.$t('flag'), value: 'flag' },
          { text: $vuntangle.$t('bypass'), value: 'bypass' },
        ]
      },
      ruleNames: ({ customRules, selectedRule }) => {
        const out = []
        customRules.forEach(rule => {
          if (selectedRule.name !== rule.name) out.push(rule.name)
        })
        return out
      },
    },
    methods: {
      onChange(checked, rule, value) {
        if (checked === 'reject' || checked === 'block') {
          // Show Flag whenever reject/block is checked
          rule.flag = 'flag'
          rule.disabled = true
        } else if (checked === null && (value === 'REJECT' || value === 'BLOCK')) {
          // Remove Flag whenever reject/block is unchecked
          rule.flag = ''
          rule.disabled = false
        } else if (checked === 'flag') {
          rule.action = 'flag'
        } else {
          rule.flag = ''
          rule.disabled = false
        }
      },
      ruleFilter(rule) {
        let catFilter = true
        let textFilter = true
        let actFilter = true

        if (this.filter.category) {
          if (rule.category.toLowerCase() !== this.filter.category.toLowerCase()) catFilter = false
        }
        if (this.filter.text) {
          const text = this.filter.text.toLowerCase()
          if (!rule.name.toLowerCase().includes(text) && !rule.description?.toLowerCase().includes(text))
            textFilter = false
        }
        if (this.filter.action) {
          if (this.filter.action === 'reject' && rule.action !== 'reject') actFilter = false
          if (this.filter.action === 'block' && rule.action !== 'block') actFilter = false
          if (this.filter.action === 'flag' && rule.action !== 'flag') actFilter = false
          if (this.filter.action === 'bypass' && rule.action !== 'bypass') actFilter = false
        }
        return catFilter && textFilter && actFilter
      },
      onRuleToggle(name = null) {
        if (!name) {
          this.selectedRule = {
            name: '',
            category: '',
            conditions: [{ type: '', op: '==', value: '' }],
            action: null,
          }
        } else {
          this.selectedRule = this.customRules.find(rule => rule.name === name)
        }
      },
      async onRuleUpdate(updatedRule) {
        const ruleIsValid = await this.$refs.customRules.validate()
        if (!ruleIsValid) return

        const index = this.customRules.findIndex(rule => rule.name === this.selectedRule.name)
        this.$set(this.customRules, index >= 0 ? index : this.customRules.length, updatedRule)
        this.selectedRule = null
      },

      onDeleteRule(name) {
        const index = this.customRules.findIndex(rule => rule.name === name)
        this.$delete(this.customRules, index)
      },

      clearFilters() {
        this.filter = {
          text: null,
          category: null,
          action: null,
        }
      },

      multiLineRow(conditions) {
        return conditions.length > 1
      },

      /**
       * conditions cell renderer to show readable data instead of id's for some condition values that require this
       */
      conditionsCellRenderer(conditions) {
        const text = []
        conditions.forEach(cond => {
          const conditionType = this.$t(cond.type.toLowerCase())
          let op = cond.op
          if (cond.op === '==') op = '='
          let value = cond.value
          if (cond.type === 'PORT_PROTOCOL') {
            if (typeof cond.value === 'string') {
              cond.value = cond.value.split(',')
            }
            const values = []
            cond.value.forEach(protocol => values.push(protocols[protocol]))
            value = values.join(', ')
          }
          text.push(`<span class="font-weight-bold">${conditionType}</span> <span>${op}</span> ${value}`)
        })
        return text.join('<br/>')
      },

      reset() {
        this.selectedRule = null
      },
    },
  }
</script>
<style scoped lang="scss">
  tr.multi-conditions td {
    vertical-align: top;
    padding: 8px 16px !important;
    &:not(.row-actions) {
      padding: 16px !important;
    }
  }

  .ac-custom-rules--full {
    display: flex;
    flex-direction: column;
    flex: 1;
  }
</style>
