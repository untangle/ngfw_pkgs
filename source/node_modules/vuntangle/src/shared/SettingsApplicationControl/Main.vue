<template>
  <v-container
    :fluid="classicView ? true : false"
    :class="`${classicView ? 'pa-4 ' : ''}shared-cmp d-flex flex-column fill-height align-stretch ${
      disabled ? 'disabled' : ''
    }`"
  >
    <div class="d-flex flex-column fill-height">
      <div class="d-flex align-center">
        <h1 v-if="classicView" class="headline">{{ $t('application_control') }}</h1>
        <h2 v-else class="font-weight-light">{{ $t('application_control') }}</h2>
        <v-spacer />
        <slot name="actions" :new-settings="settingsCopy" :is-dirty="isDirty" :defaults="$options.defaults" />
      </div>

      <v-divider class="my-2" />
      <u-section v-if="!!$slots['extra-fields']">
        <slot name="extra-fields" />
      </u-section>
      <component :is="!$slots['extra-fields'] ? 'div' : 'u-section'" class="d-flex flex-column fill-height">
        <div class="d-flex">
          <v-switch v-model="settingsCopy.enabled" dense inset hide-details :label="$t('enabled')" class="mr-8" />
          <v-switch
            v-model="settingsCopy.cloud_classification"
            dense
            inset
            hide-details
            :label="$t('ac_cloud_classification')"
          />
        </div>
        <v-card :disabled="disabled" flat color="transparent" class="d-flex flex-column fill-height">
          <div class="d-flex flex-row align-center my-4">
            <v-divider />
            <v-btn-toggle v-model="selectedTab" dense rounded mandatory>
              <v-btn
                v-for="tab in tabs"
                :key="tab"
                :value="tab"
                :class="`${tab === selectedTab ? 'white--text' : ''} font-weight-bold px-8`"
                active-class="primary"
                min-width="150"
              >
                {{ $t(tab) }}
              </v-btn>
            </v-btn-toggle>
            <v-divider />
          </div>
          <v-tabs-items v-model="selectedTab" class="ac-tab-items transparent">
            <v-tab-item
              class="ac-tab-applications"
              value="ac_applications"
              :transition="false"
              :reverse-transition="false"
            >
              <u-list-group
                :items="applications"
                id-key="guid"
                :actions="applicationActions"
                :selected-items.sync="selectedApps"
              ></u-list-group>
            </v-tab-item>
            <v-tab-item
              class="ac-tab-custom-rules"
              value="ac_custom_rules"
              :transition="false"
              :reverse-transition="false"
            >
              <tab-custom-rules ref="customRules" :apps="applications" :custom-rules="settingsCopy.custom_rules" />
            </v-tab-item>
          </v-tabs-items>
        </v-card>
      </component>
    </div>
  </v-container>
</template>
<script>
  import { VContainer, VDivider, VSwitch, VCard, VBtn, VBtnToggle, VTabItem, VTabsItems, VSpacer } from 'vuetify/lib'
  import settingsMixin from '../settingsMixin'
  import { UListGroup } from '../../components'
  import defaults from './defaults'
  import schema from './schema'
  import TabCustomRules from './components/TabCustomRules.vue'

  export default {
    components: {
      VContainer,
      VDivider,
      VSwitch,
      VCard,
      VBtn,
      VBtnToggle,
      VTabItem,
      VTabsItems,
      VSpacer,

      UListGroup,
      TabCustomRules,
    },

    // add the generic settings mixin
    mixins: [settingsMixin],

    // attach `defaults` and `schema` to the component $options as no reactive data
    defaults,
    schema,

    props: {
      applications: {
        type: Array,
        required: true,
      },
      showCustomRuleTab: {
        type: Boolean,
        default: true,
      },
    },

    data() {
      return {
        selectedTab: 'ac_applications',
      }
    },

    computed: {
      tabs() {
        return this.showCustomRuleTab ? ['ac_applications', 'ac_custom_rules'] : ['ac_applications']
      },
      applicationCategories() {
        return [...new Set(this.applications.map(app => app.category))].sort()
      },
      applicationsList() {
        return this.applications.map(app => app.guid).sort()
      },
      applicationActions() {
        return [
          { value: 'reject', text: 'reject', forceEnabledFor: [], resets: 'block' },
          { value: 'block', text: 'block', forceEnabledFor: [], resets: 'reject' },
          { value: 'flag', text: 'flag', forceEnabledFor: ['block', 'reject'] },
        ]
      },
      selectedApps: {
        get({ settingsCopy }) {
          return Object.entries(settingsCopy.actions).reduce((result, [flag, list]) => {
            list.forEach(guid => {
              const item = result.find(({ guid: id }) => id === guid)
              if (item) {
                item[flag] = true
              } else {
                result.push({ [flag]: true, guid })
              }
            })
            return result
          }, [])
        },
        set(apps) {
          const actions = apps.reduce(
            (result, app) => {
              this.applicationActions.forEach(({ value: flag }) => {
                if (app[flag]) {
                  result[flag].push(app.guid)
                }
              })
              return result
            },
            { reject: [], block: [], flag: [] },
          )
          this.$set(this.settingsCopy, 'actions', actions)
        },
      },
    },

    watch: {
      selectedTab() {
        // when switching from custom apps reset it's view
        if (this.$refs.customRules) this.$refs.customRules.reset()
      },
    },
  }
</script>
<style>
  .ac-tab-items {
    overflow: visible;
    background-color: transparent;
  }

  .ac-tab-items,
  .ac-tab-custom-rules,
  .ac-tab-applications {
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .ac-tab-items .v-window__container {
    flex: 1;
  }
</style>
