<template>
  <v-container
    :fluid="classicView ? true : false"
    :class="`${classicView ? 'pa-4 ' : ''}shared-cmp ${disabled ? 'disabled ' : ''}d-flex flex-column flex-grow-1`"
  >
    <div class="d-flex align-center">
      <h1 v-if="classicView" class="headline">{{ $t('geoip_filter') }}</h1>
      <h2 v-else class="font-weight-light">{{ $t('geoip_filter') }}</h2>
      <v-spacer />
      <slot name="actions" :new-settings="settingsCopy" :is-dirty="isDirty" :defaults="$options.defaults" />
    </div>

    <v-divider class="my-2" />
    <p v-html="$t('geoip_filter_description')" />
    <u-section v-if="!!$slots['extra-fields']">
      <slot name="extra-fields" />
    </u-section>
    <component :is="!$slots['extra-fields'] ? 'div' : 'u-section'" class="d-flex flex-column flex-grow-1">
      <div class="body-2 mt-4">
        <v-switch
          v-model="settingsCopy.enabled"
          :disabled="disabled"
          class="body-2 mb-4"
          dense
          inset
          hide-details
          :label="$t('geoip_filter_toggle', [settingsCopy.enabled ? $t('enabled') : $t('disabled')])"
        />
        <v-switch
          v-model="settingsCopy.enabledLog"
          :disabled="disabled"
          class="body-2 mb-4"
          dense
          inset
          hide-details
          :label="$t('log_blocked_sessions')"
        />
      </div>
      <!-- Tabs -->
      <v-card :disabled="disabled" flat color="transparent" class="d-flex flex-column flex-grow-1">
        <div class="d-flex flex-row align-center my-4">
          <v-divider />
          <v-btn-toggle v-model="selectedTab" dense rounded mandatory>
            <v-btn
              v-for="tab in tabs"
              :key="tab"
              :value="tab"
              :class="`${tab === selectedTab ? 'white--text' : ''} font-weight-bold px-8`"
              active-class="primary"
              :disabled="tab === 'geoip_lookup' && !settings.enabled"
              min-width="150"
            >
              {{ $t(tab) }}
            </v-btn>
          </v-btn-toggle>
          <v-divider />
        </div>

        <!-- Tabs content -->
        <v-tabs-items
          v-model="selectedTab"
          style="overflow: visible; background-color: transparent"
          class="d-flex flex-column flex-grow-1 gf-tab-items"
        >
          <v-tab-item value="block_countries" :transition="false" :reverse-transition="false">
            <block-countries :settings="settingsCopy" />
          </v-tab-item>
          <v-tab-item
            value="pass_networks"
            :transition="false"
            :reverse-transition="false"
            :class="selectedTab === 'pass_networks' ? 'd-flex flex-column flex-grow-1' : ''"
          >
            <pass-networks :settings="settingsCopy" />
          </v-tab-item>
          <v-tab-item value="geoip_lookup" :transition="false" :reverse-transition="false">
            <geoip-lookup :settings="settingsCopy" :selected-tab="selectedTab" @lookup="$emit('lookup', $event)" />
          </v-tab-item>
        </v-tabs-items>
      </v-card>
    </component>
    <invalid-settings
      v-if="invalidSettingsErrors"
      service="GeoIP Filter"
      :settings="settings"
      :schema="$options.schema"
      :errors.sync="invalidSettingsErrors"
    />
  </v-container>
</template>
<script>
  import { VContainer, VSpacer, VDivider, VSwitch, VCard, VBtn, VBtnToggle, VTabItem, VTabsItems } from 'vuetify/lib'

  import settingsMixin from '../settingsMixin'
  import InvalidSettings from '../InvalidSettings/Main.vue'
  import defaults from './defaults'
  import schema from './schema'
  import BlockCountries from './components/BlockCountries.vue'
  import PassNetworks from './components/PassNetworks.vue'
  import GeoipLookup from './components/GeoipLookup.vue'

  export default {
    components: {
      VContainer,
      VSpacer,
      VDivider,
      VSwitch,
      VCard,
      VBtn,
      VBtnToggle,
      VTabItem,
      VTabsItems,

      BlockCountries,
      PassNetworks,
      GeoipLookup,
      InvalidSettings,
    },
    mixins: [settingsMixin],
    defaults,
    schema,

    data() {
      return {
        selectedTab: 'block_countries', // current selected tab
      }
    },
    computed: {
      tabs() {
        return ['block_countries', 'pass_networks', ...(!this.features.isTemplateView ? ['geoip_lookup'] : [])]
      },
    },
  }
</script>
<style>
  .gf-tab-items .v-window__container {
    flex: 1;
  }
</style>
