<template>
  <div>
    <h3 class="d-flex">
      <span>{{ $t('geoip_lookup') }}</span>
    </h3>
    <p>{{ $t('geoip_lookup_description') }}</p>

    <ValidationObserver v-slot="{ passes }" ref="obs">
      <v-row no-gutters>
        <v-col>
          <ValidationProvider v-slot="{ errors }" rules="ip_any">
            <u-text-field
              v-model="ip"
              :label="$t('enter_ip_address')"
              :error-messages="errors"
              :disabled="!settings.enabled"
              clearable
              @keyup.enter="passes(onLookup)"
            >
              <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
            </u-text-field>
          </ValidationProvider>
        </v-col>
        <v-col class="shrink">
          <u-btn
            :disabled="!ip || !settings.enabled"
            :loading="loading"
            height="40"
            class="ml-4"
            @click="passes(onLookup)"
          >
            {{ $t('lookup') }}
          </u-btn>
        </v-col>
      </v-row>
    </ValidationObserver>

    <div v-if="ip && lookupResult" class="mt-4 body-1">
      <p>
        <span v-if="lookupResult === 'XL'" v-html="$t('geoip_lookup_result', [ipCopy, $t('local')])" />
        <span v-else-if="lookupResult === 'XU'" v-html="$t('geoip_lookup_result', [ipCopy, $t('unknown')])" />
        <span
          v-else-if="countriesMap[lookupResult]"
          v-html="$t('geoip_lookup_result', [ipCopy, countriesMap[lookupResult]])"
        />
        <span v-else v-html="$t('geoip_lookup_result', [ipCopy, $t('unknown')])" />
      </p>
    </div>
  </div>
</template>
<script>
  import { VRow, VCol } from 'vuetify/lib'
  import { ValidationObserver, ValidationProvider } from 'vee-validate'
  import util from '../../../plugins/util'

  export default {
    components: { VRow, VCol, ValidationObserver, ValidationProvider },
    props: {
      settings: { type: Object, default: () => {} },
      selectedTab: { type: String, default: undefined },
    },

    data: () => ({
      ip: null, // ip to lookup for
      ipCopy: null, // used for result display
      lookupResult: null, // actual result country code
      loading: false,
      countriesMap: util.country_codes,
    }),

    watch: {
      selectedTab(value) {
        if (value !== 'geoip_lookup') {
          this.ip = null
          this.ipCopy = null
          this.lookupResult = null
        }
      },
      ipCopy(value) {
        if (!value) {
          this.ip = null
          this.lookupResult = null
        }
      },
    },

    methods: {
      async onLookup() {
        this.lookupResult = null
        this.loading = true
        await this.$emit('lookup', {
          ip: this.ip,
          resolve: res => {
            this.ipCopy = this.ip
            this.lookupResult = res // country code
            this.loading = false
          },
        })
      },
    },
  }
</script>
