<template>
  <div>
    <h3 class="d-flex">
      <span>{{ $vuntangle.$t('block_countries') }}</span>
    </h3>
    <p>{{ $vuntangle.$t('block_countries_description') }}</p>

    <!-- input for generic country filter -->
    <u-text-field
      v-model="filter"
      prepend-inner-icon="mdi-magnify"
      :placeholder="$vuntangle.$t('filter')"
      clearable
      class="my-4"
    />

    <v-row>
      <!-- Available (non-blocked) countries section -->
      <v-col>
        <p class="font-weight-bold">{{ $vuntangle.$t('select_countries_to_be_blocked') }}</p>
        <!-- Selection options -->
        <div class="d-flex align-center mb-2">
          <u-btn text :min-width="null" :disabled="!unblockedFiltered.length" @click="selectAll('unblocked')">
            {{ $vuntangle.$t('all') }}
          </u-btn>
          <u-btn text :min-width="null" :disabled="!selectedUnblocked.length" @click="selectInverse('unblocked')">
            {{ $vuntangle.$t('invert') }}
          </u-btn>
          <u-btn text :min-width="null" :disabled="!selectedUnblocked.length" @click="selectClear('unblocked')">
            {{ $vuntangle.$t('clear') }}
          </u-btn>
          <v-spacer />
          <u-btn
            :disabled="
              !selectedUnblocked.length ||
              selectedUnblocked.length + settings.blockedCountries.length === countriesArray.length
            "
            @click="onBlockSelected"
          >
            {{ $vuntangle.$t('block_selected') }}
          </u-btn>
        </div>

        <v-card outlined>
          <!-- info if all countries are selected to be blocked -->
          <u-alert
            v-if="selectedUnblocked.length + settings.blockedCountries.length === countriesDisplayed.length"
            class="mb-0"
          >
            {{ $vuntangle.$t('block_all_countries_info') }}
          </u-alert>
          <!-- info if countries are filtered -->
          <u-alert v-if="filter && settings.blockedCountries.length < countriesArray.length" class="mb-0">
            <div class="d-flex align-center">
              <span>{{
                $vuntangle.$t('showing_filtered_countries', [
                  unblockedFiltered.filter(c => !c.hidden).length,
                  unblockedAllSize,
                ])
              }}</span>
              <v-spacer />
              <u-btn text @click="filter = null">{{ $vuntangle.$t('clear_filter') }}</u-btn>
            </div>
          </u-alert>
          <!-- actual unblocked countries listing -->
          <v-list
            v-model="selectedUnblocked"
            class="v-list-item--dense"
            height="55vh"
            style="overflow-y: auto"
            multiple
          >
            <v-list-item-group
              v-for="country in unblockedFiltered"
              :key="country.code"
              :value="selectedUnblocked.includes(country.code)"
              :ripple="false"
            >
              <v-list-item
                v-if="!country.hidden"
                class="mb-n4 mt-n4"
                :ripple="false"
                :input-value="selectedUnblocked.includes(country.code)"
                @click="updateSelected('unblocked', country)"
              >
                <v-checkbox
                  class="align-center"
                  :input-value="selectedUnblocked.includes(country.code)"
                  :ripple="false"
                  @onClick="updateSelected('unblocked', country)"
                ></v-checkbox>
                <v-list-item-avatar class="my-0 mx-2">
                  <v-avatar color="green" size="32">
                    <span class="white--text">{{ country.code }}</span>
                  </v-avatar>
                </v-list-item-avatar>
                <v-list-item-content>
                  <v-list-item-title class="text-uppercase" v-text="country.name"></v-list-item-title>
                </v-list-item-content>
              </v-list-item>
            </v-list-item-group>
          </v-list>
        </v-card>
      </v-col>
      <v-col cols="1" class="text-center">
        <v-divider vertical />
      </v-col>

      <!-- Blocked countries section -->
      <v-col>
        <p class="font-weight-bold">{{ $vuntangle.$t('blocked_countries') }}</p>
        <!-- Selection options -->
        <div class="d-flex align-center mb-2">
          <u-btn text :min-width="null" :disabled="!blockedFiltered.length" @click="selectAll('blocked')">
            {{ $vuntangle.$t('all') }}
          </u-btn>
          <u-btn text :min-width="null" :disabled="!selectedBlocked.length" @click="selectInverse('blocked')">
            {{ $vuntangle.$t('invert') }}
          </u-btn>
          <u-btn text :min-width="null" :disabled="!selectedBlocked.length" @click="selectClear('blocked')">
            {{ $vuntangle.$t('clear') }}
          </u-btn>
          <v-spacer />
          <u-btn :disabled="!selectedBlocked.length" @click="onUnblockSelected">{{
            $vuntangle.$t('unblock_selected')
          }}</u-btn>
        </div>

        <v-card outlined>
          <!-- info if no countries are blocked -->
          <u-alert v-if="!settings.blockedCountries.length" class="mb-0"> {{ $t('no_countries_blocked') }} </u-alert>
          <!-- info if countries are filtered -->
          <u-alert v-if="filter && settings.blockedCountries.length" class="mb-0">
            <div class="d-flex align-center">
              <span>
                {{
                  $vuntangle.$t('showing_filtered_countries', [
                    blockedFiltered.filter(c => !c.hidden).length,
                    settings.blockedCountries.length,
                  ])
                }}
              </span>
              <v-spacer />
              <u-btn text @click="filter = null">{{ $vuntangle.$t('clear_filter') }}</u-btn>
            </div>
          </u-alert>
          <!-- actual blocked countries listing -->
          <v-list
            v-if="blockedFiltered.length"
            v-model="selectedBlocked"
            class="v-list-item--dense"
            height="55vh"
            style="overflow-y: auto"
            multiple
          >
            <v-list-item-group
              v-for="country in blockedFiltered"
              :key="country.code"
              :value="selectedBlocked.includes(country.code)"
              :ripple="false"
            >
              <v-list-item
                v-if="!country.hidden"
                class="mb-n4 mt-n4"
                :ripple="false"
                :input-value="selectedBlocked.includes(country.code)"
                @click="updateSelected('blocked', country)"
              >
                <v-checkbox
                  class="align-center"
                  :input-value="selectedBlocked.includes(country.code)"
                  :ripple="false"
                  @onClick="updateSelected('blocked', country)"
                ></v-checkbox>
                <v-list-item-avatar class="my-0 mx-2">
                  <v-avatar color="red" size="32">
                    <span class="white--text">{{ country.code }}</span>
                  </v-avatar>
                </v-list-item-avatar>
                <v-list-item-content>
                  <v-list-item-title class="text-uppercase" v-text="country.name"></v-list-item-title>
                </v-list-item-content>
                <!--                </template>-->
              </v-list-item>
            </v-list-item-group>
          </v-list>
          <v-list v-else height="400" style="overflow-y: auto"> </v-list>
        </v-card>

        <v-switch v-model="blockUnknown" dense inset hide-details :label="$vuntangle.$t('block_unknown_location')" />
      </v-col>
    </v-row>
  </div>
</template>
<script>
  import {
    VCard,
    VRow,
    VCol,
    VList,
    VListItem,
    VListItemGroup,
    VListItemContent,
    VListItemTitle,
    VListItemAvatar,
    VSpacer,
    VSwitch,
    VDivider,
    VCheckbox,
    VAvatar,
  } from 'vuetify/lib'
  import cloneDeep from 'lodash/cloneDeep'
  import util from '../../../plugins/util'

  export default {
    components: {
      VCard,
      VRow,
      VCol,
      VList,
      VListItem,
      VListItemGroup,
      VListItemContent,
      VListItemTitle,
      VListItemAvatar,
      VSpacer,
      VSwitch,
      VDivider,
      VCheckbox,
      VAvatar,
    },
    props: {
      settings: { type: Object, default: () => {} },
    },
    data: () => ({
      countriesMap: util.country_codes,
      filter: null,
      selectedUnblocked: [],
      selectedBlocked: [],
      countriesDisplayed: [],
    }),
    computed: {
      /**
       * array of countries as generated from map such as:
       * [
       *    ...
       *    { code: 'CN', name: 'Country Name' },
       *    ...
       * ]
       */
      countriesArray() {
        const sortedArray = cloneDeep(this.countriesDisplayed)
        sortedArray.sort((a, b) => {
          let comparison = 0
          if (a.name < b.name) {
            comparison = -1
          } else if (a.name > b.name) {
            comparison = 1
          }
          return comparison
        })
        return sortedArray
      },

      /**
       * Array of unblocked filtered countries (left side listing)
       */
      unblockedFiltered() {
        return this.countriesArray.filter(c => !this.settings.blockedCountries.includes(c.code))
      },

      /**
       * Count of unblocked countries
       */
      unblockedAllSize() {
        return this.countriesArray.length - this.settings.blockedCountries.length
      },

      /**
       * Array of blocked filtered countries (right side listing)
       */
      blockedFiltered() {
        return this.countriesArray.filter(c => this.settings.blockedCountries.includes(c.code))
      },

      blockUnknown: {
        get() {
          return this.settings.blockedCountries.includes('XU')
        },
        set(value) {
          if (value) {
            const blockedCountriesCopy = cloneDeep(this.settings.blockedCountries)
            blockedCountriesCopy.push('XU')
            this.$set(this.settings, 'blockedCountries', blockedCountriesCopy)
          } else {
            const items = []
            this.settings.blockedCountries.forEach(code => {
              if (code !== 'XU') {
                items.push(code)
              }
            })
            this.$set(this.settings, 'blockedCountries', items)
          }
        },
      },
    },
    watch: {
      filter: {
        handler(filter) {
          // when filter updates, update the hidden values
          if (!filter) {
            this.countriesArray.forEach(c => (c.hidden = false))
          } else {
            this.countriesArray.forEach(c => {
              if (!this.blockedFiltered.includes(c.code) && !c.name.toLowerCase().includes(this.filter.toLowerCase())) {
                c.hidden = true
              } else {
                c.hidden = false
              }
            })
          }
        },
      },
    },
    created() {
      // remove LOCAL (XL) and Unknown (XU) from the listing
      delete this.countriesMap.XL
      delete this.countriesMap.XU
      this.countriesDisplayed = [
        ...Object.keys(this.countriesMap).map(key => ({ code: key, name: this.countriesMap[key], hidden: false })),
      ]
    },
    methods: {
      updateSelected(type, country) {
        if (country.code && type === 'unblocked') {
          const index = this.selectedUnblocked.indexOf(country.code)
          if (this.selectedUnblocked.includes(country.code) && index > -1) {
            this.selectedUnblocked.splice(index, 1)
          } else {
            this.selectedUnblocked.push(country.code)
          }
        }
        if (country.code && type === 'blocked') {
          const index = this.selectedBlocked.indexOf(country.code)
          if (this.selectedBlocked.includes(country.code) && index > -1) {
            this.selectedBlocked.splice(index, 1)
          } else {
            this.selectedBlocked.push(country.code)
          }
        }
      },
      /**
       * Selects all (un)blocked countries
       * cannot be combined with selectClear because of the check for !this.selectedUnblocked.includes(c.code)
       * @param {string} type - `unblocked` or `blocked`
       */
      selectAll(type) {
        const items = []
        if (type === 'unblocked') {
          this.unblockedFiltered.forEach(c => {
            if (!c.hidden && !this.selectedUnblocked.includes(c.code)) {
              items.push(c)
            }
          })
          items.forEach(item => this.updateSelected(type, item))
        }
        if (type === 'blocked') {
          this.blockedFiltered.forEach(c => {
            if (!c.hidden && !this.selectedBlocked.includes(c.code)) {
              items.push(c)
            }
          })
          items.forEach(item => this.updateSelected(type, item))
        }
      },

      /**
       * Invert selection of  (un)blocked countries
       * @param {string} type - `unblocked` or `blocked`
       */
      selectInverse(type) {
        const items = []
        if (type === 'unblocked') {
          this.unblockedFiltered.forEach(c => {
            if (!c.hidden) {
              items.push(c)
            }
          })
          items.forEach(item => this.updateSelected(type, item))
        }
        if (type === 'blocked') {
          this.blockedFiltered.forEach(c => {
            if (!c.hidden) {
              items.push(c)
            }
          })
          items.forEach(item => this.updateSelected(type, item))
        }
      },
      /**
       * Clears all filtered and selected (un)blocked countries
       * cannot be combined with selectAll because of the check for this.selectedUnblocked.includes(c.code)
       * @param {string} type - `unblocked` or `blocked`
       */
      selectClear(type) {
        const items = []
        if (type === 'unblocked') {
          this.unblockedFiltered.forEach(c => {
            if (!c.hidden && this.selectedUnblocked.includes(c.code)) {
              items.push(c)
            }
          })
          items.forEach(item => this.updateSelected(type, item))
        }
        if (type === 'blocked') {
          this.blockedFiltered.forEach(c => {
            if (!c.hidden && this.selectedBlocked.includes(c.code)) {
              items.push(c)
            }
          })
          items.forEach(item => this.updateSelected(type, item))
        }
      },
      /**
       * Adds selected countries to the block settings
       */
      onBlockSelected() {
        let blockedCountriesCopy = cloneDeep(this.settings.blockedCountries)
        blockedCountriesCopy = blockedCountriesCopy.concat(this.selectedUnblocked)
        this.selectedUnblocked = []
        this.$set(this.settings, 'blockedCountries', blockedCountriesCopy)
      },

      /**
       * Remove selected countries from the block settings
       */
      onUnblockSelected() {
        const items = []
        this.settings.blockedCountries.forEach(code => {
          if (!this.selectedBlocked.includes(code)) {
            items.push(code)
          }
        })
        this.selectedBlocked = []
        this.$set(this.settings, 'blockedCountries', items)
      },
    },
  }
</script>
