<template>
  <div class="d-flex flex-column flex-grow-1" style="gap: 12px">
    <v-card outlined class="d-flex flex-column flex-grow-1">
      <v-card-title :class="`px-2 py-0 subtitle-1 ${$vuntangle.theme === 'dark' ? '' : 'primary--text'}`">
        <span class="py-2 font-weight-medium">{{ $vuntangle.$t('distribution_map') }}</span>
        <v-spacer />
        <v-btn icon @click="fetchData"><v-icon>mdi-refresh</v-icon></v-btn>
      </v-card-title>
      <v-divider horizontal />
      <u-chart-map class="map" :series="series" :fetching="fetching" />
    </v-card>
    <div class="d-flex flex-row flex-grow-1" style="gap: 12px">
      <v-card outlined class="d-flex flex-column flex-grow-1">
        <v-card-title :class="`px-2 py-0 subtitle-1 ${$vuntangle.theme === 'dark' ? '' : 'primary--text'}`">
          <span class="py-2 px-0 font-weight-medium">{{ $vuntangle.$t('blocked_sessions_outbound') }}</span>
        </v-card-title>
        <v-divider horizontal />
        <u-grid
          id="reports-grid"
          :column-defs="outboundColumnDefs"
          :row-data="outboundBlockedCountries"
          :fetching="fetching"
          :enable-refresh="false"
          no-border
          v-on="$listeners"
        />
      </v-card>
      <v-card outlined class="d-flex flex-column flex-grow-1">
        <v-card-title :class="`px-2 py-0 subtitle-1 ${$vuntangle.theme === 'dark' ? '' : 'primary--text'}`">
          <span class="py-2 font-weight-medium">{{ $vuntangle.$t('blocked_sessions_inbound') }}</span>
        </v-card-title>
        <v-divider horizontal />
        <u-grid
          id="reports-grid"
          :column-defs="inboundColumnDefs"
          :row-data="inboundBlockedCountries"
          :fetching="fetching"
          :enable-refresh="false"
          no-border
          v-on="$listeners"
        />
      </v-card>
    </div>
  </div>
</template>
<script>
  import renderer from '../../../plugins/renderer'
  import reports from '../../../plugins/reports'
  import { Report } from '../configs/constants'
  import UChartMap from '../../../components/UChartMap'
  import viewsMixin from './viewsMixin'

  export default {
    components: { UChartMap },
    mixins: [viewsMixin],
    inject: ['$timeRange'],

    data() {
      return {
        fetching: false,
        outboundBlockedCountries: [],
        inboundBlockedCountries: [],
      }
    },

    computed: {
      /**
       * Returns the timerange from injected $timeRange
       * @param {Object} vm
       * @param {Object} vm.$timeRange - the timerange period
       * @returns {Object}
       */
      timeRange: ({ $timeRange }) => $timeRange(),

      /**
       * Returns the column defs for the Outbound Blocked Sessions grid
       * @returns {Array}
       */
      outboundColumnDefs() {
        return [
          {
            headerName: this.$vuntangle.$t('country'),
            field: 'server_country',
            flex: 1,
            valueGetter: ({ data }) => renderer.country(data.server_country),
          },
          {
            headerName: this.$vuntangle.$t('count'),
            field: 'value',
            sort: 'desc',
          },
        ]
      },

      /**
       * Returns the column defs for the Inbound Blocked Sessions grid
       * @returns {Array}
       */
      inboundColumnDefs() {
        return [
          {
            headerName: this.$vuntangle.$t('country'),
            field: 'client_country',
            flex: 1,
            valueGetter: ({ data }) => renderer.country(data.client_country),
          },
          {
            headerName: this.$vuntangle.$t('count'),
            field: 'value',
            sort: 'desc',
          },
        ]
      },

      /**
       * We have to process the data before passing it to the mapOptions
       * @param outboundBlockedCountries - input data e.g. [{ "server_country": "RO", "value": 84 }]
       * @returns {Array} - output data e.g. [[ "ro", 84 ]]
       */
      outboundData: ({ outboundBlockedCountries }) =>
        outboundBlockedCountries?.map(country => [country?.server_country?.toLowerCase(), country?.value]),
      inboundData: ({ inboundBlockedCountries }) =>
        inboundBlockedCountries?.map(country => [country?.client_country?.toLowerCase(), country?.value]),

      /**
       * Returns the series used in UChartMap for plotting the map chart
       * @returns {Array}
       */
      series() {
        return [
          {
            name: '',
            allAreas: true,
            color: this.$vuntangle.theme === 'dark' ? '#1E1E1E' : '#FFFFFF',
          },
          {
            name: this.$vuntangle.$t('blocked_countries_outbound'),
            color: '#434348',
            states: {
              hover: {
                color: '#146095',
              },
            },
            dataLabels: {
              enabled: false,
            },
            allAreas: false,
            data: this.outboundData,
          },
          {
            name: this.$vuntangle.$t('blocked_countries_inbound'),
            color: '#7cb5ec',
            states: {
              hover: {
                color: '#146095',
              },
            },
            dataLabels: {
              enabled: false,
            },
            allAreas: false,
            data: this.inboundData,
          },
        ]
      },
    },

    mounted() {
      this.fetchData()
    },

    methods: {
      fetchData() {
        const now = Date.now()

        // compute start/end timestamps based on timezone offset
        const start = now + this.timeRange.period[0] * 60 * 60 * 1000

        const end = now + this.timeRange.period[1] * 60 * 60 * 1000

        let conditions = [
          {
            column: 'time_stamp',
            operator: 'GT',
            value: start,
          },
          {
            column: 'time_stamp',
            operator: 'LT',
            value: end,
          },
        ]

        // attach also any custom conditions if passed
        if (this.customConditions) conditions = [...conditions, ...this.customConditions]

        this.fetching = true
        const outboundRep = reports[Report.GeoipOutboundCountriesByBlockCount]
        const inboundRep = reports[Report.GeoipInboundCountriesByBlockCount]

        this.$emit('fetch-data', {
          query: { ...outboundRep.query, userConditions: conditions },
          resolve: data => {
            this.fetching = false
            this.outboundBlockedCountries = data
          },
        })
        this.$emit('fetch-data', {
          query: { ...inboundRep.query, userConditions: conditions },
          resolve: data => {
            this.fetching = false
            this.inboundBlockedCountries = data
          },
        })
      },
    },
  }
</script>
