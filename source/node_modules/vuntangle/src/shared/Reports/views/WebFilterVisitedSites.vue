<template>
  <div class="d-flex flex-column flex-grow-1">
    <div class="d-flex align-center my-2">
      <v-checkbox
        v-model="conditions.web_filter_blocked"
        :label="$vuntangle.$t('blocked')"
        class="pa-0 my-0 mr-4"
        hide-details
      />
      <v-checkbox
        v-model="conditions.web_filter_flagged"
        :label="$vuntangle.$t('flagged')"
        class="pa-0 my-0 mr-4"
        hide-details
      />
      <div>
        <v-select
          v-model="conditions.web_filter_reason"
          :items="reasonItems"
          :label="$vuntangle.$t('reason')"
          :menu-props="{ offsetY: true, dense: true }"
          outlined
          dense
          hide-details
        />
      </div>
    </div>

    <report-grid :report="reports[0]" :custom-conditions="queryConditions" v-on="$listeners" />
  </div>
</template>
<script>
  import { VCheckbox, VSelect } from 'vuetify/lib'
  import ReportGrid from '../components/ReportGrid.vue'
  import viewsMixin from './viewsMixin'

  export default {
    components: { VCheckbox, VSelect, ReportGrid },
    mixins: [viewsMixin],

    data() {
      return {
        fetching: true,
        conditions: {
          web_filter_blocked: false,
          web_filter_flagged: false,
          web_filter_reason: null,
        },
      }
    },

    computed: {
      /**
       * Returns the select items used to choose Web Filter reason for an action
       * @param {Object} vm
       * @param {Object} vm.$i18n - localization engine
       * @returns {Array}
       */
      reasonItems: ({ $i18n }) => [
        { text: $i18n.t('block_category'), value: 1 },
        { text: $i18n.t('block_list'), value: 2 },
        { text: $i18n.t('pass_category'), value: 0 },
        { text: $i18n.t('pass_list'), value: 3 },
        { text: $i18n.t('all'), value: null },
      ],

      /**
       * Builds up custom report query conditions based on filtering options
       * @param {Object} vm
       * @param {Object} vm.conditions - the filtering options
       * @returns {Array<QueryCondition>}
       */
      queryConditions: ({ conditions }) => {
        // get only the web traffic
        const list = [
          {
            column: 'web_filter_hostname',
            operator: 'NE',
            value: '',
          },
        ]

        Object.entries(conditions).forEach(([key, value]) => {
          if (value || value === 0) {
            list.push({
              column: key,
              operator: 'EQ',
              value,
            })
          }
        })

        return list
      },
    },
  }
</script>
