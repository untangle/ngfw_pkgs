<template>
  <div>
    <div class="d-flex align-center flex-wrap" style="gap: 12px">
      <v-menu offset-y flat @input="onMenuInput">
        <template #activator="{ on, attrs }">
          <v-text-field
            v-model="selectionText"
            outlined
            dense
            readonly
            hide-details
            v-bind="attrs"
            :append-icon="menuIcon"
            v-on="on"
          />
        </template>
        <v-card outlined flat class="d-flex">
          <div>
            <v-list dense class="py-0" style="min-width: 200px">
              <v-list-item
                v-for="category in categories"
                :key="category"
                :class="hoverCategory === category ? 'v-list-item--active' : ''"
                @click.prevent.stop
                @mouseenter="onCategoryMouseEnter(category)"
              >
                <v-list-item-title class="d-flex align-center caption">
                  {{ $vuntangle.$t(category) }}
                  <v-spacer />
                  <v-icon>mdi-chevron-right</v-icon>
                </v-list-item-title>
              </v-list-item>
            </v-list>
          </div>
          <v-divider vertical class="mr-2" />

          <v-list dense class="flex-grow-1 py-0">
            <v-list-item v-for="view in categoryViews" :key="view.id" @click="$emit('view-report', view.id)">
              <v-list-item-content>
                <v-list-item-title>{{ $vuntangle.$t(view.name) }}</v-list-item-title>
                <v-list-item-subtitle class="d-none d-lg-block font-weight-regular caption" style="white-space: unset">
                  <span v-for="reportId in view.reports" :key="reportId" class="mr-4">
                    <v-icon small>{{ reports[reportId].icon }}</v-icon> {{ $vuntangle.$t(reports[reportId].title) }}
                  </span>
                </v-list-item-subtitle>
              </v-list-item-content>
            </v-list-item>
          </v-list>
        </v-card>
      </v-menu>
      <time-range />
    </div>
  </div>
</template>
<script>
  import {
    VMenu,
    VTextField,
    VCard,
    VList,
    VListItem,
    VListItemTitle,
    VListItemSubtitle,
    VSpacer,
    VIcon,
    VDivider,
  } from 'vuetify/lib'

  import { Category } from '../configs/constants'
  import { views } from '../configs/viewsConfig'
  import reports from '../../../plugins/reports'
  import TimeRange from './TimeRange.vue'

  export default {
    components: {
      VMenu,
      VTextField,
      VCard,
      VList,
      VListItem,
      VListItemTitle,
      VListItemSubtitle,
      VSpacer,
      VIcon,
      VDivider,

      TimeRange,
    },

    props: {
      viewId: { type: String, default: undefined },
    },

    data() {
      return {
        reports,
        hoverCategory: undefined,
        menuIcon: 'mdi-menu-down',
      }
    },

    computed: {
      /**
       * Returns all the available categories
       * @returns {Array<String>}
       */
      categories: () => Object.values(Category),

      /**
       * Returns the selected report view
       * @param {Object} vm
       * @param {String} vm.viewId - the view id from props
       * @returns {View}
       */
      selectedView: ({ viewId }) => views[viewId],

      /**
       * Returns the selected category derived from selected view
       * @param {Object} vm
       * @param {View} vm.selectedView - the selected view
       * @returns {String}
       */
      selectedCategory: ({ selectedView }) => selectedView?.category,

      /**
       * Returns all the views within a category
       * @param {Object} vm
       * @param {String} vm.hoverCategory - the category name upon mouseover
       * @returns {Array<View>}
       */
      categoryViews: ({ hoverCategory }) => Object.values(views).filter(item => item.category === hoverCategory),

      /**
       * Returns translated text shown as selection in the form:
       * <Category Name> → <Report View Name>
       * @param {Object} vm
       * @param {Object} vm.$i18n - translation engine
       * @param {String} vm.selectedCategory - the selected category
       * @param {View} vm.selectedView - the selected view
       * @returns {String}
       */
      selectionText: ({ $i18n, selectedCategory, selectedView }) =>
        `${$i18n.t(selectedCategory)} → ${$i18n.t(selectedView.name)}`,
    },

    methods: {
      /**
       * When the menu opens/closes
       * - sets the `hoverCategory` (initial selection)
       * - sets the menu icon (up/down)
       * @param {Boolean} event - true on open / false on close
       * @return {undefined}
       */
      onMenuInput(event) {
        this.hoverCategory = event ? this.selectedCategory : undefined
        this.menuIcon = event ? 'mdi-menu-up' : 'mdi-menu-down'
      },

      /**
       * Sets the `hoverCategory` when mouse over a category
       * @param {String} category - the category name (id)
       * @return {undefined}
       */
      onCategoryMouseEnter(category) {
        this.hoverCategory = category
      },
    },
  }
</script>
