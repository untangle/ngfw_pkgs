<template>
  <v-range-slider
    :value="period"
    min="-24"
    max="0"
    step="1"
    hide-details
    :ticks="false"
    tick-size="0"
    :tick-labels="ticksLabels"
    class="flex-lg-grow-0 flex-shrink-0 text-caption mb-4"
    style="min-width: 400px"
    @input="onInput"
    @end="onSlideEnd"
  >
  </v-range-slider>
</template>
<script>
  import { VRangeSlider } from 'vuetify/lib'
  import dates from '../../../plugins/dates'

  export default {
    components: { VRangeSlider },

    inject: ['$boxSettings', '$timeRange'],

    data() {
      return {
        /**
         * Initial period range of 24 hours as usable value for VRangeSlider
         */
        period: [-24, 0],
        /**
         * Temporary input period used just to display range during sliders dragging
         */
        inputPeriod: undefined,
      }
    },

    computed: {
      /**
       * Returns the time range as passed through injected param
       * of the form `{ period: [-24, 0] }`
       * @param {Object} vm
       * @param {Object} vm.$timeRange - the injected timerange value
       * @returns {Object}
       */
      timeRange: ({ $timeRange }) => $timeRange(),

      /**
       * Returns timezone based start/end dates plus the timezone offset from the box
       * @param {Object} vm
       * @param {Object} vm.timeRange - the time range period
       * @returns {Object} - an object such { start: 'Nov 16 05:19 PM', end: 'Nov 17 05:19 PM', offset: 'UTC+04:00'}
       */
      time: ({ timeRange }) => {
        const now = Date.now()
        const startTimestamp = now - Math.abs(timeRange.period[0]) * 60 * 60 * 1000
        const start = dates.formatDateFromApi(startTimestamp)
        const endTimestamp = now - Math.abs(timeRange.period[1]) * 60 * 60 * 1000
        const end = dates.formatDateFromApi(endTimestamp)
        return { start, end }
      },

      /**
       * Returns an array of tick labels used by range slider to show the start/end dates and offset
       * @param {Object} vm
       * @param {Object} vm.time - the labels to show start/end, offset
       * @returns {Array} - an array of 25 items containing the tick labels for first/middle/last ones
       */
      ticksLabels: ({ time }) => {
        // having a step of 1 in a range of [0, 24] ticks, first is generated an array with 25 null values
        const labels = [...Array(25).keys()].map(() => null)
        labels[0] = time.start // first tick label having start date
        labels[12] = time.offset // middle tick label having timezone offset
        labels[24] = time.end // last tick label having end date
        return labels
      },
    },

    methods: {
      /**
       * Sets the temporary period shown while dragging sliders
       * @param {Array} event - the event returned by the range slider
       * @returns {undefined}
       */
      onInput(event) {
        this.inputPeriod = event
      },

      /**
       * Sets the new time range period and clears out the temporary one
       * @param {Array} event - the event returned by the range slider on slide move end, e.g. [-12, -5]
       * @returns {undefined}
       */
      onSlideEnd(event) {
        this.inputPeriod = undefined
        this.timeRange.period = event
      },
    },
  }
</script>
