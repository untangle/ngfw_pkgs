<!--
  RuleAction is the generic component used for settings the action for a rule
  Actions are specific to each ruleType (`wan-policies`, `filter`, `nat`, `shaping` etc... )
-->
<template>
  <div>
    <!-- `port-forward` actions
      action: { type: 'DNAT', dnat_address, dnat_port }
      Action type applied for firewall/`filter` rules
    -->
    <div v-if="ruleType === 'port-forward'" class="d-flex align-center">
      <div class="font-weight-bold mr-2">{{ $vuntangle.$t('rule_action_dnat') }}:</div>
      <v-row dense class="align-center">
        <v-col cols="3">
          <ValidationProvider v-slot="{ errors }" rules="required|ip">
            <u-text-field v-model="actionCopy.dnat_address" :label="$vuntangle.$t('address')" :error-messages="errors">
              <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
            </u-text-field>
          </ValidationProvider>
        </v-col>
        <v-col cols="2">
          <ValidationProvider v-slot="{ errors }" rules="port">
            <u-text-field
              v-model="actionCopy.dnat_port"
              :label="$vuntangle.$t('port_optional')"
              :error-messages="errors"
              clearable
            >
              <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
            </u-text-field>
          </ValidationProvider>
        </v-col>
      </v-row>
    </div>

    <!-- `shaping` actions
      action: { type: 'SET_PRIORITY|LIMIT_EXCEED_ACTION', priority: 1, limit_exceed_action: 'drop' }
      Sets priority for the network/`shaping` rules
    -->
    <div v-if="ruleType === 'shaping'" class="d-flex align-center">
      <v-row dense class="align-center">
        <v-col cols="4">
          <!-- MFW-4234: If LIMIT_RATE && '>' == then action should only be 'LIMIT_EXCEED_ACTION' -->
          <u-select
            v-if="allowLimitExceedAction"
            v-model="actionCopy.type"
            :items="['LIMIT_EXCEED_ACTION']"
            :placeholder="$vuntangle.$t('select')"
          >
            <template #selection="{ item }">{{ $vuntangle.$t(`rule_action_${item.toLowerCase()}`) }}</template>
            <template #item="{ item }">{{ $vuntangle.$t(`rule_action_${item.toLowerCase()}`) }}</template>
          </u-select>
          <!-- MFW-4234: If LIMIT_RATE not amongst the condition then 'LIMIT_EXCEED_ACTION' shouldn't be allowed
            OR if LIMIT_RATE && '<' == then action should only be 'Set Priority' -->
          <u-select v-else v-model="actionCopy.type" :items="['SET_PRIORITY']" :placeholder="$vuntangle.$t('select')">
            <template #selection="{ item }">{{ $vuntangle.$t(`rule_action_${item.toLowerCase()}`) }}</template>
            <template #item="{ item }">{{ $vuntangle.$t(`rule_action_${item.toLowerCase()}`) }}</template>
          </u-select>
        </v-col>
        <v-col v-if="actionCopy.type === 'SET_PRIORITY'" cols="4">
          <ValidationProvider v-slot="{ errors }" rules="required" tag="div">
            <u-select
              v-model="actionCopy.priority"
              :items="priorityOptions"
              :placeholder="$vuntangle.$t('select')"
              :error-messages="errors"
            >
              <template #selection="{ item }">{{ $vuntangle.$t(item.text) }}</template>
              <template #item="{ item }">{{ $vuntangle.$t(item.text) }}</template>
              <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
            </u-select>
          </ValidationProvider>
        </v-col>
        <v-col v-if="actionCopy.type === 'LIMIT_EXCEED_ACTION'" cols="3">
          <ValidationProvider v-slot="{ errors }" rules="required" tag="div">
            <u-select
              v-model="actionCopy.limit_exceed_action"
              :items="limitExceedActionOptions"
              :placeholder="$vuntangle.$t('select')"
              :error-messages="errors"
              @change="handleLimitExceedActionChange"
            >
              <template #selection="{ item }">{{ $vuntangle.$t(item.text) }}</template>
              <template #item="{ item }">{{ $vuntangle.$t(item.text) }}</template>
              <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
            </u-select>
          </ValidationProvider>
        </v-col>
        <v-col v-if="shouldShowPriority" cols="3">
          <ValidationProvider v-slot="{ errors }" rules="required" tag="div">
            <u-select
              v-model="actionCopy.priority"
              :items="priorityOptions"
              :placeholder="$vuntangle.$t('select')"
              :error-messages="errors"
            >
              <template #selection="{ item }">{{ $vuntangle.$t(item.text) }}</template>
              <template #item="{ item }">{{ $vuntangle.$t(item.text) }}</template>
              <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
            </u-select>
          </ValidationProvider>
        </v-col>
      </v-row>
    </div>

    <!-- `nat` actions
      action: { type: 'SNAT|MASQUERADE', snat_address }
    -->
    <div v-if="ruleType === 'nat'">
      <v-row dense class="align-center">
        <v-col cols="4">
          <u-select v-model="actionCopy.type" :items="natActionItems" :placeholder="$vuntangle.$t('select')">
            <template #selection="{ item }">{{ $vuntangle.$t(`rule_action_${item.toLowerCase()}`) }}</template>
            <template #item="{ item }">{{ $vuntangle.$t(`rule_action_${item.toLowerCase()}`) }}</template>
          </u-select>
        </v-col>
        <v-col v-if="actionCopy.type === 'SNAT'" cols="8">
          <ValidationProvider
            v-slot="{ errors }"
            :rules="{ required: true, ip_expression: { multiple: false }, check_non_routeable_address: true }"
          >
            <u-text-field v-model="actionCopy.snat_address" :label="$vuntangle.$t('address')" :error-messages="errors">
              <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
            </u-text-field>
          </ValidationProvider>
        </v-col>
      </v-row>
    </div>

    <!-- `filter` and `access` actions
      action: { type: 'ACCEPT | REJECT | DROP' }
      Action type applied for firewall/`filter` rules
    -->
    <div v-if="ruleType === 'filter' || ruleType === 'access'" class="d-flex">
      <v-row dense class="align-center">
        <v-col cols="4">
          <ValidationProvider v-slot="{ errors }" rules="required">
            <u-select
              v-model="actionCopy.type"
              :items="actions"
              :placeholder="$vuntangle.$t('select')"
              :error-messages="errors"
            >
              <template #selection="{ item }">{{ $vuntangle.$t(`rule_action_${item.toLowerCase()}`) }}</template>
              <template #item="{ item }">{{ $vuntangle.$t(`rule_action_${item.toLowerCase()}`) }}</template>
              <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
            </u-select>
          </ValidationProvider>
        </v-col>
      </v-row>
    </div>

    <!-- `wan-rules` actions
      action: { type: 'WAN_POLICY', policy: 'somePolicyId' }
      Policy attached to the `WAN_POLICY` action applied for routing/`wan-rules`
      Policies are populated via event (up) -> parent (down) -> props
      so for MFW wan policies, those are retrieved as array of objects
      [{ best_of_wan, criteria, description, enabled, interfaces, policyId, type }]
      the action selector uses `description` and `policyId` for the select items
    -->
    <div v-if="ruleType === 'wan-rules'">
      <v-row dense class="align-center">
        <v-col cols="6">
          <ValidationProvider v-slot="{ errors }" rules="required">
            <u-select
              v-model="actionCopy.policy"
              :items="remoteData.policies"
              item-value="policyId"
              item-text="description"
              :placeholder="$vuntangle.$t('select')"
              :label="$t('rule_action_wan_policy')"
              :error-messages="errors"
            >
              <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
            </u-select>
          </ValidationProvider>
        </v-col>
      </v-row>
    </div>
  </div>
</template>
<script>
  import { VRow, VCol } from 'vuetify/lib'
  import { ValidationProvider } from 'vee-validate'
  import cloneDeep from 'lodash/cloneDeep'
  import { priorityOptions, limitExceedActionOptions } from '../../constants'

  export default {
    components: { VRow, VCol, ValidationProvider },
    props: {
      action: { type: Object, default: undefined },
      rule: { type: Object, default: undefined },
    },
    data() {
      return {
        actionCopy: undefined,
        actions: ['ACCEPT', 'REJECT', 'DROP'],
        priorityOptions,
        limitExceedActionOptions,
        natActionItems: ['SNAT', 'MASQUERADE'],
        shouldShowPriority: false,
      }
    },
    computed: {
      ruleType: ({ $attrs }) => $attrs.ruleType,
      remoteData: ({ $attrs }) => $attrs.remoteData,
      remoteFetching: ({ $attrs }) => $attrs.remoteFetching,
      allowLimitExceedAction: ({ rule }) =>
        rule?.conditions?.length && rule?.conditions?.some(cond => cond.type === 'LIMIT_RATE' && cond.op === '>'),
    },
    watch: {
      action: {
        handler(newAction, oldAction) {
          if (JSON.stringify(newAction) === JSON.stringify(oldAction)) return
          this.actionCopy = cloneDeep(newAction)
          /**
           * in case of wan rules `WAN_POLICY` action
           * an event is triggered to populate wan policies from host app (remote)
           */
          if (newAction.type === 'WAN_POLICY') {
            this.$emit('get-remote-data', 'policies')
          }
        },
        immediate: true,
        deep: true,
      },
      actionCopy: {
        handler(action) {
          this.$emit('update:action', action)
        },
        deep: true,
      },
      // MFW-2291 - remove dnat_port from action if not set (empty string)
      'actionCopy.dnat_port'(value) {
        if (!value) {
          this.$delete(this.actionCopy, 'dnat_port')
        }
      },
      'actionCopy.limit_exceed_action'(value) {
        if (!value) {
          this.handleLimitExceedActionChange(value)
        }
      },
      /**
       * removes the snat_address from `nat` action if action type is `MASQUERADE`
       * @param {String} value
       */
      'actionCopy.type'(value) {
        if (this.ruleType === 'nat' && value === 'MASQUERADE') {
          this.$delete(this.actionCopy, 'snat_address')
        }
      },
      allowLimitExceedAction(value) {
        if (this.ruleType !== 'shaping') return
        if (value) {
          this.actionCopy.type = 'LIMIT_EXCEED_ACTION'
          this.$set(this.actionCopy, 'limit_exceed_action', this.limitExceedActionOptions[0].value)
          delete this.actionCopy.priority
        } else {
          this.actionCopy.type = 'SET_PRIORITY'
          this.$set(this.actionCopy, 'priority', this.priorityOptions[0].value)
          delete this.actionCopy.limit_exceed_action
        }
      },
    },
    mounted() {
      // Check the initial value of `limit_exceed_action` on component mount
      this.handleLimitExceedActionChange(this.actionCopy.limit_exceed_action)
    },
    methods: {
      handleLimitExceedActionChange(selectedAction) {
        // Set the `shouldShowPriority` based on the selected action
        if (selectedAction === 'PRIORITY') {
          this.shouldShowPriority = true
        } else {
          this.shouldShowPriority = false
        }
      },
    },
  }
</script>
