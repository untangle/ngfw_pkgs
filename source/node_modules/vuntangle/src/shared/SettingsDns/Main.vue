<template>
  <v-container
    :fluid="classicView ? true : false"
    :class="`${classicView ? 'pa-4 ' : ''}shared-cmp d-flex flex-column flex-grow-1`"
  >
    <div class="d-flex align-center">
      <h1 v-if="classicView" class="headline">{{ $vuntangle.$t('dns') }}</h1>
      <h2 v-else class="font-weight-light">{{ $vuntangle.$t('dns') }}</h2>
      <v-spacer />
      <slot name="actions" :new-settings="settingsCopy" :is-dirty="isDirty"></slot>
    </div>
    <v-divider class="my-2" />
    <u-section v-if="hasExtraFields" class="mt-4">
      <slot name="extra-fields" />
    </u-section>
    <component :is="hasExtraFields ? 'u-section' : 'div'" class="d-flex flex-column fill-height">
      <div class="d-flex flex-row align-center my-4">
        <v-divider />
        <v-btn-toggle v-model="selectedTab" dense rounded mandatory>
          <v-btn
            v-for="tab in tabs"
            :key="tab"
            :value="tab"
            :class="`${tab === selectedTab ? 'white--text' : ''} font-weight-bold px-8`"
            active-class="primary"
            :disabled="tab === 'site_lookup' && !settings.enabled"
            min-width="150"
          >
            {{ $t(tab) }}
          </v-btn>
        </v-btn-toggle>
        <v-divider />
      </div>
      <!-- Tabs content -->
      <v-tabs-items v-model="selectedTab" style="overflow: visible; background-color: transparent" class="fill-height">
        <v-tab-item
          value="static_entries"
          :transition="false"
          :reverse-transition="false"
          :class="selectedTab === 'static_entries' ? 'd-flex flex-column fill-height' : ''"
        >
          <div class="d-flex align-center">
            <h2 class="font-weight-light">{{ $vuntangle.$t('static_entries') }}</h2>
            <v-spacer />
            <u-btn :min-width="null" :disabled="disabled" @click="onAddEditStaticEntry(null)">{{
              $vuntangle.$t('add')
            }}</u-btn>
          </div>
          <p class="body-2" v-html="$vuntangle.$t('static_entries_info')" />
          <u-grid
            id="static_entries"
            :row-data="settingsCopy.staticEntries"
            :column-defs="staticEntriesColumnDefs"
            :enable-refresh="false"
          />
        </v-tab-item>
        <v-tab-item
          value="domain_forwarding"
          :transition="false"
          :reverse-transition="false"
          :class="selectedTab === 'domain_forwarding' ? 'd-flex flex-column fill-height' : ''"
        >
          <div class="d-flex align-center">
            <h2 class="font-weight-light">{{ $vuntangle.$t('domain_forwarding') }}</h2>
            <v-spacer />
            <u-btn :min-width="null" :disabled="disabled" @click="onAddEditDomain(null)">{{
              $vuntangle.$t('add')
            }}</u-btn>
          </div>
          <p class="body-2" v-html="$vuntangle.$t('domain_forwarding_info')" />
          <u-grid
            id="domain_forwarding"
            :row-data="settingsCopy.localServers"
            :column-defs="domainsColumnDefs"
            :enable-refresh="false"
          />
        </v-tab-item>
      </v-tabs-items>
    </component>
  </v-container>
</template>
<script>
  import { VContainer, VSpacer, VDivider, VBtnToggle, VTabsItems, VTabItem } from 'vuetify/lib'
  import settingsMixin from '../settingsMixin'
  import UBtn from '../../components/UBtn'
  import UGrid from '../../components/UGrid'
  import USection from '../../components/USection/USection'
  import util from '../../plugins/util'
  import DnsStaticEntry from './DnsStaticEntry'
  import DnsDomainForward from './DnsDomainForward'
  import schema from './schema'
  import defaults from './defaults'
  export default {
    components: {
      USection,
      VContainer,
      VSpacer,
      VDivider,
      VBtnToggle,
      UBtn,
      UGrid,
      VTabsItems,
      VTabItem,
    },
    mixins: [settingsMixin],
    schema,
    defaults,
    data: () => ({
      selectedTab: 'static_entries',
      tabs: ['static_entries', 'domain_forwarding'],
      actionColumnDefaults: {
        maxWidth: 50,
        flex: 0,
        resizable: false,
        sortable: false,
        suppressMenu: true,
        cellRenderer: 'ActionButton',
      },
    }),
    computed: {
      hasExtraFields: ({ $slots }) => !!$slots['extra-fields'],
      staticEntriesColumnDefs() {
        const columns = [
          { headerName: this.$vuntangle.$t('name'), field: 'name' },
          { headerName: this.$vuntangle.$t('description'), field: 'description' },
          {
            headerName: this.$vuntangle.$t('address'),
            field: 'address',
            lockVisible: true,
            comparator: (a, b) => {
              return util.compareIpAny(a, b)
            },
          },
        ]
        columns.push(
          ...[
            {
              ...this.actionColumnDefaults,
              ...{
                cellRendererParams: {
                  icon: 'mdi-pencil',
                  small: true,
                  disabled: this.disabled,
                  click: ({ node }) => this.onAddEditStaticEntry(node.id),
                },
              },
            },
            {
              ...this.actionColumnDefaults,
              ...{
                cellRendererParams: {
                  icon: 'mdi-delete',
                  small: true,
                  disabled: this.disabled,
                  click: ({ node }) => this.onDeleteStaticEntry(node.id),
                },
              },
            },
          ],
        )
        return columns
      },
      domainsColumnDefs() {
        const columns = [
          { headerName: this.$vuntangle.$t('domain'), field: 'domain', lockVisible: true },
          {
            headerName: this.$vuntangle.$t('server'),
            field: 'localServer',
            lockVisible: true,
            comparator: (a, b) => {
              return util.compareIpAny(a, b)
            },
          },
        ]
        columns.push(
          ...[
            {
              ...this.actionColumnDefaults,
              ...{
                cellRendererParams: {
                  icon: 'mdi-pencil',
                  small: true,
                  disabled: this.disabled,
                  click: ({ node }) => this.onAddEditDomain(node.id),
                },
              },
            },
            {
              ...this.actionColumnDefaults,
              ...{
                cellRendererParams: {
                  icon: 'mdi-delete',
                  small: true,
                  disabled: this.disabled,
                  click: ({ node }) => this.onDeleteDomain(node.id),
                },
              },
            },
          ],
        )
        return columns
      },
    },
    methods: {
      // add/edit static entry dialog
      onAddEditStaticEntry(index) {
        this.$vuntangle.dialog.show({
          title: index === null ? this.$vuntangle.$t('add_static_entry') : this.$vuntangle.$t('edit_static_entry'),
          component: DnsStaticEntry,
          width: 500,
          actionLabel: index === null ? this.$vuntangle.$t('add') : this.$vuntangle.$t('update'),
          componentProps: {
            index,
            // pass the entry if it exists
            ...(index === null ? {} : { settings: this.settingsCopy.staticEntries[index] }),
          },
          componentEvents: {
            update: (entry, index) => {
              // add or update the entry from the dialog
              if (index === null) {
                this.settingsCopy.staticEntries.push(entry)
              } else {
                this.settingsCopy.staticEntries.splice(index, 1, entry)
              }
            },
          },
        })
      },
      // delete static entry
      onDeleteStaticEntry(index) {
        this.settingsCopy.staticEntries.splice(index, 1)
      },
      // add/edit domain
      onAddEditDomain(index) {
        this.$vuntangle.dialog.show({
          title: index === null ? this.$vuntangle.$t('add_domain') : this.$vuntangle.$t('edit_domain'),
          component: DnsDomainForward,
          width: 500,
          actionLabel: index === null ? this.$vuntangle.$t('add') : this.$vuntangle.$t('update'),
          componentProps: {
            index,
            // pass the entry if it exists
            ...(index === null ? {} : { settings: this.settingsCopy.localServers[index] }),
          },
          componentEvents: {
            update: (entry, index) => {
              // add or update the entry from the dialog
              if (index === null) {
                this.settingsCopy.localServers.push(entry)
              } else {
                this.settingsCopy.localServers.splice(index, 1, entry)
              }
            },
          },
        })
      },
      // delete domain
      onDeleteDomain(index) {
        this.settingsCopy.localServers.splice(index, 1)
      },
    },
  }
</script>
