<template>
  <v-container
    :fluid="classicView ? true : false"
    :class="`${classicView ? 'pa-4 ' : ''}shared-cmp d-flex flex-column flex-grow-1`"
  >
    <div class="d-flex align-center">
      <h1 v-if="classicView" class="headline">{{ $vuntangle.$t('dhcp') }}</h1>
      <h2 v-else class="font-weight-light">{{ $vuntangle.$t('dhcp') }}</h2>
      <v-spacer />
      <slot name="actions" :new-settings="settingsCopy" :is-dirty="isDirty" />
    </div>
    <v-divider class="my-2" />
    <u-section v-if="!!$slots['extra-fields']">
      <slot name="extra-fields" />
    </u-section>
    <div class="d-flex">
      <v-checkbox
        v-model="settingsCopy.dhcpAuthoritative"
        :label="$vuntangle.$t('dhcp_authoritative')"
        :disabled="disabled"
      />
    </div>

    <div class="d-flex align-center mb-2">
      <h2 class="font-weight-light">{{ $vuntangle.$t('reservations') }}</h2>
      <v-spacer />
      <u-btn :min-width="null" :disabled="disabled" @click="onAddEditReservation(null)">{{
        $vuntangle.$t('add_reservation')
      }}</u-btn>
    </div>

    <u-grid
      id="reservations"
      :row-data="settingsCopy.staticDhcpEntries"
      :column-defs="reservationsColumnDefs"
      :enable-refresh="false"
      style="height: 300px"
    />

    <template v-if="leases !== false">
      <h2 class="font-weight-light mt-4 mb-2">{{ $vuntangle.$t('leases') }}</h2>
      <u-grid
        id="leases"
        :row-data="leases"
        :column-defs="leasesColumnDefs"
        :fetching="fetching"
        @refresh="$emit('fetch-leases')"
        style="height: 300px"
      />
    </template>

    <invalid-settings
      v-if="invalidSettingsErrors"
      service="DHCP Settings"
      :settings="settings"
      :schema="$options.schema"
      :errors.sync="invalidSettingsErrors"
    />
  </v-container>
</template>
<script>
  import { VContainer, VSpacer, VDivider, VCheckbox } from 'vuetify/lib'
  import UBtn from '../../components/UBtn'
  import UGrid from '../../components/UGrid'
  import settingsMixin from '../settingsMixin'
  import InvalidSettings from '../InvalidSettings/Main.vue'
  import defaults from './defaults'
  import schema from './schema'
  import DhcpReservation from './DhcpReservation.vue'

  export default {
    components: {
      VContainer,
      VSpacer,
      VDivider,
      VCheckbox,
      UBtn,
      UGrid,
      InvalidSettings,
    },
    mixins: [settingsMixin],
    props: {
      /**
       * Leases are not a configuration and are fetched only on box ui,
       * passing `false` will not render the leases grid (e.g. for cloud)
       */
      leases: { type: [Array, Boolean], default: () => [] },
      fetching: { type: Boolean, default: false },
    },
    defaults,
    schema,
    data: () => ({
      actionColumnDefaults: {
        maxWidth: 50,
        flex: 0,
        resizable: false,
        sortable: false,
        suppressMenu: true,
        cellRenderer: 'ActionButton',
      },
    }),
    computed: {
      reservationsColumnDefs() {
        const columns = [
          {
            headerName: this.$vuntangle.$t('ip_address'),
            field: 'address',
            comparator: (a, b) => this.$vuntangle.util.compareIpAny(a, b),
            lockVisible: true,
          },
          { headerName: this.$vuntangle.$t('mac_address'), field: 'macAddress' },
          { headerName: this.$vuntangle.$t('description'), field: 'description' },
        ]
        columns.push(
          {
            ...this.actionColumnDefaults,
            cellRendererParams: {
              icon: 'mdi-pencil',
              small: true,
              disabled: this.disabled,
              click: ({ node }) => this.onAddEditReservation(node.id),
            },
          },
          {
            ...this.actionColumnDefaults,
            cellRendererParams: {
              icon: 'mdi-delete',
              small: true,
              disabled: this.disabled,
              click: ({ node }) => this.onDeleteReservation(node.id),
            },
          },
        )
        return columns
      },
      leasesColumnDefs() {
        const columns = [
          {
            headerName: this.$vuntangle.$t('ip_address'),
            field: 'ipAddr',
            comparator: (a, b) => this.$vuntangle.util.compareIpAny(a, b),
            lockVisible: true,
          },
          { headerName: this.$vuntangle.$t('mac_address'), field: 'macAddress' },
          {
            headerName: this.$vuntangle.$t('expiration'),
            field: 'leaseExpiration',
            valueGetter: ({ data }) => this.$vuntangle.dates.formatLocaleDate(data.leaseExpiration * 1000),
          },
          { headerName: this.$vuntangle.$t('host'), field: 'hostName' },
        ]
        columns.push({
          ...this.actionColumnDefaults,
          cellRendererParams: params => {
            return {
              icon: 'mdi-plus-circle',
              small: true,
              click: () => {
                this.onAddReservationFromLease(params.data)
              },
            }
          },
        })
        return columns
      },
    },

    methods: {
      /**
       * Shows a dialog to edit a reservation than updates the dhcp entries
       * @param {Number} index - the index of entry being edited or null if added
       */
      onAddEditReservation(index) {
        this.$vuntangle.dialog.show({
          title: index === null ? this.$vuntangle.$t('add_reservation') : this.$vuntangle.$t('edit_reservation'),
          component: DhcpReservation,
          width: 500,
          actionLabel: index === null ? this.$vuntangle.$t('add') : this.$vuntangle.$t('update'),
          componentProps: {
            index,
            entries: this.settingsCopy.staticDhcpEntries,
            ...(index === null ? {} : { settings: this.settingsCopy.staticDhcpEntries[index] }),
          },
          componentEvents: {
            update: (entry, index) => {
              if (index === null) {
                this.settingsCopy.staticDhcpEntries.push(entry)
              } else {
                this.settingsCopy.staticDhcpEntries.splice(index, 1, entry)
              }
            },
          },
        })
      },

      /**
       * Removes an existing static dhcp entry
       * @param {Number} index - the index of entry being removed
       */
      onDeleteReservation(index) {
        this.settingsCopy.staticDhcpEntries.splice(index, 1)
      },

      /**
       * Adds a dhcp static entry from a lease
       * @param {Object} lease - the lease data to be added to static dhcp entries
       */
      onAddReservationFromLease(lease) {
        // prevent adding a lease entry for which macAddress or ip address already exists
        const entries = this.settingsCopy.staticDhcpEntries
        if (entries.findIndex(item => item.macAddress === lease.macAddress || item.address === lease.ipAddr) >= 0) {
          this.$vuntangle.toast.add(this.$vuntangle.$t('dhcp_lease_reservation_conflict'))
          return
        }

        this.settingsCopy.staticDhcpEntries.push({
          address: lease.ipAddr,
          macAddress: lease.macAddress,
          description: lease.hostName,
        })
      },
    },
  }
</script>
