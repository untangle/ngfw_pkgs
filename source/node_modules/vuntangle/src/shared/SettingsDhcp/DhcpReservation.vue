<template>
  <v-container class="px-0">
    <ValidationObserver ref="obs">
      <v-row>
        <v-col>
          <ValidationProvider v-slot="{ errors }" :rules="{ required: true, ip: true, unique: addresses }">
            <u-text-field v-model="entry.address" :label="$vuntangle.$t('address')" :error-messages="errors">
              <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
            </u-text-field>
          </ValidationProvider>
        </v-col>
      </v-row>
      <v-row>
        <v-col>
          <ValidationProvider v-slot="{ errors }" :rules="{ required: true, mac_address: true, unique: macAddresses }">
            <u-text-field
              v-model="entry.macAddress"
              :label="$vuntangle.$t('mac_address')"
              placeholder="00:1B:44:11:3A:B7"
              :error-messages="errors"
            >
              <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
            </u-text-field>
          </ValidationProvider>
        </v-col>
      </v-row>
      <v-row>
        <v-col>
          <ValidationProvider v-slot="{ errors }">
            <u-text-field v-model="entry.description" :label="$vuntangle.$t('description')" :error-messages="errors">
              <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
            </u-text-field>
          </ValidationProvider>
        </v-col>
      </v-row>
    </ValidationObserver>
  </v-container>
</template>
<script>
  import { VContainer, VRow, VCol } from 'vuetify/lib'
  import { ValidationObserver, ValidationProvider } from 'vee-validate'
  import UTextField from '../../components/UTextField'

  export default {
    components: {
      VContainer,
      VRow,
      VCol,
      ValidationObserver,
      ValidationProvider,
      UTextField,
    },
    props: {
      index: { type: String, default: null },
      entries: { type: Array, default: null },
      settings: { type: Object, required: false, default: () => ({ address: '', description: '', macAddress: '' }) },
    },
    data: () => ({
      entry: undefined,
    }),
    computed: {
      // used for validating unique IP addresses entries
      addresses() {
        let addresses = this.entries.map(entry => entry.address)
        if (this.index !== null) {
          addresses = addresses.filter((entry, index) => index !== Number(this.index))
        }
        return addresses
      },
      // used for validating unique MAC addresses entries
      macAddresses() {
        let macAddresses = this.entries.map(entry => entry.macAddress)
        if (this.index !== null) {
          macAddresses = macAddresses.filter((entry, index) => index !== Number(this.index))
        }
        return macAddresses
      },
    },

    watch: {
      // copy the prop to the data model that can be mutated
      settings: {
        immediate: true,
        deep: true,
        handler(value) {
          this.entry = { ...value }
        },
      },
    },
    methods: {
      async action() {
        const isValid = await this.$refs.obs.validate()
        if (!isValid) return

        this.$emit('update', { ...this.entry }, this.index)
        this.$emit('close')
      },
    },
  }
</script>
