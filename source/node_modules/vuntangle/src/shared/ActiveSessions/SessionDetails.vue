<template>
  <v-sheet class="d-flex flex-column" :color="!$vuetify.theme.isDark ? 'grey lighten-3' : ''">
    <div class="d-flex flex-column flex-grow-1" style="width: 400px">
      <div class="d-flex align-center py-2">
        <h4 class="ml-4">{{ $t('session_details') }}</h4>
        <v-spacer />
        <v-btn icon class="mr-2" @click="$emit('close')"><v-icon>mdi-close</v-icon></v-btn>
      </div>
      <div class="flex-column flex-grow-1 flex-basis-0 overflow-auto">
        <v-treeview :items="treeItems" open-on-click expand-icon="mdi-chevron-down" dense class="list-dense">
          <template slot="label" slot-scope="props">
            <div v-if="props.item.children">
              <span class="font-weight-bold text-uppercase caption">{{ $t(props.item.name) }}</span>
            </div>
            <div v-else class="caption">
              {{ $t(props.item.name) }}: <span class="font-weight-bold" v-html="props.item.value" />
            </div>
          </template>
        </v-treeview>
      </div>
      <div>
        <v-divider class="mb-4" />
        <h4 class="ml-4">{{ $t('session_stats') }}</h4>
        <v-simple-table dense style="background: transparent">
          <template #default>
            <thead>
              <tr>
                <th class="text-left"></th>
                <th class="text-left" width="120">{{ $t('client') }}</th>
                <th class="text-left" width="120">{{ $t('server') }}</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="stat in stats" :key="stat.key">
                <td class="text-caption" v-html="`${$t(stat.key)}: ${stat.values[0]}`"></td>
                <td class="text-caption" v-html="stat.values[1] || '-'"></td>
                <td class="text-caption" v-html="stat.values[2] || '-'"></td>
              </tr>
            </tbody>
          </template>
        </v-simple-table>
      </div>
    </div>
  </v-sheet>
</template>
<script>
  import { VSheet, VSpacer, VBtn, VTreeview, VDivider, VSimpleTable } from 'vuetify/lib'
  import renderer from '../../plugins/renderer'
  import columns from '../../plugins/columns'

  export default {
    components: { VSheet, VSpacer, VBtn, VTreeview, VDivider, VSimpleTable },
    props: {
      session: { type: Object, default: () => {} },
      columnDefs: { type: Array, default: () => [] },
    },

    computed: {
      /**
       * the sessions_stats specific columns:
       * bytes, client_bytes, server_bytes
       * byte_rate, client_byte_rate, server_byte_rate
       * packets, client_packets, server_packets
       * packet_rate, client_packet_rate, server_packet_rate
       *
       * @returns Array - an array having the key name and values for total/client/server
       * e.g. [{ key: 'bytes', values: [10, 5, 5] }]...
       */
      stats: ({ session }) => {
        const keys = ['bytes', 'byte_rate', 'packets', 'packet_rate']
        const rows = []
        keys.forEach(key => {
          switch (key) {
            case 'bytes':
              rows.push({
                key,
                values: [
                  renderer.bytesRenderer(session[key]),
                  renderer.bytesRenderer(session[`client_${key}`]),
                  renderer.bytesRenderer(session[`server_${key}`]),
                ],
              })
              break
            case 'byte_rate':
              rows.push({
                key,
                values: [
                  renderer.bytesSecRenderer(session[key]),
                  renderer.bytesSecRenderer(session[`client_${key}`]),
                  renderer.bytesSecRenderer(session[`server_${key}`]),
                ],
              })
              break
            case 'packets':
            case 'packet_rate':
              rows.push({
                key,
                values: [
                  renderer.packetsRenderer(session[key]),
                  renderer.packetsRenderer(session[`client_${key}`]),
                  renderer.packetsRenderer(session[`server_${key}`]),
                ],
              })
          }
        })
        return rows
      },

      /**
       * The sessions monitor uses the `sessions` and `session_stats` table
       * `treeItems` returns a tree generated based on the session object data
       */
      treeItems() {
        const rootKeys = ['application', 'client', 'server', 'certificate']
        const tree = []

        columns.gridColumns.active_sessions.all.forEach(field => {
          const key = field.split('_')[0]
          const value = this.session[field]
          if (!value) return

          // use the columns renderer for the details too
          const col = this.columnDefs.find(def => def.field === field)

          // extract the rendered value using the cols definitions, making sure col exists
          const renderedValue =
            col?.valueGetter?.({ data: this.session }) ||
            col?.cellRenderer?.({ value }) ||
            col?.valueFormatter?.(value) ||
            value

          if (rootKeys.includes(key)) {
            const node = tree.find(el => el.name === key)
            if (node && node.children) {
              node.children.push({ name: field, value: renderedValue })
            } else {
              tree.push({ name: key, children: [{ name: field, value: renderedValue }] })
            }
          } else {
            tree.push({ name: field, value: renderedValue })
          }

          tree.sort((a, b) => {
            // sort nodes with children first
            if (a.children && !b.children) {
              return -1
            }
            // alphasort nodes without children
            if (!a.children && !b.children) {
              const nameA = this.$t(a.name).toUpperCase()
              const nameB = this.$t(b.name).toUpperCase()
              if (nameA < nameB) {
                return -1
              }
              if (nameA > nameB) {
                return 1
              }
              return 0
            }
            return 1
          })
        })

        return tree
      },
    },
  }
</script>
