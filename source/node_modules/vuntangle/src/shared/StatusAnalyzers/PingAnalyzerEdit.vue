<template>
  <v-container>
    <ValidationObserver ref="obs">
      <component :is="!classicView ? 'div' : 'u-section'">
        <v-row v-if="!classicView">
          <v-col>
            <ValidationProvider
              v-slot="{ errors }"
              :rules="{
                required: true,
                unique_insensitive: { list: existingNames, message: $t('name_already_used') },
              }"
            >
              <u-text-field v-model="settingsCopy.name" :label="$vuntangle.$t('name')" :error-messages="errors">
                <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
              </u-text-field>
            </ValidationProvider>
          </v-col>
        </v-row>
        <v-row>
          <v-col cols="3">
            <v-checkbox v-model="settingsCopy.enabled" :label="$vuntangle.$t('enabled')" hide-details class="ma-0" />
          </v-col>
        </v-row>
        <v-row v-if="!features.isTemplateView" class="align-center">
          <v-col class="d-flex flex-row align-center">
            <div class="mr-4 font-weight-bold">Select WANs:</div>
            <v-checkbox
              v-for="intf in filteredInterfaces"
              :key="intf.interfaceId"
              v-model="settingsCopy.interfaceIds"
              :label="intf.name"
              :value="intf.interfaceId"
              class="ma-0 mr-4 pa-0"
              hide-details
            />
          </v-col>
        </v-row>

        <v-row class="mt-4 align-center">
          <v-col>
            <ValidationProvider v-slot="{ errors }" :rules="{ required: true, ip: { multiple: true } }">
              <u-text-field
                v-model="ipv4Addresses"
                :error-messages="errors"
                :label="$vuntangle.$t('ipv4_addresses')"
                :hint="$vuntangle.$t('comma_separated_ips')"
                :hide-details="false"
                persistent-hint
              >
                <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
              </u-text-field>
            </ValidationProvider>
          </v-col>
        </v-row>

        <v-row class="mt-4 align-center">
          <v-col>
            <ValidationProvider v-slot="{ errors }" :rules="{ ip_v6: { multiple: true } }">
              <u-text-area
                v-model="ipv6Addresses"
                :rows="3"
                :error-messages="errors"
                :label="$vuntangle.$t('ipv6_addresses')"
                :hint="$vuntangle.$t('comma_separated_ips')"
                :hide-details="false"
                persistent-hint
              >
                <template v-if="errors.length" #append><u-errors-tooltip :errors="errors" /></template>
              </u-text-area>
            </ValidationProvider>
          </v-col>
        </v-row>
      </component>
    </ValidationObserver>
  </v-container>
</template>
<script>
  import { VContainer, VSpacer, VDivider, VRow, VCol, VCheckbox, VBtn, VIcon } from 'vuetify/lib'
  import { ValidationObserver, ValidationProvider } from 'vee-validate'
  import settingsMixin from '../settingsMixin'

  import UTextField from '../../components/UTextField'
  import UTextArea from '../../components/UTextArea'

  import { AddDefaults } from './defaults'

  export default {
    components: {
      UTextField,
      UTextArea,
      VContainer,
      VSpacer,
      VDivider,
      VRow,
      VCol,
      VCheckbox,
      VBtn,
      VIcon,
      ValidationObserver,
      ValidationProvider,
    },
    mixins: [settingsMixin],
    defaults: AddDefaults,
    props: {
      // settings, settingsCopy from mixin
      interfaces: { type: Array, default: null },
      index: { type: Number, default: undefined },
      // names used for unique validation
      existingNames: { type: Array, default: () => [] },
    },
    computed: {
      ipv4Addresses: {
        get: ({ settingsCopy }) => settingsCopy.ipv4Addresses.join(', '),
        set(value) {
          this.settingsCopy.ipv4Addresses = value.split(',').map(item => item.trim())
        },
      },
      ipv6Addresses: {
        get: ({ settingsCopy }) => settingsCopy.ipv6Addresses.join(', '),
        set(value) {
          this.settingsCopy.ipv6Addresses = value.split(',').map(item => item.trim())
        },
      },
      filteredInterfaces() {
        return this.interfaces.filter(intf => intf.enabled && intf.wan)
      },
    },
    methods: {
      // Dialog main action emitting updated settings
      async action() {
        const isValid = await this.$refs.obs.validate()
        if (!isValid) return

        this.$emit('update', this.settingsCopy, this.index)
        this.$emit('close')
      },
    },
  }
</script>
