<template>
  <v-container
    :fluid="classicView ? true : false"
    :class="`${classicView ? 'pa-4 ' : ''}shared-cmp ${disabled ? 'disabled' : ''}`"
  >
    <div class="d-flex align-center">
      <h1 v-if="classicView" class="headline">{{ $t('status_analyzers') }}</h1>
      <h2 v-else class="font-weight-light">{{ $t('status_analyzers') }}</h2>
      <v-spacer />
      <slot name="actions" :new-settings="settingsCopy" :is-dirty="isDirty" />
    </div>

    <v-divider class="my-2" />

    <u-section v-if="!!$slots['extra-fields']">
      <slot name="extra-fields" />
    </u-section>

    <div class="d-flex align-center my-4">
      <h3>{{ $vuntangle.$t('ping_analyzers') }}</h3>
      <v-spacer />

      <u-btn color="primary" :min-width="null" :disabled="disabled" @click="onEdit()">
        <v-icon left>mdi-plus</v-icon> {{ $vuntangle.$t('add_ping_analyzer') }}
      </u-btn>
    </div>

    <v-card outlined>
      <div class="d-flex pa-2 align-center">
        <u-text-field v-model="search" :label="$vuntangle.$t('filter')" clearable />
        <v-spacer />
        <span class="caption">
          {{ $vuntangle.$t('filtered_text', { filtered: filteredNo, total: pingAnalyzers.length }) }}
        </span>
      </div>

      <v-divider />

      <v-data-table
        :headers="headers"
        :items="pingAnalyzers"
        :search="search"
        hide-default-footer
        calculate-widths
        @current-items="items => (filteredNo = items.length)"
      >
        <template #[`item.enabled`]="{ item }">
          <v-simple-checkbox
            v-model="item.enabled"
            :disabled="disabled"
            color="primary"
            hide-details
            class="ma-0"
            :ripple="false"
          />
        </template>
        <template #[`item.interfaceIds`]="{ value }">
          <div v-for="intf in value" :key="intf">
            <strong>{{ interfacesMap[intf] }}</strong>
          </div>
        </template>
        <template #[`item.ipv4Addresses`]="{ value }">
          <span class="caption font-weight-bold" v-html="value.join(', <br/>')" />
        </template>
        <template #[`item.ipv6Addresses`]="{ value }">
          <span class="caption font-weight-bold" v-html="value.join(', <br/>')"></span>
        </template>
        <template #[`item.actions`]="{ item }">
          <v-btn icon dense :disabled="disabled" @click="onEdit(item)"><v-icon>mdi-pencil</v-icon></v-btn>
          <v-btn icon dense :disabled="disabled" @click="onDelete(item)"><v-icon>mdi-close</v-icon></v-btn>
        </template>

        <template #no-results>
          <div class="my-8">
            <span>{{ $vuntangle.$t('no_data_meets_filter') }}</span>
            <br /><br />
            <u-btn outlined @click="search = null">{{ $vuntangle.$t('clear_filters') }}</u-btn>
          </div>
        </template>
        <template #no-data>
          <div class="my-8">
            <span>{{ $vuntangle.$t('no_data_available') }}</span>
          </div>
        </template>
      </v-data-table>
    </v-card>
    <template v-if="features.interfaceTracking">
      <v-divider class="mt-6 mb-2" />
      <interface-tracker-list
        v-bind="$props"
        :settings.sync="settingsCopy.track"
        v-on="$listeners"
      ></interface-tracker-list>
    </template>
  </v-container>
</template>

<script>
  import { VContainer, VSpacer, VDivider, VCard, VDataTable, VSimpleCheckbox, VBtn } from 'vuetify/lib'
  import settingsMixin from '../settingsMixin'
  import InterfaceTrackerList from './InterfaceTrackerList.vue'
  import PingAnalyzerEdit from './PingAnalyzerEdit.vue'

  export default {
    components: {
      InterfaceTrackerList,
      VContainer,
      VSpacer,
      VDivider,
      VCard,
      VDataTable,
      VSimpleCheckbox,
      VBtn,
    },
    mixins: [settingsMixin],
    props: {
      interfaces: { type: Array, default: () => [] },
    },
    data() {
      return {
        search: null,
        filteredNo: null,
      }
    },
    computed: {
      headers() {
        return [
          {
            text: this.$vuntangle.$t('enabled'),
            sortable: false,
            value: 'enabled',
            align: 'center',
          },
          { text: this.$vuntangle.$t('name'), value: 'name' },
          // omit showing interfaces column in global template as is not relevant
          ...(this.features.isTemplateView ? [] : [{ text: this.$vuntangle.$t('interfaces'), value: 'interfaceIds' }]),
          { text: this.$vuntangle.$t('ipv4_addresses'), value: 'ipv4Addresses' },
          { text: this.$vuntangle.$t('ipv6_addresses'), value: 'ipv6Addresses' },
          { text: '', value: 'actions', align: 'end' },
        ]
      },
      interfacesMap: ({ interfaces }) =>
        interfaces.reduce((res, intf) => {
          if (intf.enabled && intf.wan) {
            return { ...res, [intf.interfaceId]: intf.name }
          } else {
            return res
          }
        }, {}),
      pingAnalyzers: {
        get() {
          return !this.features.isTemplateView ? this.settingsCopy.pingAnalyzers : this.settingsCopy
        },
        set(objects = []) {
          if (this.features.isTemplateView) {
            this.settingsCopy = objects
          } else {
            this.settingsCopy.pingAnalyzers = objects
          }
        },
      },
    },
    methods: {
      interfaceRenderer(ids) {
        const names = []
        ids.forEach(id => names.push(this.interfacesMap[id]))
        return names.join(', ')
      },

      /**
       * Shows edit dialog, adds a new analyzer if index is undefined
       * @param item - analyzer
       */
      onEdit(item = undefined) {
        // get the real index of the item based on it's name
        const realIndex = this.pingAnalyzers.findIndex(analyzer => analyzer.name === item?.name)

        // have a list of the existing unique names to be passed to the edit dialog
        const existingNames = this.pingAnalyzers.map(analyzer => analyzer.name)
        if (realIndex >= 0) {
          existingNames.splice(realIndex, 1)
        }

        this.$vuntangle.dialog.show({
          title: this.$vuntangle.$t(!item ? 'add_ping_analyzer' : 'edit_ping_analyzer'),
          component: PingAnalyzerEdit,
          width: 800,
          height: 'auto',
          actionLabel: this.$vuntangle.$t(!item ? 'add' : 'update'),
          componentProps: {
            existingNames,
            index: realIndex,
            interfaces: this.interfaces,
            features: this.features,
            ...(!item ? {} : { settings: item }),
          },
          componentEvents: {
            update: (entry, index) => {
              // remove filtering as it may lead to an empty list being confusing
              this.search = null

              // add or update the entry from the dialog
              if (index === -1) {
                this.pingAnalyzers = [...this.pingAnalyzers, entry]
              } else {
                const newArray = [...this.pingAnalyzers]
                newArray.splice(index, 1, entry)
                this.pingAnalyzers = newArray
              }
              this.$emit('save-analyzers', this.pingAnalyzers, true)
            },
          },
        })
      },

      /**
       * confirmation dialog when deleting an analyzer
       */
      onDelete(item) {
        // get the real index of the item based on it's name
        const realIndex = this.pingAnalyzers.findIndex(analyzer => analyzer.name === item?.name)

        if (this.features.isTemplateView) {
          const newArray = [...this.pingAnalyzers]
          newArray.splice(realIndex, 1)
          this.pingAnalyzers = newArray
          return
        }

        this.$vuntangle.confirm.show({
          title: `<i class="mdi mdi-alert" style="font-style: normal;"> ${this.$vuntangle.$t('confirm')}</i>`,
          message: this.$vuntangle.$t('confirm_delete_analyzer', [item.name]),
          confirmLabel: this.$vuntangle.$t('yes'),
          cancelLabel: this.$vuntangle.$t('no'),
          action: resolve => {
            this.$emit('delete-ping-analyzer', realIndex)

            // remove filtering as it may lead to an empty list being confusing
            this.search = null
            resolve()
          },
        })
      },
    },
  }
</script>
