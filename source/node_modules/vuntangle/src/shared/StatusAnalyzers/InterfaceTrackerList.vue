<template>
  <div>
    <div class="d-flex align-center my-4">
      <h3>{{ $vuntangle.$t('interface_trackers') }}</h3>
      <v-spacer />
      <u-btn color="primary" :min-width="null" :disabled="disabled" @click="onEdit()">
        <v-icon left>mdi-plus</v-icon> {{ $vuntangle.$t('add_interface_tracker') }}
      </u-btn>
    </div>

    <v-card outlined>
      <div class="d-flex pa-2 align-center">
        <u-text-field v-model="search" :label="$vuntangle.$t('filter')" clearable />
        <v-spacer />
        <span class="caption">
          {{ $vuntangle.$t('filtered_text', { filtered: filteredNo, total: trackedObjects.length }) }}
        </span>
      </div>

      <v-divider />

      <v-data-table
        :headers="headers"
        :items="trackedObjects"
        :search="search"
        hide-default-footer
        calculate-widths
        @current-items="items => (filteredNo = items.length)"
      >
        <template #[`item.interfaceId`]="{ value }">
          <strong>{{ interfacesMap[value] }}</strong>
        </template>
        <template #[`item.actions`]="{ item, index }">
          <v-btn icon dense :disabled="disabled" @click="onEdit(index)"><v-icon>mdi-pencil</v-icon></v-btn>
          <v-btn icon dense :disabled="disabled" @click="onDeleteEntry(item, index)"><v-icon>mdi-close</v-icon></v-btn>
        </template>

        <template #no-results>
          <div class="my-8">
            <span>{{ $vuntangle.$t('no_data_meets_filter') }}</span>
            <br /><br />
            <u-btn outlined @click="search = null">{{ $vuntangle.$t('clear_filters') }}</u-btn>
          </div>
        </template>
        <template #no-data>
          <div class="my-8">
            <span>{{ $vuntangle.$t('no_data_available') }}</span>
          </div>
        </template>
      </v-data-table>
    </v-card>
  </div>
</template>

<script>
  import { VSpacer, VDivider, VCard, VDataTable, VBtn, VIcon } from 'vuetify/lib'
  import settingsMixin from '../settingsMixin'
  import InterfaceTrackerEdit from './InterfaceTrackerEdit.vue'

  export default {
    components: { VSpacer, VDivider, VCard, VDataTable, VBtn, VIcon },
    mixins: [settingsMixin],
    props: {
      interfaces: { type: Array, default: () => [] },
    },
    data() {
      return {
        search: null,
        filteredNo: null,
      }
    },
    computed: {
      headers() {
        return [
          { text: this.$vuntangle.$t('name'), value: 'displayName' },
          { text: this.$vuntangle.$t('interface'), value: 'interfaceId' },
          { text: '', value: 'actions', align: 'end' },
        ]
      },
      interfacesMap: ({ interfaces }) =>
        interfaces.reduce((res, intf) => {
          return { ...res, [intf.interfaceId]: intf.name }
        }, {}),
      trackedObjects: ({ settingsCopy }) => settingsCopy || [],
    },
    methods: {
      /**
       * Shows edit dialog, adds a new item if index is undefined
       * @param index - number
       */
      onEdit(index = undefined) {
        this.$vuntangle.dialog.show({
          title: this.$vuntangle.$t(index === undefined ? 'add_interface_tracker' : 'edit_interface_tracker'),
          component: InterfaceTrackerEdit,
          width: 600,
          height: 'auto',
          actionLabel: this.$vuntangle.$t(index === undefined ? 'add' : 'update'),
          componentProps: {
            index,
            interfaces: this.interfaces,
            features: this.features,
            settings: index === undefined ? {} : this.trackedObjects[index],
          },
          componentEvents: {
            update: (entry, index) => {
              // add or update the entry from the dialog
              if (index === undefined) {
                this.settingsCopy.push(entry)
              } else {
                this.settingsCopy.splice(index, 1, entry)
              }
              this.$emit('update:settings', this.settingsCopy)
              this.$emit('save-analyzers', this.settingsCopy, false)
            },
          },
        })
      },

      /**
       * confirmation dialog when deleting an analyzer
       */
      onDeleteEntry(tracker, index) {
        const linkedInterfaces = this.interfaces.filter(intf =>
          (intf.vrrptrack || []).find(track => track.name === tracker.name),
        )
        const postfix = linkedInterfaces.length
          ? ` ${this.$vuntangle.$t('following_attached_interfaces_will_be_impacted')}`
          : ''
        this.$vuntangle.confirm.show({
          title: `<i class="mdi mdi-alert" style="font-style: normal;"> ${this.$vuntangle.$t('confirm')}</i>`,
          message: this.$vuntangle.$t('confirm_delete_tracker', [tracker.displayName]) + postfix,
          messageList: linkedInterfaces.map(({ name }) => name),
          confirmLabel: this.$vuntangle.$t('yes'),
          cancelLabel: this.$vuntangle.$t('no'),
          action: async resolve => {
            await this.$emit('delete-interface-tracker', index)
            resolve()
          },
        })
      },
    },
  }
</script>
