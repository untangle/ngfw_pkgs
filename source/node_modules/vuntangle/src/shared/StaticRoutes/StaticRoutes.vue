<template>
  <v-container class="d-flex flex-column flex-grow-1" fluid>
    <div class="d-flex align-center">
      <h2 class="font-weight-light">{{ $vuntangle.$t('static_routes') }}</h2>
      <v-spacer />
      <slot name="actions" :new-settings="settingsCopy" :is-dirty="isDirty"></slot>
    </div>
    <v-divider class="my-2" />
    <p class="body-2">
      {{ $vuntangle.$t('static_routes_description') }}
    </p>
    <div v-if="!!$slots['extra-fields']">
      <slot name="extra-fields" />
    </div>

    <div class="d-flex my-2 justify-end">
      <u-btn
        v-if="!features.isTemplateView"
        text
        color="primary"
        :min-width="null"
        class="mr-2"
        :disabled="disabled"
        @click="onViewRoutingTable()"
      >
        <v-icon left>mdi-table-eye</v-icon> {{ $vuntangle.$t('routing_table') }}
      </u-btn>

      <u-btn text color="error" :min-width="null" class="mr-2" :disabled="!selection.length" @click="onDelete()">
        <v-icon left>mdi-delete</v-icon> {{ $vuntangle.$t('delete') }}
      </u-btn>

      <u-btn text color="primary" :min-width="null" class="mr-2" :disabled="!isDirty" @click="onUndo()">
        <v-icon left>mdi-undo</v-icon> {{ $vuntangle.$t('undo') }}
      </u-btn>

      <u-btn color="primary" :min-width="null" @click="onEdit()">
        <v-icon left>mdi-plus</v-icon> {{ $vuntangle.$t('add_static_route') }}
      </u-btn>
    </div>

    <u-grid
      id="static-routes"
      :no-data-message="noDataMessage"
      :column-defs="columnDefs"
      :row-data="settingsCopy"
      :framework-components="frameworkComponents"
      selection-type="multiAction"
      :selection.sync="selection"
      :enable-refresh="!features.isTemplateView"
      :custom-grid-options="{ suppressRowClickSelection: true }"
      @row-clicked="onEditRoute"
      v-on="$listeners"
    />
  </v-container>
</template>
<script>
  // import vuetify components
  import { VContainer, VSpacer, VDivider } from 'vuetify/lib'

  import isEqual from 'lodash/isEqual'
  import CheckboxRenderer from '../../components/UGrid/renderers/CheckboxRenderer.vue'
  import settingsMixin from '../settingsMixin'
  import StaticRouteEdit from './StaticRouteEdit.vue'
  import RoutingTable from './RoutingTable.vue'
  import { settingsDefaults as defaults } from './defaults'

  export default {
    components: { VContainer, VSpacer, VDivider },
    mixins: [settingsMixin],
    defaults,
    props: {
      interfaces: { type: Array, default: () => [] },
    },
    data() {
      return {
        settingsCopy: [],
        selection: [],
        frameworkComponents: {
          CheckboxRenderer,
        },
      }
    },
    computed: {
      columnDefs: ({ $i18n, interfaceName }) => [
        {
          headerName: $i18n.t('description'),
          field: 'description',
        },
        {
          headerName: $i18n.t('network'),
          field: 'network',
        },
        {
          headerName: $i18n.t('next_hop'),
          field: 'nextHop',
        },
        {
          headerName: $i18n.t('interface'),
          field: 'interfaceId',
          valueFormatter: ({ data }) => interfaceName(data.interfaceId),
        },
        {
          headerName: $i18n.t('metric'),
          field: 'metric',
        },
        {
          headerName: $i18n.t('enabled'),
          field: 'enabled',
          minWidth: 50,
          width: 80,
          flex: 0,
          sortable: true,
          cellRenderer: 'CheckboxRenderer',
        },
      ],

      /** computes grid no data message based on records number & visibility/filter */
      noDataMessage: ({ settingsCopy, $i18n }) =>
        settingsCopy.length > 0 ? $i18n.t('no_route_meets_filter') : $i18n.t('no_routes_defined'),
    },

    methods: {
      // render interface name based on route interface id
      interfaceName(id) {
        const intf = this.interfaces.find(intf => intf.interfaceId === id)
        return intf ? intf.name : ''
      },

      // deselect all and show edit dialog
      onEditRoute({ data }) {
        const realIndex = this.settingsCopy.findIndex(route => isEqual(route, data))
        this.onEdit(realIndex)
      },

      // removes one or multiple routes from the list
      onDelete() {
        this.selection.forEach(sel => {
          const index = this.settingsCopy.findIndex(route => isEqual(route, sel))
          if (index >= 0) {
            this.settingsCopy.splice(index, 1)
          }
        })
        this.selection = []
      },

      /**
       * Shows route edit dialog, it adds a new route if index undefined
       * @param index - number
       */
      onEdit(index = undefined) {
        this.$vuntangle.dialog.show({
          title: index === undefined ? this.$vuntangle.$t('add_static_route') : this.$vuntangle.$t('edit_static_route'),
          component: StaticRouteEdit,
          width: 600,
          height: 'auto',
          actionLabel: index === undefined ? this.$vuntangle.$t('add') : this.$vuntangle.$t('update'),
          componentProps: {
            index,
            interfaces: this.interfaces,
            features: this.features,
            routes: this.settings,
            // pass the entry if it exists
            ...(index === undefined ? {} : { settings: this.settingsCopy[index] }),
          },
          componentEvents: {
            update: (entry, index) => {
              // add or update the entry from the dialog
              if (index === undefined) {
                this.settingsCopy.push(entry)
              } else {
                this.settingsCopy.splice(index, 1, entry)
              }
              this.selection = []
            },
          },
        })
      },
      /**
       * Shows full routing table
       * @param index - number
       */
      onViewRoutingTable() {
        const that = this
        this.$vuntangle.dialog.show({
          title: this.$vuntangle.$t('routing_table'),
          component: RoutingTable,
          width: 1000,
          buttons: [
            {
              name: this.$t('close'),
              handler() {
                this.onClose()
              },
            },
          ],
          componentEvents: {
            async fetchRoutingTable(resolve) {
              await that.$emit('fetch-routing-table', result => resolve(result))
            },
          },
        })
      },
    },
  }
</script>
